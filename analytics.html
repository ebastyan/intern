<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAJU Analytics - Business Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #0a0a12 0%, #1a1025 50%, #0d1a2d 100%);
            min-height: 100vh;
            color: #fff;
            padding: 15px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
        }
        .header h1 {
            font-size: 1.8em;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .nav-tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 8px;
            color: #888;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-tab.active { background: linear-gradient(135deg, #ff6b6b33, #feca5733); color: #feca57; }
        .nav-tab:hover:not(.active) { background: rgba(255,255,255,0.1); color: #fff; }

        .section { display: none; }
        .section.active { display: block; }

        .grid { display: grid; gap: 15px; margin-bottom: 15px; }
        .grid-2 { grid-template-columns: 1fr; }
        .grid-3 { grid-template-columns: 1fr; }
        .grid-4 { grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 768px) { .grid-2 { grid-template-columns: 1fr 1fr; } .grid-4 { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1024px) { .grid-3 { grid-template-columns: 1fr 1fr 1fr; } }

        .card {
            background: rgba(255,255,255,0.04);
            border-radius: 14px;
            padding: 18px;
        }
        .card h2 {
            font-size: 0.9em;
            color: #feca57;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card h2 .icon { font-size: 1.2em; }

        .stat-box {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        .stat-box h3 { font-size: 0.7em; color: #888; text-transform: uppercase; margin-bottom: 8px; }
        .stat-box .value { font-size: 1.8em; font-weight: 700; }
        .stat-box .value.green { color: #1dd1a1; }
        .stat-box .value.yellow { color: #feca57; }
        .stat-box .value.red { color: #ff6b6b; }
        .stat-box .value.blue { color: #48dbfb; }
        .stat-box .sub { font-size: 0.75em; color: #666; margin-top: 4px; }

        .chart-container { position: relative; height: 280px; }
        .chart-container.tall { height: 350px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { color: #feca57; font-weight: 600; font-size: 0.75em; text-transform: uppercase; }
        .text-right { text-align: right; }
        .scroll-table { max-height: 350px; overflow-y: auto; }
        .scroll-table::-webkit-scrollbar { width: 5px; }
        .scroll-table::-webkit-scrollbar-thumb { background: rgba(254,202,87,0.3); border-radius: 3px; }

        .alert-card {
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .alert-card.warning { background: rgba(254,202,87,0.1); border-left: 3px solid #feca57; }
        .alert-card.danger { background: rgba(255,107,107,0.1); border-left: 3px solid #ff6b6b; }
        .alert-card.success { background: rgba(29,209,161,0.1); border-left: 3px solid #1dd1a1; }
        .alert-card .icon { font-size: 1.5em; }
        .alert-card .content { flex: 1; }
        .alert-card .title { font-weight: 600; margin-bottom: 3px; }
        .alert-card .desc { font-size: 0.85em; color: #888; }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-bar .fill { height: 100%; border-radius: 4px; }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 600;
        }
        .badge.vip { background: #feca57; color: #000; }
        .badge.returning { background: #1dd1a1; color: #000; }
        .badge.inactive { background: #ff6b6b; color: #fff; }

        .county-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .county-bar .name { width: 100px; font-size: 0.85em; }
        .county-bar .bar-bg {
            flex: 1;
            height: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            overflow: hidden;
            margin: 0 10px;
        }
        .county-bar .bar {
            height: 100%;
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding-left: 10px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .county-bar .value { width: 80px; text-align: right; font-size: 0.8em; color: #888; }

        .trend-indicator { display: inline-flex; align-items: center; gap: 4px; }
        .trend-indicator.up { color: #1dd1a1; }
        .trend-indicator.down { color: #ff6b6b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>PAJU Business Intelligence</h1>
        <p style="color:#888;font-size:0.9em;margin-top:8px;">Analiza parteneri, tendinte, previziuni</p>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showSection('overview')">Prezentare</button>
        <button class="nav-tab" onclick="showSection('partners')">Parteneri</button>
        <button class="nav-tab" onclick="showSection('geo')">Geografie</button>
        <button class="nav-tab" onclick="showSection('trends')">Tendinte</button>
        <button class="nav-tab" onclick="showSection('alerts')">Alerte</button>
        <button class="nav-tab" onclick="showSection('predictions')">Previziuni</button>
    </div>

    <!-- OVERVIEW SECTION -->
    <div id="section-overview" class="section active">
        <div class="grid grid-4">
            <div class="stat-box">
                <h3>Total Parteneri</h3>
                <div class="value blue" id="totalPartners">13,321</div>
            </div>
            <div class="stat-box">
                <h3>Recurenti</h3>
                <div class="value green" id="returningPartners">6,536</div>
                <div class="sub">49.1%</div>
            </div>
            <div class="stat-box">
                <h3>VIP (10+)</h3>
                <div class="value yellow" id="vipPartners">942</div>
            </div>
            <div class="stat-box">
                <h3>Inactivi (90+ zile)</h3>
                <div class="value red" id="inactivePartners">10,178</div>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="card">
                <h2><span class="icon">üë•</span> Distributie Parteneri</h2>
                <div class="chart-container">
                    <canvas id="partnerPieChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2><span class="icon">üìä</span> Analiza pe Grupe de Varsta</h2>
                <div class="chart-container">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üèÜ</span> Top 10 Parteneri (dupa valoare)</h2>
            <div class="scroll-table">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nume</th>
                            <th class="text-right">Valoare Tot.</th>
                            <th class="text-right">Vizite</th>
                            <th class="text-right">Medie/Viz.</th>
                            <th>Tip</th>
                        </tr>
                    </thead>
                    <tbody id="topPartnersTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PARTNERS SECTION -->
    <div id="section-partners" class="section">
        <div class="grid grid-3">
            <div class="card">
                <h2><span class="icon">üò¥</span> Parteneri Inactivi (30-60 zile)</h2>
                <div class="scroll-table">
                    <table>
                        <thead><tr><th>Nume</th><th>Ultima viz.</th><th class="text-right">Valoare</th></tr></thead>
                        <tbody id="inactive30Table"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h2><span class="icon">üò¥</span> Parteneri Inactivi (60-90 zile)</h2>
                <div class="scroll-table">
                    <table>
                        <thead><tr><th>Nume</th><th>Ultima viz.</th><th class="text-right">Valoare</th></tr></thead>
                        <tbody id="inactive60Table"></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h2><span class="icon">üíÄ</span> Parteneri Pierduti (90+ zile)</h2>
                <div class="scroll-table">
                    <table>
                        <thead><tr><th>Nume</th><th>Ultima viz.</th><th class="text-right">Valoare</th></tr></thead>
                        <tbody id="inactive90Table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">‚≠ê</span> Parteneri VIP (10+ vizite)</h2>
            <p style="color:#888;font-size:0.85em;margin-bottom:15px;">Acestia sunt cei mai importanti clienti - trebuie sa ii pastram multumiti!</p>
            <div class="scroll-table">
                <table>
                    <thead>
                        <tr><th>Nume</th><th>Judet</th><th class="text-right">Vizite</th><th class="text-right">Valoare Tot.</th><th>Material Principal</th></tr>
                    </thead>
                    <tbody id="vipTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- GEOGRAPHY SECTION -->
    <div id="section-geo" class="section">
        <div class="grid grid-2">
            <div class="card">
                <h2><span class="icon">üó∫Ô∏è</span> Distributie pe Judete</h2>
                <div id="countyBars"></div>
            </div>
            <div class="card">
                <h2><span class="icon">üìç</span> Statistici pe Judete</h2>
                <div class="chart-container">
                    <canvas id="countyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üéØ</span> Analiza Distanta</h2>
            <div class="alert-card success">
                <div class="icon">‚úÖ</div>
                <div class="content">
                    <div class="title">Dominanta judetul Bihor</div>
                    <div class="desc">80.6% din parteneri sunt din Bihor - afacere locala, foarte bine!</div>
                </div>
            </div>
            <div class="alert-card warning">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="content">
                    <div class="title">Surpriza Teleorman</div>
                    <div class="desc">62 parteneri din Teleorman cu 10.6M RON - de investigat, sunt angrosisti?</div>
                </div>
            </div>
        </div>
    </div>

    <!-- TRENDS SECTION -->
    <div id="section-trends" class="section">
        <div class="card">
            <h2><span class="icon">üìà</span> Evolutia Lunara pe Categorii de Materiale</h2>
            <div class="chart-container tall">
                <canvas id="categoryTrendChart"></canvas>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="card">
                <h2><span class="icon">üìÖ</span> Tendinte in Cursul Lunii</h2>
                <div class="chart-container">
                    <canvas id="dayOfMonthChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2><span class="icon">üîÑ</span> Sezonalitate</h2>
                <div id="seasonalInsights">
                    <div class="alert-card success">
                        <div class="icon">üìà</div>
                        <div class="content">
                            <div class="title">Aprilie - cea mai buna luna</div>
                            <div class="desc">In 2024: 7.64M RON - curatenia de primavara?</div>
                        </div>
                    </div>
                    <div class="alert-card warning">
                        <div class="icon">üìâ</div>
                        <div class="content">
                            <div class="title">August slab</div>
                            <div class="desc">Din cauza concediilor, cu 50% mai putina activitate</div>
                        </div>
                    </div>
                    <div class="alert-card danger">
                        <div class="icon">‚¨áÔ∏è</div>
                        <div class="content">
                            <div class="title">Scadere 2025</div>
                            <div class="desc">Aug-Nov 2025: scadere semnificativa fata de 2024</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ALERTS SECTION -->
    <div id="section-alerts" class="section">
        <div class="card">
            <h2><span class="icon">üö®</span> Alerte Active</h2>

            <div class="alert-card danger">
                <div class="icon">üî¥</div>
                <div class="content">
                    <div class="title">10,178 parteneri disparuti de 90+ zile!</div>
                    <div class="desc">Pierdere potentiala: ~50M RON/an. Gandeste-te la actiuni de recuperare (SMS, telefon).</div>
                </div>
            </div>

            <div class="alert-card danger">
                <div class="icon">üìâ</div>
                <div class="content">
                    <div class="title">Q4 2025 cu 40% mai mic</div>
                    <div class="desc">Sept-Nov 2025: 9.1M RON vs 2024: 19.0M RON in aceeasi perioada.</div>
                </div>
            </div>

            <div class="alert-card warning">
                <div class="icon">‚ö†Ô∏è</div>
                <div class="content">
                    <div class="title">950 parteneri "adormiti" - inca recuperabili!</div>
                    <div class="desc">Nu au venit de 30-60 zile. Acesta e cel mai bun moment pentru reactivare!</div>
                </div>
            </div>

            <div class="alert-card warning">
                <div class="icon">üëÄ</div>
                <div class="content">
                    <div class="title">Judetul Teleorman - model neobisnuit</div>
                    <div class="desc">62 parteneri, 10.6M RON, 170K RON/persoana media - business normal sau de investigat?</div>
                </div>
            </div>

            <div class="alert-card success">
                <div class="icon">‚úÖ</div>
                <div class="content">
                    <div class="title">Retentie VIP buna</div>
                    <div class="desc">942 parteneri VIP activi - sa ii pastram!</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üìä</span> Urmarire Obiectiv Zilnic</h2>
            <div class="stat-box" style="background:transparent;text-align:left;">
                <h3>Cifra medie zilnica (2024)</h3>
                <div class="value yellow" style="font-size:1.5em;">253K RON</div>
                <div class="progress-bar">
                    <div class="fill" style="width:75%;background:linear-gradient(90deg,#feca57,#1dd1a1);"></div>
                </div>
                <div class="sub" style="margin-top:10px;">Pentru atingerea obiectivului sunt necesare ~95 tranzactii pe zi</div>
            </div>
        </div>
    </div>

    <!-- PREDICTIONS SECTION -->
    <div id="section-predictions" class="section">
        <div class="card">
            <h2><span class="icon">üìä</span> Analiza Tendinta Lunara si Previziuni</h2>
            <div class="chart-container tall">
                <canvas id="predictionChart"></canvas>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="card">
                <h2><span class="icon">üîÆ</span> Previziune Decembrie 2025</h2>
                <div class="grid grid-3" style="margin-top:15px;">
                    <div class="stat-box">
                        <h3>Cifra Estimata</h3>
                        <div class="value yellow" id="predDec">~2.5M</div>
                        <div class="sub">RON (bazat pe trend)</div>
                    </div>
                    <div class="stat-box">
                        <h3>Tranzactii</h3>
                        <div class="value blue" id="predTrans">~1,600</div>
                        <div class="sub">estimate</div>
                    </div>
                    <div class="stat-box">
                        <h3>Variatie YoY</h3>
                        <div class="value red" id="predYoY">-35%</div>
                        <div class="sub">vs Dec 2024</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üìà</span> Perspectiva Q1 2026</h2>
                <div class="grid grid-3" style="margin-top:15px;">
                    <div class="stat-box">
                        <h3>Estimare Ian</h3>
                        <div class="value yellow" id="predJan">~3.5M</div>
                        <div class="sub">RON</div>
                    </div>
                    <div class="stat-box">
                        <h3>Estimare Feb</h3>
                        <div class="value yellow" id="predFeb">~3.8M</div>
                        <div class="sub">RON</div>
                    </div>
                    <div class="stat-box">
                        <h3>Total Q1</h3>
                        <div class="value blue" id="predQ1">~11M</div>
                        <div class="sub">RON</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üéØ</span> Sumar Tendinta</h2>
            <div id="trendSummary">
                <div class="alert-card danger">
                    <div class="icon">üìâ</div>
                    <div class="content">
                        <div class="title" id="trendTitle">Tendinta 2025 negativa</div>
                        <div class="desc" id="trendDesc">Scadere medie lunara: se calculeaza...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><span class="icon">üí°</span> Recomandari</h2>
            <ol style="color:#ccc;line-height:2;padding-left:20px;">
                <li><strong style="color:#feca57;">Imediat:</strong> Suna cei <span id="recInactive30">950</span> parteneri "adormiti" de 30-60 zile - inca pot fi recuperati!</li>
                <li><strong style="color:#feca57;">Termen scurt:</strong> Program VIP pentru top 100 parteneri - reduceri extra, prioritate</li>
                <li><strong style="color:#feca57;">Termen mediu:</strong> Investigheaza partenerii din judete indepartate cu valori mari (Teleorman, Salaj)</li>
                <li><strong style="color:#feca57;">Termen lung:</strong> Cresterea segmentului tanar (18-24) - ei sunt viitorul!</li>
                <li><strong style="color:#1dd1a1;">Potential:</strong> Daca reactivam 10% din cei <span id="recInactive90">10,178</span> parteneri inactivi, inseamna +<span id="recPotential">5M</span> RON/an!</li>
            </ol>
        </div>
    </div>

    <script>
        let analyticsData = null;

        // Load data
        fetch('analytics.json')
            .then(r => r.json())
            .then(data => {
                analyticsData = data;
                initDashboard();
            })
            .catch(e => console.error('Error:', e));

        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

        function formatNumber(n) {
            if (n >= 1000000) return (n/1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n/1000).toFixed(0) + 'K';
            return n.toLocaleString();
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');
            event.target.classList.add('active');
        }

        function initDashboard() {
            const data = analyticsData;
            if (!data) return;

            // Update stats
            document.getElementById('totalPartners').textContent = data.summary.unique_partners.toLocaleString();
            document.getElementById('returningPartners').textContent = data.summary.returning_partners.toLocaleString();
            document.getElementById('vipPartners').textContent = data.summary.vip_partners.toLocaleString();
            document.getElementById('inactivePartners').textContent = data.summary.inactive_90_plus.toLocaleString();

            // Partner Pie Chart
            new Chart(document.getElementById('partnerPieChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Recurenti (2-9x)', 'VIP (10+)', 'O singura data'],
                    datasets: [{
                        data: [
                            data.summary.returning_partners - data.summary.vip_partners,
                            data.summary.vip_partners,
                            data.summary.one_time_partners
                        ],
                        backgroundColor: ['#48dbfb', '#feca57', '#ff6b6b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff' } } }
                }
            });

            // Age Chart
            const ageLabels = ['18-24', '25-34', '35-44', '45-54', '55-64', '65+'];
            const ageValues = ageLabels.map(l => data.age_groups[l] ? data.age_groups[l].value / 1000000 : 0);
            new Chart(document.getElementById('ageChart'), {
                type: 'bar',
                data: {
                    labels: ageLabels,
                    datasets: [{
                        label: 'Valoare (M RON)',
                        data: ageValues,
                        backgroundColor: ['#ff6b6b', '#feca57', '#1dd1a1', '#48dbfb', '#a55eea', '#778ca3'],
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { callback: v => v + 'M' } } }
                }
            });

            // Top Partners Table
            const topTable = document.getElementById('topPartnersTable');
            data.top_100_partners.slice(0, 10).forEach((p, i) => {
                const badge = p.total_visits >= 10 ? '<span class="badge vip">VIP</span>' :
                             p.total_visits > 1 ? '<span class="badge returning">Recurent</span>' : '';
                topTable.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>${p.name}</td>
                        <td class="text-right">${formatNumber(p.total_value)}</td>
                        <td class="text-right">${p.total_visits}</td>
                        <td class="text-right">${formatNumber(p.avg_value)}</td>
                        <td>${badge}</td>
                    </tr>
                `;
            });

            // Inactive tables
            ['30_60', '60_90', '90_plus'].forEach(key => {
                const tableId = key === '30_60' ? 'inactive30Table' : key === '60_90' ? 'inactive60Table' : 'inactive90Table';
                const table = document.getElementById(tableId);
                const partners = data.inactive_partners[key + '_days'] || [];
                partners.slice(0, 15).forEach(p => {
                    table.innerHTML += `
                        <tr>
                            <td>${p.name}</td>
                            <td>${p.last_visit}</td>
                            <td class="text-right">${formatNumber(p.total_value)}</td>
                        </tr>
                    `;
                });
            });

            // VIP Table
            const vipTable = document.getElementById('vipTable');
            data.top_100_partners.filter(p => p.total_visits >= 10).slice(0, 20).forEach(p => {
                const county = p.cnp_info ? p.cnp_info.county_name : '-';
                const topCat = Object.keys(p.categories)[0] || '-';
                vipTable.innerHTML += `
                    <tr>
                        <td>${p.name}</td>
                        <td>${county}</td>
                        <td class="text-right">${p.total_visits}</td>
                        <td class="text-right">${formatNumber(p.total_value)}</td>
                        <td>${topCat}</td>
                    </tr>
                `;
            });

            // County bars
            const countyContainer = document.getElementById('countyBars');
            const counties = Object.entries(data.county_stats).slice(0, 10);
            const maxCountyValue = counties[0] ? counties[0][1].value : 1;
            counties.forEach(([name, stats]) => {
                const pct = (stats.value / maxCountyValue * 100).toFixed(0);
                countyContainer.innerHTML += `
                    <div class="county-bar">
                        <span class="name">${name}</span>
                        <div class="bar-bg">
                            <div class="bar" style="width:${pct}%;background:linear-gradient(90deg,#feca57,#ff6b6b);">
                                ${stats.count} parteneri
                            </div>
                        </div>
                        <span class="value">${formatNumber(stats.value)}</span>
                    </div>
                `;
            });

            // County Chart
            new Chart(document.getElementById('countyChart'), {
                type: 'pie',
                data: {
                    labels: counties.slice(0, 6).map(c => c[0]),
                    datasets: [{
                        data: counties.slice(0, 6).map(c => c[1].value),
                        backgroundColor: ['#ff6b6b', '#feca57', '#1dd1a1', '#48dbfb', '#a55eea', '#778ca3'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 11 } } } }
                }
            });

            // Category Trend Chart
            const months = Object.keys(data.monthly_category_trends).sort();
            const mainCats = ['Vas', 'Aluminiu', 'Rez', 'Akkumulator', 'DEEE'];
            const catColors = { Vas: '#ff6b6b', Aluminiu: '#48dbfb', Rez: '#feca57', Akkumulator: '#1dd1a1', DEEE: '#a55eea' };

            new Chart(document.getElementById('categoryTrendChart'), {
                type: 'line',
                data: {
                    labels: months.map(m => m.substring(2)),
                    datasets: mainCats.map(cat => ({
                        label: cat === 'Vas' ? 'Fier' : cat === 'Rez' ? 'Cupru' : cat === 'Akkumulator' ? 'Acumulatori' : cat,
                        data: months.map(m => (data.monthly_category_trends[m][cat] || 0) / 1000),
                        borderColor: catColors[cat],
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        pointRadius: 2
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: { y: { ticks: { callback: v => v + 'T kg' } } }
                }
            });

            // Day of month chart
            const dailyValues = {};
            Object.entries(data.daily_stats).forEach(([date, stats]) => {
                const day = parseInt(date.split('-')[2]);
                if (!dailyValues[day]) dailyValues[day] = [];
                dailyValues[day].push(stats.value);
            });
            const avgByDay = [];
            for (let d = 1; d <= 31; d++) {
                avgByDay.push(dailyValues[d] ? dailyValues[d].reduce((a,b) => a+b, 0) / dailyValues[d].length / 1000 : 0);
            }

            new Chart(document.getElementById('dayOfMonthChart'), {
                type: 'bar',
                data: {
                    labels: Array.from({length: 31}, (_, i) => i + 1),
                    datasets: [{
                        label: 'Cifra medie (K RON)',
                        data: avgByDay,
                        backgroundColor: avgByDay.map(v => v > 250 ? '#1dd1a1' : v > 200 ? '#feca57' : '#ff6b6b'),
                        borderRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // PREDICTION CHART AND CALCULATIONS
            buildPredictions(data);
        }

        function buildPredictions(data) {
            // Calculate monthly values from daily_stats
            const monthlyTotals = {};
            Object.entries(data.daily_stats).forEach(([date, stats]) => {
                const monthKey = date.substring(0, 7);
                if (!monthlyTotals[monthKey]) monthlyTotals[monthKey] = 0;
                monthlyTotals[monthKey] += stats.value;
            });

            // Separate 2024 and 2025 data
            const months2024 = [], values2024 = [];
            const months2025 = [], values2025 = [];

            Object.keys(monthlyTotals).sort().forEach(m => {
                if (m.startsWith('2024')) {
                    months2024.push(m);
                    values2024.push(monthlyTotals[m] / 1000000);
                } else if (m.startsWith('2025')) {
                    months2025.push(m);
                    values2025.push(monthlyTotals[m] / 1000000);
                }
            });

            // Calculate predictions based on 2025 trend
            const last3Months = values2025.slice(-3);
            const avgLast3 = last3Months.reduce((a,b) => a+b, 0) / last3Months.length;

            // Simple linear trend from 2025 data
            let slope = 0;
            if (values2025.length >= 3) {
                const n = values2025.length;
                const xMean = (n - 1) / 2;
                const yMean = values2025.reduce((a,b) => a+b, 0) / n;
                let num = 0, den = 0;
                values2025.forEach((y, i) => {
                    num += (i - xMean) * (y - yMean);
                    den += (i - xMean) ** 2;
                });
                slope = den !== 0 ? num / den : 0;
            }

            // Predict Dec 2025, Jan-Mar 2026
            const predDec = Math.max(0.5, avgLast3 + slope);
            const predJan = Math.max(0.5, predDec * 1.2); // January usually higher
            const predFeb = Math.max(0.5, predJan * 0.95);
            const predMar = Math.max(0.5, predFeb * 1.1);
            const predQ1 = predJan + predFeb + predMar;

            // Get Dec 2024 for YoY comparison
            const dec2024 = monthlyTotals['2024-12'] ? monthlyTotals['2024-12'] / 1000000 : 4.5;
            const yoyChange = ((predDec - dec2024) / dec2024 * 100).toFixed(0);

            // Estimate transactions based on avg value per transaction
            const avgValuePerTrans = 2400; // RON
            const predTransCount = Math.round(predDec * 1000000 / avgValuePerTrans);

            // Update UI
            document.getElementById('predDec').textContent = '~' + predDec.toFixed(1) + 'M';
            document.getElementById('predTrans').textContent = '~' + predTransCount.toLocaleString();
            document.getElementById('predYoY').textContent = yoyChange + '%';
            document.getElementById('predYoY').className = 'value ' + (parseFloat(yoyChange) < 0 ? 'red' : 'green');

            document.getElementById('predJan').textContent = '~' + predJan.toFixed(1) + 'M';
            document.getElementById('predFeb').textContent = '~' + predFeb.toFixed(1) + 'M';
            document.getElementById('predQ1').textContent = '~' + predQ1.toFixed(0) + 'M';

            // Trend summary
            const monthlyChange = (slope * 100 / avgLast3).toFixed(1);
            document.getElementById('trendTitle').textContent = slope < 0 ? 'Tendinta 2025 negativa' : 'Tendinta 2025 pozitiva';
            document.getElementById('trendDesc').textContent =
                `${slope < 0 ? 'Scadere' : 'Crestere'} medie lunara: ${Math.abs(monthlyChange)}% pe luna. ` +
                `Media ultimelor 3 luni: ${avgLast3.toFixed(1)}M RON.`;

            // Recommendation numbers
            document.getElementById('recInactive30').textContent = data.summary.inactive_30_60.toLocaleString();
            document.getElementById('recInactive90').textContent = data.summary.inactive_90_plus.toLocaleString();

            // Calculate potential from inactive partners
            const avgPartnerValue = data.top_100_partners.reduce((a,p) => a + p.total_value, 0) / 100;
            const potential = (data.summary.inactive_90_plus * 0.1 * avgPartnerValue / 1000000).toFixed(0);
            document.getElementById('recPotential').textContent = potential + 'M';

            // Build prediction chart
            const allLabels = [...months2024, ...months2025, '2025-12', '2026-01', '2026-02', '2026-03'];
            const shortLabels = allLabels.map(m => m.substring(2));

            const actual2024Data = new Array(months2024.length).fill(null).map((_, i) => values2024[i]);
            const actual2025Data = new Array(months2024.length).fill(null).concat(values2025);
            const predictionData = new Array(months2024.length + months2025.length).fill(null);
            predictionData.push(predDec, predJan, predFeb, predMar);

            // Pad arrays to same length
            while (actual2024Data.length < allLabels.length) actual2024Data.push(null);
            while (actual2025Data.length < allLabels.length) actual2025Data.push(null);

            new Chart(document.getElementById('predictionChart'), {
                type: 'line',
                data: {
                    labels: shortLabels,
                    datasets: [
                        {
                            label: '2024 Realizat',
                            data: actual2024Data,
                            borderColor: '#48dbfb',
                            backgroundColor: 'rgba(72, 219, 251, 0.1)',
                            tension: 0.3,
                            pointRadius: 4,
                            fill: true
                        },
                        {
                            label: '2025 Realizat',
                            data: actual2025Data,
                            borderColor: '#feca57',
                            backgroundColor: 'rgba(254, 202, 87, 0.1)',
                            tension: 0.3,
                            pointRadius: 4,
                            fill: true
                        },
                        {
                            label: 'Previziune',
                            data: predictionData,
                            borderColor: '#ff6b6b',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            pointRadius: 6,
                            pointStyle: 'triangle'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': ' + (ctx.raw ? ctx.raw.toFixed(2) + 'M RON' : '-')
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => v + 'M' }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
