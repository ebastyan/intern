<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAJU - Firme Dashboard (B2B)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #0a0a12 0%, #141428 50%, #1a1a35 100%); min-height: 100vh; color: #fff; }
        .login-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #0a0a12 0%, #141428 50%, #1a1a35 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-screen.hidden { display: none; }
        .login-box { background: rgba(255,255,255,0.04); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .login-box h1 { font-size: 2em; background: linear-gradient(45deg, #ff9f40, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .login-box p { color: #666; margin-bottom: 30px; }
        .login-box input { width: 100%; padding: 14px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; font-size: 1em; text-align: center; margin-bottom: 15px; }
        .login-box input:focus { outline: none; border-color: #ff9f40; }
        .login-box button { width: 100%; padding: 14px; background: linear-gradient(135deg, #ff9f40, #ff6b6b); border: none; border-radius: 10px; color: #fff; font-weight: 700; font-size: 1em; cursor: pointer; }
        .login-box .error { color: #ff6b6b; margin-top: 10px; display: none; }
        .top-nav { background: rgba(0,0,0,0.3); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .logo { font-size: 1.4em; font-weight: 700; background: linear-gradient(45deg, #ff9f40, #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo span { font-size: 0.6em; color: #888; display: block; background: none; -webkit-text-fill-color: #888; }
        .nav-tabs { display: flex; gap: 5px; flex-wrap: wrap; }
        .nav-tab { padding: 8px 16px; background: transparent; border: none; border-radius: 6px; color: #666; font-size: 0.85em; cursor: pointer; transition: all 0.2s; }
        .nav-tab.active { background: rgba(255,159,64,0.15); color: #ff9f40; }
        .nav-tab:hover:not(.active) { color: #fff; background: rgba(255,255,255,0.05); }
        .switch-btn { padding: 8px 16px; background: linear-gradient(135deg, #00d9ff, #00ff88); border: none; border-radius: 6px; color: #000; font-size: 0.8em; cursor: pointer; font-weight: 600; text-decoration: none; }
        .last-update { font-size: 0.75em; color: #666; }
        .main-content { padding: 20px; display: none; }
        .main-content.visible { display: block; }
        .section { display: none; }
        .section.active { display: block; }
        .big-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        @media (min-width: 768px) { .big-stats { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1200px) { .big-stats { grid-template-columns: repeat(6, 1fr); } }
        .stat-card { background: rgba(255,255,255,0.04); border-radius: 12px; padding: 16px; text-align: center; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.orange::before { background: linear-gradient(90deg, #ff9f40, #f59e0b); }
        .stat-card.green::before { background: linear-gradient(90deg, #00ff88, #00cc6a); }
        .stat-card.purple::before { background: linear-gradient(90deg, #9966ff, #7c3aed); }
        .stat-card.cyan::before { background: linear-gradient(90deg, #00d9ff, #00b4d8); }
        .stat-card.red::before { background: linear-gradient(90deg, #ff6b6b, #ef4444); }
        .stat-card.yellow::before { background: linear-gradient(90deg, #feca57, #eab308); }
        .stat-card h4 { font-size: 0.7em; color: #888; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 1.6em; font-weight: 700; }
        .stat-card .value.orange { color: #ff9f40; }
        .stat-card .value.green { color: #00ff88; }
        .stat-card .value.purple { color: #9966ff; }
        .stat-card .value.cyan { color: #00d9ff; }
        .stat-card .value.red { color: #ff6b6b; }
        .stat-card .value.yellow { color: #feca57; }
        .stat-card .sub { font-size: 0.75em; color: #666; margin-top: 4px; }
        .grid { display: grid; gap: 15px; margin-bottom: 15px; }
        .grid-2 { grid-template-columns: 1fr; }
        .grid-3 { grid-template-columns: 1fr; }
        @media (min-width: 900px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 1100px) { .grid-3 { grid-template-columns: 1fr 1fr 1fr; } }
        .card { background: rgba(255,255,255,0.04); border-radius: 14px; padding: 18px; }
        .card h2 { font-size: 0.9em; color: #ff9f40; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; gap: 8px; }
        .card h2 .icon { font-size: 1.1em; }
        .chart-container { position: relative; height: 280px; }
        .chart-container.tall { height: 350px; }
        .chart-container.short { height: 200px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { color: #ff9f40; font-weight: 600; font-size: 0.75em; text-transform: uppercase; position: sticky; top: 0; background: #1a1a2e; z-index: 10; }
        tr:hover { background: rgba(255,255,255,0.02); }
        tr.clickable { cursor: pointer; }
        tr.total-row { background: rgba(255,159,64,0.1); font-weight: bold; }
        tr.total-row td { border-top: 2px solid #ff9f40; }
        .text-right { text-align: right; }
        .scroll-table { max-height: 320px; overflow-y: auto; }
        .scroll-table::-webkit-scrollbar { width: 5px; }
        .scroll-table::-webkit-scrollbar-thumb { background: rgba(255,159,64,0.3); border-radius: 3px; }
        .scroll-table thead th { position: sticky; top: 0; background: #1a1a2e; z-index: 10; }
        .category-bar { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.8em; }
        .category-bar .name { width: 120px; color: #ccc; }
        .category-bar .bar-bg { flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; margin: 0 10px; }
        .category-bar .bar { height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 0.85em; font-weight: 600; }
        .category-bar .value { width: 100px; text-align: right; color: #888; }
        .search-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px 16px; display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .search-box input, .search-box select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 8px 12px; color: #fff; font-size: 0.9em; }
        .search-box input { min-width: 150px; }
        .search-box input::placeholder { color: #666; }
        .search-box button { background: linear-gradient(135deg, #ff9f40, #ff6b6b); border: none; border-radius: 6px; padding: 8px 20px; color: #fff; font-weight: 600; cursor: pointer; }
        .search-box button.secondary { background: rgba(255,255,255,0.1); }
        .search-box label { color: #888; font-size: 0.85em; }
        .filter-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .filter-row label { color: #888; font-size: 0.8em; }
        .filter-row input, .filter-row select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 6px 10px; color: #fff; font-size: 0.85em; }
        .year-selector { display: flex; gap: 5px; margin-left: auto; }
        .year-btn { padding: 4px 12px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: #888; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .year-btn.active { background: #ff9f40; color: #000; border-color: #ff9f40; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; }
        .badge.green { background: rgba(0,255,136,0.2); color: #00ff88; }
        .badge.red { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .badge.yellow { background: rgba(254,202,87,0.2); color: #feca57; }
        .badge.orange { background: rgba(255,159,64,0.2); color: #ff9f40; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; border-radius: 16px; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 24px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .modal-header h3 { font-size: 1.3em; color: #ff9f40; }
        .modal-close { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #ff9f40; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .footer { text-align: center; padding: 30px 20px; color: #444; font-size: 0.8em; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 30px; }
        .footer a { color: #ff9f40; text-decoration: none; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .tab-btn { padding: 6px 14px; background: transparent; border: none; color: #666; cursor: pointer; border-radius: 4px; font-size: 0.85em; }
        .tab-btn.active { background: rgba(255,159,64,0.15); color: #ff9f40; }
        .profit-positive { color: #00ff88; }
        .profit-negative { color: #ff6b6b; }
        .insight-box { background: linear-gradient(135deg, rgba(255,159,64,0.08), rgba(255,107,107,0.05)); border-left: 3px solid #ff9f40; border-radius: 0 10px 10px 0; padding: 14px; margin-bottom: 10px; font-size: 0.85em; }
        .insight-box strong { color: #ff9f40; }
        .totals-bar { background: rgba(255,159,64,0.1); border: 1px solid rgba(255,159,64,0.3); border-radius: 8px; padding: 12px 16px; margin-top: 10px; display: flex; gap: 20px; flex-wrap: wrap; }
        .totals-bar .total-item { display: flex; flex-direction: column; }
        .totals-bar .total-label { font-size: 0.7em; color: #888; text-transform: uppercase; }
        .totals-bar .total-value { font-size: 1.1em; font-weight: bold; color: #ff9f40; }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>PAJU Firme</h1>
            <p>Dashboard B2B - Vanzari catre Firme</p>
            <input type="password" id="passwordInput" placeholder="Parola..." onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Conectare</button>
            <div class="error" id="loginError">Parola gresita!</div>
        </div>
    </div>

    <nav class="top-nav">
        <div class="logo">PAJU Firme <span>Dashboard B2B</span></div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('overview')">Sumar</button>
            <button class="nav-tab" onclick="showSection('firme')">Firme</button>
            <button class="nav-tab" onclick="showSection('monthly')">Lunar</button>
            <button class="nav-tab" onclick="showSection('deseuri')">Deseuri</button>
            <button class="nav-tab" onclick="showSection('compare')">Comparatie</button>
            <button class="nav-tab" onclick="showSection('transport')">Transport</button>
            <button class="nav-tab" onclick="showSection('stats')">Statistici</button>
        </div>
        <a href="index.html" class="switch-btn">Persoane Fizice</a>
    </nav>

    <div class="main-content" id="mainContent">
        <!-- OVERVIEW -->
        <div id="section-overview" class="section active">
            <div class="search-box">
                <label>An:</label>
                <select id="overviewYear" onchange="loadOverviewData()">
                    <option value="">Toti anii</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                </select>
            </div>
            <div class="big-stats" id="bigStats">
                <div class="stat-card orange"><h4>Rulaj Total</h4><div class="value orange" id="totalValue">...</div><div class="sub">RON</div></div>
                <div class="stat-card green"><h4>Profit Total</h4><div class="value green" id="totalProfit">...</div><div class="sub">RON</div></div>
                <div class="stat-card purple"><h4>Marja Profit</h4><div class="value purple" id="profitMargin">...</div><div class="sub">%</div></div>
                <div class="stat-card cyan"><h4>Nr. Vanzari</h4><div class="value cyan" id="totalVanzari">...</div></div>
                <div class="stat-card yellow"><h4>Firme Active</h4><div class="value yellow" id="totalFirme">...</div></div>
                <div class="stat-card red"><h4>Total kg</h4><div class="value red" id="totalKg">...</div></div>
            </div>
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üìä</span> Evolutie Anuala</h2><div class="chart-container"><canvas id="yearlyChart"></canvas></div></div>
                <div class="card"><h2><span class="icon">üìà</span> Rulaj vs Profit pe An</h2><div class="chart-container"><canvas id="valueProfitChart"></canvas></div></div>
            </div>
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üèÜ</span> Top 10 Firme dupa Valoare</h2><div class="scroll-table"><table><thead><tr><th>#</th><th>Firma</th><th class="text-right">Valoare</th><th class="text-right">Profit</th><th class="text-right">Marja</th></tr></thead><tbody id="topFirmeTable"></tbody></table></div></div>
                <div class="card"><h2><span class="icon">üì¶</span> Top Deseuri dupa Valoare</h2><div id="deseuriBars"></div></div>
            </div>
        </div>

        <!-- FIRME LIST -->
        <div id="section-firme" class="section">
            <div class="search-box">
                <input type="text" id="firmaSearch" placeholder="Cauta firma..." onkeypress="if(event.key==='Enter')searchFirme()">
                <label>An:</label>
                <select id="firmaYear" onchange="searchFirme()">
                    <option value="">Toti anii</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                </select>
                <label>Min valoare:</label>
                <input type="number" id="firmaMinValue" value="0" style="width:100px;">
                <label>Sortare:</label>
                <select id="firmaSort" onchange="searchFirme()">
                    <option value="value_desc">Valoare (desc)</option>
                    <option value="value_asc">Valoare (asc)</option>
                    <option value="profit_desc">Profit (desc)</option>
                    <option value="name_asc">Nume (A-Z)</option>
                    <option value="visits_desc">Vanzari (desc)</option>
                </select>
                <button onclick="searchFirme()">Cauta</button>
                <button class="secondary" onclick="resetFirmaFilters()">Reset</button>
            </div>
            <div class="card">
                <h2><span class="icon">üè¢</span> Lista Firme (<span id="firmeCount">0</span>)</h2>
                <div class="scroll-table" style="max-height:600px;">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Firma</th>
                                <th class="text-right">Nr. Vanzari</th>
                                <th class="text-right">Total kg</th>
                                <th class="text-right">Valoare</th>
                                <th class="text-right">Profit</th>
                                <th class="text-right">Marja</th>
                                <th>Ultima Vanzare</th>
                            </tr>
                        </thead>
                        <tbody id="firmeTable"></tbody>
                    </table>
                </div>
                <div class="totals-bar" id="firmeTotals"></div>
            </div>
        </div>

        <!-- MONTHLY -->
        <div id="section-monthly" class="section">
            <div class="search-box">
                <label>An:</label>
                <select id="monthlyYear" onchange="loadMonthlyData()">
                    <option value="">Toti anii</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                </select>
            </div>
            <div class="card">
                <h2><span class="icon">üìÖ</span> Evolutie Lunara</h2>
                <div class="chart-container tall"><canvas id="monthlyChart"></canvas></div>
            </div>
            <div class="card">
                <h2><span class="icon">üìã</span> Detalii Lunare</h2>
                <div class="scroll-table">
                    <table>
                        <thead>
                            <tr>
                                <th>An</th>
                                <th>Luna</th>
                                <th class="text-right">Vanzari</th>
                                <th class="text-right">Firme</th>
                                <th class="text-right">Total kg</th>
                                <th class="text-right">Valoare</th>
                                <th class="text-right">Profit</th>
                                <th class="text-right">Marja</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTable"></tbody>
                    </table>
                </div>
                <div class="totals-bar" id="monthlyTotals"></div>
            </div>
        </div>

        <!-- DESEURI -->
        <div id="section-deseuri" class="section">
            <div class="search-box">
                <label>An:</label>
                <select id="deseuriYear" onchange="loadDeseuriData()">
                    <option value="">Toti anii</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                </select>
                <label>Luna:</label>
                <select id="deseuriMonth" onchange="loadDeseuriData()">
                    <option value="">Toate</option>
                    <option value="1">Ianuarie</option>
                    <option value="2">Februarie</option>
                    <option value="3">Martie</option>
                    <option value="4">Aprilie</option>
                    <option value="5">Mai</option>
                    <option value="6">Iunie</option>
                    <option value="7">Iulie</option>
                    <option value="8">August</option>
                    <option value="9">Septembrie</option>
                    <option value="10">Octombrie</option>
                    <option value="11">Noiembrie</option>
                    <option value="12">Decembrie</option>
                </select>
            </div>
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">ü•ß</span> Distributie dupa Valoare</h2><div class="chart-container"><canvas id="deseuriPieChart"></canvas></div></div>
                <div class="card"><h2><span class="icon">üìä</span> Distributie dupa Profit</h2><div class="chart-container"><canvas id="profitPieChart"></canvas></div></div>
            </div>
            <div class="card">
                <h2><span class="icon">üì¶</span> Detalii Deseuri</h2>
                <div class="scroll-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Tip Deseu</th>
                                <th class="text-right">Total kg</th>
                                <th class="text-right">Valoare</th>
                                <th class="text-right">Profit</th>
                                <th class="text-right">% Vanzari</th>
                                <th class="text-right">% Profit</th>
                            </tr>
                        </thead>
                        <tbody id="deseuriTable"></tbody>
                    </table>
                </div>
                <div class="totals-bar" id="deseuriTotals"></div>
            </div>
        </div>

        <!-- COMPARE -->
        <div id="section-compare" class="section">
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üìä</span> Comparatie Anuala - Rulaj</h2><div class="chart-container tall"><canvas id="compareValueChart"></canvas></div></div>
                <div class="card"><h2><span class="icon">üí∞</span> Comparatie Anuala - Profit</h2><div class="chart-container tall"><canvas id="compareProfitChart"></canvas></div></div>
            </div>
            <div class="card">
                <h2><span class="icon">üìã</span> Sumar pe Ani</h2>
                <div class="scroll-table">
                    <table>
                        <thead>
                            <tr>
                                <th>An</th>
                                <th class="text-right">Nr. Vanzari</th>
                                <th class="text-right">Nr. Firme</th>
                                <th class="text-right">Total kg</th>
                                <th class="text-right">Valoare</th>
                                <th class="text-right">Profit</th>
                                <th class="text-right">Marja</th>
                                <th class="text-right">Medie/Luna</th>
                            </tr>
                        </thead>
                        <tbody id="yearlyTable"></tbody>
                    </table>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üí°</span> Analiza</h2>
                    <div id="compareInsights"></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üìà</span> Tendinte</h2>
                    <div id="compareTrends"></div>
                </div>
            </div>
        </div>

        <!-- TRANSPORT -->
        <div id="section-transport" class="section">
            <!-- Summary cards -->
            <div class="big-stats" id="transportStats">
                <div class="stat-card orange"><h4>Total Transport</h4><div class="value orange" id="transportTotal">...</div><div class="sub">RON</div></div>
                <div class="stat-card green"><h4>Belfold</h4><div class="value green" id="transportDomestic">...</div><div class="sub">RON</div></div>
                <div class="stat-card purple"><h4>Kulfold</h4><div class="value purple" id="transportForeign">...</div><div class="sub">RON</div></div>
                <div class="stat-card cyan"><h4>Nr. Szallitas</h4><div class="value cyan" id="transportCountTotal">...</div></div>
            </div>

            <div class="search-box">
                <label>An:</label>
                <select id="transportYear" onchange="loadTransportData()">
                    <option value="">Toti anii</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                </select>
                <label>Tip:</label>
                <select id="transportType" onchange="filterTransportTable()">
                    <option value="">Toate</option>
                    <option value="domestic">Belfold</option>
                    <option value="foreign">Kulfold</option>
                </select>
                <label>Destinatie:</label>
                <input type="text" id="transportDest" placeholder="Cauta destinatie..." style="width:150px;" onkeyup="filterTransportTable()">
                <label>Firma:</label>
                <input type="text" id="transportFirma" placeholder="Cauta firma..." style="width:150px;" onkeyup="filterTransportTable()">
                <button class="secondary" onclick="resetTransportFilters()">Reset</button>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üìä</span> Eves Osszehasonlitas</h2>
                    <div class="chart-container"><canvas id="transportYearChart"></canvas></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üåç</span> Belfold vs Kulfold</h2>
                    <div class="chart-container"><canvas id="transportTypeChart"></canvas></div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üöö</span> Havonkenti Koltsegek</h2>
                    <div class="chart-container"><canvas id="transportChart"></canvas></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üìç</span> Top Destinaciok</h2>
                    <div id="transportDestBars"></div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üìã</span> Reszletes Lista (<span id="transportCount">0</span>)</h2>
                <div class="scroll-table" style="max-height:400px;">
                    <table>
                        <thead>
                            <tr>
                                <th>An</th>
                                <th>Luna</th>
                                <th>Destinatie</th>
                                <th>Tipus</th>
                                <th>Firma</th>
                                <th class="text-right">Total</th>
                                <th>Transportator</th>
                            </tr>
                        </thead>
                        <tbody id="transportTable"></tbody>
                    </table>
                </div>
                <div class="totals-bar" id="transportTotals"></div>
            </div>
        </div>

        <!-- STATS -->
        <div id="section-stats" class="section">
            <!-- Key metrics -->
            <div class="big-stats">
                <div class="stat-card orange"><h4>Atlag Vanzare</h4><div class="value orange" id="statAvgSale">...</div><div class="sub">RON/vanzare</div></div>
                <div class="stat-card green"><h4>Atlag Profit</h4><div class="value green" id="statAvgProfit">...</div><div class="sub">RON/vanzare</div></div>
                <div class="stat-card purple"><h4>Atlag Marja</h4><div class="value purple" id="statAvgMargin">...</div><div class="sub">%</div></div>
                <div class="stat-card cyan"><h4>Novekedesi Rata</h4><div class="value cyan" id="statGrowth">...</div><div class="sub">% YoY</div></div>
                <div class="stat-card yellow"><h4>Top Ceg Aranya</h4><div class="value yellow" id="statTopShare">...</div><div class="sub">% forgalombol</div></div>
                <div class="stat-card red"><h4>Aktiv Cegek</h4><div class="value red" id="statActiveFirms">...</div><div class="sub">utobbi 6 honap</div></div>
            </div>

            <div class="grid grid-3">
                <div class="card">
                    <h2><span class="icon">üèÜ</span> Top 10 Firme - Profit</h2>
                    <div class="scroll-table"><table><thead><tr><th>#</th><th>Firma</th><th class="text-right">Profit</th><th class="text-right">Marja</th></tr></thead><tbody id="topProfitTable"></tbody></table></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üì¶</span> Top 10 Firme - Cantitate</h2>
                    <div class="scroll-table"><table><thead><tr><th>#</th><th>Firma</th><th class="text-right">Total kg</th><th class="text-right">Vanzari</th></tr></thead><tbody id="topKgTable"></tbody></table></div>
                </div>
                <div class="card">
                    <h2><span class="icon">‚ö°</span> Cea mai buna luna</h2>
                    <div id="bestMonthInfo"></div>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üìä</span> Marje pe Kategoriak</h2>
                    <div class="chart-container"><canvas id="marginChart"></canvas></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üìà</span> Havonkenti Profit Trend</h2>
                    <div class="chart-container"><canvas id="profitTrendChart"></canvas></div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üîÑ</span> Eves Osszehasonlitas</h2>
                    <div id="yearCompareInfo"></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üìâ</span> Szezonalitas</h2>
                    <div class="chart-container short"><canvas id="seasonalChart"></canvas></div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üîç</span> Inaktiv Cegek (6 honap)</h2>
                    <div class="scroll-table"><table><thead><tr><th>Firma</th><th>Utolso Vanzare</th><th class="text-right">Osszes Ertek</th><th class="text-right">Inaktiv Nap</th></tr></thead><tbody id="inactiveTable"></tbody></table></div>
                </div>
                <div class="card">
                    <h2><span class="icon">‚≠ê</span> Uj Cegek (12 honap)</h2>
                    <div class="scroll-table"><table><thead><tr><th>Firma</th><th>Elso Vanzare</th><th class="text-right">Osszes Ertek</th><th class="text-right">Vanzari</th></tr></thead><tbody id="newFirmsTable"></tbody></table></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIRMA MODAL -->
    <div class="modal-overlay" id="firmaModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalFirmaName">Profil Firma</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"><div class="loading">Se incarca...</div></div>
        </div>
    </div>

    <footer class="footer">PAJU B2B Dashboard | Powered by <strong>zYztem & Claude</strong></footer>

    <script>
        function checkPassword() {
            if (document.getElementById('passwordInput').value === 'war') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('visible');
                loadAllData();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // Check if already logged in from index.html
        if (sessionStorage.getItem('paju_auth') === 'true') {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.add('visible');
            document.addEventListener('DOMContentLoaded', loadAllData);
        }

        const monthNames = ['Ian', 'Feb', 'Mar', 'Apr', 'Mai', 'Iun', 'Iul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthNamesFull = ['Ianuarie', 'Februarie', 'Martie', 'Aprilie', 'Mai', 'Iunie', 'Iulie', 'August', 'Septembrie', 'Octombrie', 'Noiembrie', 'Decembrie'];
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

        let firmeData = null;
        let overviewData = null;
        let yearlyData = null;
        let allFirmeList = [];
        let monthlyChartInstance = null;
        let deseuriPieInstance = null;
        let profitPieInstance = null;
        let transportChartInstance = null;
        let marginChartInstance = null;
        let profitTrendInstance = null;

        function fmt(n) { return n ? n.toLocaleString('ro-RO', {maximumFractionDigits: 0}) : '0'; }
        function fmtDec(n) { return n ? n.toLocaleString('ro-RO', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'; }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');
            event.target.classList.add('active');

            if (id === 'monthly') loadMonthlyData();
            if (id === 'deseuri') loadDeseuriData();
            if (id === 'transport') loadTransportData();
            if (id === 'compare') loadCompareData();
            if (id === 'stats') loadStatsData();
        }

        async function loadAllData() {
            try {
                const [overview, firme, top, yearly] = await Promise.all([
                    fetch('/api/firme?type=overview').then(r => r.json()),
                    fetch('/api/firme?type=list').then(r => r.json()),
                    fetch('/api/firme?type=top&limit=10').then(r => r.json()),
                    fetch('/api/firme?type=yearly').then(r => r.json())
                ]);

                overviewData = overview;
                firmeData = firme;
                allFirmeList = firme.firme || [];
                yearlyData = yearly;

                // Set session auth
                sessionStorage.setItem('paju_auth', 'true');

                initOverview(overview, top, yearly);
                initFirmeList(firme);
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('totalValue').textContent = 'Eroare!';
            }
        }

        async function loadOverviewData() {
            const year = document.getElementById('overviewYear').value;
            let url = '/api/firme?type=overview';
            if (year) url += `&year=${year}`;

            try {
                const [overview, top] = await Promise.all([
                    fetch(url).then(r => r.json()),
                    fetch(`/api/firme?type=top&limit=10${year ? '&year=' + year : ''}`).then(r => r.json())
                ]);

                const o = overview.overview;
                document.getElementById('totalValue').textContent = fmt(o.total_valoare_ron);
                document.getElementById('totalProfit').textContent = fmt(o.total_profit_ron);
                document.getElementById('profitMargin').textContent = fmtDec(o.profit_margin);
                document.getElementById('totalVanzari').textContent = fmt(o.total_vanzari);
                document.getElementById('totalFirme').textContent = fmt(o.firme_active);
                document.getElementById('totalKg').textContent = fmt(o.total_kg);

                // Update top firme table
                if (top.top_by_value) {
                    const tbody = document.getElementById('topFirmeTable');
                    tbody.innerHTML = top.top_by_value.map((f, i) => {
                        const margin = f.total_valoare > 0 ? (f.total_profit / f.total_valoare * 100).toFixed(1) : 0;
                        return `<tr class="clickable" onclick="showFirmaProfile(${f.id})">
                            <td>${i + 1}</td>
                            <td>${f.name}</td>
                            <td class="text-right">${fmt(f.total_valoare)}</td>
                            <td class="text-right profit-positive">${fmt(f.total_profit)}</td>
                            <td class="text-right">${margin}%</td>
                        </tr>`;
                    }).join('');
                }
            } catch (e) {
                console.error('Error loading overview:', e);
            }
        }

        function initOverview(overview, top, yearly) {
            const o = overview.overview;
            document.getElementById('totalValue').textContent = fmt(o.total_valoare_ron);
            document.getElementById('totalProfit').textContent = fmt(o.total_profit_ron);
            document.getElementById('profitMargin').textContent = fmtDec(o.profit_margin);
            document.getElementById('totalVanzari').textContent = fmt(o.total_vanzari);
            document.getElementById('totalFirme').textContent = fmt(o.firme_active);
            document.getElementById('totalKg').textContent = fmt(o.total_kg);

            // Yearly chart
            if (overview.by_year && overview.by_year.length > 0) {
                new Chart(document.getElementById('yearlyChart'), {
                    type: 'bar',
                    data: {
                        labels: overview.by_year.map(y => y.year),
                        datasets: [{
                            label: 'Rulaj (M RON)',
                            data: overview.by_year.map(y => y.valoare_ron / 1e6),
                            backgroundColor: 'rgba(255,159,64,0.7)',
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: ctx => fmt(ctx.raw * 1e6) + ' RON' } }
                        }
                    }
                });

                new Chart(document.getElementById('valueProfitChart'), {
                    type: 'bar',
                    data: {
                        labels: overview.by_year.map(y => y.year),
                        datasets: [
                            { label: 'Rulaj (M)', data: overview.by_year.map(y => y.valoare_ron / 1e6), backgroundColor: 'rgba(255,159,64,0.7)', borderRadius: 6 },
                            { label: 'Profit (M)', data: overview.by_year.map(y => y.profit_ron / 1e6), backgroundColor: 'rgba(0,255,136,0.7)', borderRadius: 6 }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#fff' } } }
                    }
                });
            }

            // Top firme table
            if (top.top_by_value) {
                const tbody = document.getElementById('topFirmeTable');
                tbody.innerHTML = top.top_by_value.map((f, i) => {
                    const margin = f.total_valoare > 0 ? (f.total_profit / f.total_valoare * 100).toFixed(1) : 0;
                    return `<tr class="clickable" onclick="showFirmaProfile(${f.id})">
                        <td>${i + 1}</td>
                        <td>${f.name}</td>
                        <td class="text-right">${fmt(f.total_valoare)}</td>
                        <td class="text-right profit-positive">${fmt(f.total_profit)}</td>
                        <td class="text-right">${margin}%</td>
                    </tr>`;
                }).join('');
            }

            loadTopDeseuri();
        }

        async function loadTopDeseuri() {
            try {
                const deseuri = await fetch('/api/firme?type=deseuri').then(r => r.json());
                if (deseuri.deseuri && deseuri.deseuri.length > 0) {
                    const container = document.getElementById('deseuriBars');
                    const max = deseuri.deseuri[0]?.total_valoare || 1;
                    const colors = ['#ff6384', '#ff9f40', '#00ff88', '#00d9ff', '#9966ff', '#ffce56', '#4bc0c0', '#e7e9ed'];
                    container.innerHTML = deseuri.deseuri.slice(0, 8).map((d, i) => `
                        <div class="category-bar">
                            <span class="name">${d.tip_deseu || 'N/A'}</span>
                            <div class="bar-bg">
                                <div class="bar" style="width:${(d.total_valoare / max * 100).toFixed(0)}%;background:${colors[i]};"></div>
                            </div>
                            <span class="value">${fmt(d.total_valoare)} RON</span>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error('Error loading deseuri:', e);
            }
        }

        function initFirmeList(firme) {
            document.getElementById('firmeCount').textContent = firme.count;
            renderFirmeTable(firme.firme);
        }

        function renderFirmeTable(list) {
            const tbody = document.getElementById('firmeTable');
            let totalValoare = 0, totalProfit = 0, totalKg = 0, totalVanzari = 0;

            tbody.innerHTML = list.map((f, i) => {
                const margin = f.total_valoare > 0 ? (f.total_profit / f.total_valoare * 100).toFixed(1) : 0;
                totalValoare += f.total_valoare || 0;
                totalProfit += f.total_profit || 0;
                totalKg += f.total_kg || 0;
                totalVanzari += f.nr_vanzari || 0;
                return `<tr class="clickable" onclick="showFirmaProfile(${f.id})">
                    <td>${i + 1}</td>
                    <td>${f.name}</td>
                    <td class="text-right">${f.nr_vanzari}</td>
                    <td class="text-right">${fmt(f.total_kg)}</td>
                    <td class="text-right">${fmt(f.total_valoare)}</td>
                    <td class="text-right profit-positive">${fmt(f.total_profit)}</td>
                    <td class="text-right">${margin}%</td>
                    <td>${f.last_sale || '-'}</td>
                </tr>`;
            }).join('');

            document.getElementById('firmeTotals').innerHTML = `
                <div class="total-item"><span class="total-label">Firme</span><span class="total-value">${list.length}</span></div>
                <div class="total-item"><span class="total-label">Vanzari</span><span class="total-value">${fmt(totalVanzari)}</span></div>
                <div class="total-item"><span class="total-label">Total kg</span><span class="total-value">${fmt(totalKg)}</span></div>
                <div class="total-item"><span class="total-label">Valoare</span><span class="total-value">${fmt(totalValoare)} RON</span></div>
                <div class="total-item"><span class="total-label">Profit</span><span class="total-value">${fmt(totalProfit)} RON</span></div>
                <div class="total-item"><span class="total-label">Marja</span><span class="total-value">${totalValoare > 0 ? (totalProfit/totalValoare*100).toFixed(1) : 0}%</span></div>
            `;
        }

        async function searchFirme() {
            const query = document.getElementById('firmaSearch').value;
            const year = document.getElementById('firmaYear').value;
            const minValue = parseFloat(document.getElementById('firmaMinValue').value) || 0;
            const sort = document.getElementById('firmaSort').value;

            // Build API URL with filters
            let url = '/api/firme?type=list';
            if (year) url += `&year=${year}`;
            if (query) url += `&search=${encodeURIComponent(query)}`;

            try {
                const data = await fetch(url).then(r => r.json());
                let filtered = data.firme || [];

                // Client-side filtering for min value
                if (minValue > 0) {
                    filtered = filtered.filter(f => f.total_valoare >= minValue);
                }

                // Client-side sorting
                switch(sort) {
                    case 'value_asc': filtered.sort((a,b) => a.total_valoare - b.total_valoare); break;
                    case 'profit_desc': filtered.sort((a,b) => b.total_profit - a.total_profit); break;
                    case 'name_asc': filtered.sort((a,b) => a.name.localeCompare(b.name)); break;
                    case 'visits_desc': filtered.sort((a,b) => b.nr_vanzari - a.nr_vanzari); break;
                    default: filtered.sort((a,b) => b.total_valoare - a.total_valoare);
                }

                document.getElementById('firmeCount').textContent = filtered.length;
                renderFirmeTable(filtered);
            } catch (e) {
                console.error('Error searching firme:', e);
            }
        }

        function resetFirmaFilters() {
            document.getElementById('firmaSearch').value = '';
            document.getElementById('firmaYear').value = '';
            document.getElementById('firmaMinValue').value = '0';
            document.getElementById('firmaSort').value = 'value_desc';
            searchFirme();
        }

        async function loadMonthlyData() {
            const year = document.getElementById('monthlyYear').value;
            const url = year ? `/api/firme?type=monthly&year=${year}` : '/api/firme?type=monthly';

            try {
                const data = await fetch(url).then(r => r.json());

                if (monthlyChartInstance) monthlyChartInstance.destroy();

                const labels = data.months.map(m => monthNames[m.month - 1] + "'" + String(m.year).slice(2));
                monthlyChartInstance = new Chart(document.getElementById('monthlyChart'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Rulaj', data: data.months.map(m => m.total_valoare), borderColor: '#ff9f40', backgroundColor: 'rgba(255,159,64,0.1)', fill: true, tension: 0.3, yAxisID: 'y' },
                            { label: 'Profit', data: data.months.map(m => m.total_profit), borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', fill: true, tension: 0.3, yAxisID: 'y' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { labels: { color: '#fff' } }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw) + ' RON' } } },
                        scales: { y: { ticks: { callback: v => fmt(v) } } }
                    }
                });

                let totalVal = 0, totalProf = 0, totalKg = 0, totalVanz = 0;
                const tbody = document.getElementById('monthlyTable');
                tbody.innerHTML = data.months.map(m => {
                    totalVal += m.total_valoare || 0;
                    totalProf += m.total_profit || 0;
                    totalKg += m.total_kg || 0;
                    totalVanz += m.nr_vanzari || 0;
                    return `<tr>
                        <td>${m.year}</td><td>${m.month_name}</td>
                        <td class="text-right">${m.nr_vanzari}</td><td class="text-right">${m.nr_firme}</td>
                        <td class="text-right">${fmt(m.total_kg)}</td><td class="text-right">${fmt(m.total_valoare)}</td>
                        <td class="text-right profit-positive">${fmt(m.total_profit)}</td><td class="text-right">${fmtDec(m.profit_margin)}%</td>
                    </tr>`;
                }).join('');

                document.getElementById('monthlyTotals').innerHTML = `
                    <div class="total-item"><span class="total-label">Luni</span><span class="total-value">${data.months.length}</span></div>
                    <div class="total-item"><span class="total-label">Vanzari</span><span class="total-value">${fmt(totalVanz)}</span></div>
                    <div class="total-item"><span class="total-label">Total kg</span><span class="total-value">${fmt(totalKg)}</span></div>
                    <div class="total-item"><span class="total-label">Valoare</span><span class="total-value">${fmt(totalVal)} RON</span></div>
                    <div class="total-item"><span class="total-label">Profit</span><span class="total-value">${fmt(totalProf)} RON</span></div>
                `;
            } catch (e) { console.error('Error loading monthly:', e); }
        }

        async function loadDeseuriData() {
            const year = document.getElementById('deseuriYear').value;
            const month = document.getElementById('deseuriMonth').value;
            let url = '/api/firme?type=deseuri';
            if (year) url += `&year=${year}`;
            if (month) url += `&month=${month}`;

            try {
                const data = await fetch(url).then(r => r.json());

                if (deseuriPieInstance) deseuriPieInstance.destroy();
                if (profitPieInstance) profitPieInstance.destroy();

                const colors = ['#ff6384', '#ff9f40', '#00ff88', '#00d9ff', '#9966ff', '#ffce56', '#4bc0c0', '#e7e9ed', '#ff6b6b', '#feca57'];

                deseuriPieInstance = new Chart(document.getElementById('deseuriPieChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.deseuri.slice(0, 8).map(d => d.tip_deseu || 'N/A'),
                        datasets: [{ data: data.deseuri.slice(0, 8).map(d => d.total_valoare), backgroundColor: colors, borderWidth: 0 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 10 } } }, tooltip: { callbacks: { label: ctx => ctx.label + ': ' + fmt(ctx.raw) + ' RON' } } }
                    }
                });

                profitPieInstance = new Chart(document.getElementById('profitPieChart'), {
                    type: 'doughnut',
                    data: {
                        labels: data.deseuri.slice(0, 8).map(d => d.tip_deseu || 'N/A'),
                        datasets: [{ data: data.deseuri.slice(0, 8).map(d => d.total_profit), backgroundColor: colors, borderWidth: 0 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 10 } } }, tooltip: { callbacks: { label: ctx => ctx.label + ': ' + fmt(ctx.raw) + ' RON' } } }
                    }
                });

                let totalKg = 0, totalVal = 0, totalProf = 0;
                const tbody = document.getElementById('deseuriTable');
                tbody.innerHTML = data.deseuri.map(d => {
                    totalKg += d.total_kg || 0;
                    totalVal += d.total_valoare || 0;
                    totalProf += d.total_profit || 0;
                    return `<tr>
                        <td>${d.tip_deseu || 'N/A'}</td>
                        <td class="text-right">${fmt(d.total_kg)}</td>
                        <td class="text-right">${fmt(d.total_valoare)}</td>
                        <td class="text-right profit-positive">${fmt(d.total_profit)}</td>
                        <td class="text-right">${fmtDec(d.procent_vanzari)}%</td>
                        <td class="text-right">${fmtDec(d.procent_profit)}%</td>
                    </tr>`;
                }).join('');

                document.getElementById('deseuriTotals').innerHTML = `
                    <div class="total-item"><span class="total-label">Categorii</span><span class="total-value">${data.deseuri.length}</span></div>
                    <div class="total-item"><span class="total-label">Total kg</span><span class="total-value">${fmt(totalKg)}</span></div>
                    <div class="total-item"><span class="total-label">Valoare</span><span class="total-value">${fmt(totalVal)} RON</span></div>
                    <div class="total-item"><span class="total-label">Profit</span><span class="total-value">${fmt(totalProf)} RON</span></div>
                `;
            } catch (e) { console.error('Error loading deseuri:', e); }
        }

        async function loadCompareData() {
            if (!yearlyData) {
                yearlyData = await fetch('/api/firme?type=yearly').then(r => r.json());
            }

            const years = yearlyData.years;
            const monthly = yearlyData.monthly_by_year;

            const colors = ['#ff9f40', '#00ff88', '#00d9ff'];
            const datasets = [];
            Object.keys(monthly).forEach((year, i) => {
                datasets.push({
                    label: year,
                    data: monthNames.map((_, mi) => monthly[year][mi + 1]?.valoare || null),
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '20',
                    fill: true, tension: 0.3
                });
            });

            new Chart(document.getElementById('compareValueChart'), {
                type: 'line',
                data: { labels: monthNames, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#fff' } }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw) + ' RON' } } }
                }
            });

            const profitDatasets = [];
            Object.keys(monthly).forEach((year, i) => {
                profitDatasets.push({
                    label: year,
                    data: monthNames.map((_, mi) => monthly[year][mi + 1]?.profit || null),
                    borderColor: colors[i % colors.length],
                    backgroundColor: colors[i % colors.length] + '20',
                    fill: true, tension: 0.3
                });
            });

            new Chart(document.getElementById('compareProfitChart'), {
                type: 'line',
                data: { labels: monthNames, datasets: profitDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#fff' } }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw) + ' RON' } } }
                }
            });

            const tbody = document.getElementById('yearlyTable');
            tbody.innerHTML = years.map(y => `
                <tr>
                    <td><strong>${y.year}</strong></td>
                    <td class="text-right">${fmt(y.nr_vanzari)}</td>
                    <td class="text-right">${y.nr_firme}</td>
                    <td class="text-right">${fmt(y.total_kg)}</td>
                    <td class="text-right">${fmt(y.total_valoare)}</td>
                    <td class="text-right profit-positive">${fmt(y.total_profit)}</td>
                    <td class="text-right">${fmtDec(y.profit_margin)}%</td>
                    <td class="text-right">${fmt(y.avg_per_month)}</td>
                </tr>
            `).join('');

            // Insights
            let insights = '';
            if (years.length >= 2) {
                const y1 = years[years.length - 2];
                const y2 = years[years.length - 1];
                const yoy = ((y2.total_valoare - y1.total_valoare) / y1.total_valoare * 100).toFixed(1);
                const profitYoy = ((y2.total_profit - y1.total_profit) / y1.total_profit * 100).toFixed(1);
                insights += `<div class="insight-box"><strong>${y2.year} vs ${y1.year}:</strong> Rulaj ${yoy >= 0 ? '+' : ''}${yoy}%, Profit ${profitYoy >= 0 ? '+' : ''}${profitYoy}%</div>`;

                const bestYear = years.reduce((a, b) => a.total_valoare > b.total_valoare ? a : b);
                insights += `<div class="insight-box"><strong>Cel mai bun an:</strong> ${bestYear.year} cu ${fmt(bestYear.total_valoare)} RON</div>`;
            }
            document.getElementById('compareInsights').innerHTML = insights || '<p style="color:#888;">Nu sunt suficiente date pentru analiza.</p>';

            // Trends
            let trends = '';
            if (years.length >= 2) {
                const avgMargin = years.reduce((s, y) => s + y.profit_margin, 0) / years.length;
                trends += `<div class="insight-box"><strong>Marja medie:</strong> ${avgMargin.toFixed(1)}%</div>`;
                const totalFirme = new Set(allFirmeList.map(f => f.name)).size;
                trends += `<div class="insight-box"><strong>Firme unice:</strong> ${totalFirme}</div>`;
            }
            document.getElementById('compareTrends').innerHTML = trends || '';
        }

        let allTransportData = null;
        let transportYearChartInstance = null;
        let transportTypeChartInstance = null;

        async function loadTransportData() {
            const year = document.getElementById('transportYear').value;
            let url = '/api/firme?type=transporturi';
            if (year) url += `&year=${year}`;

            try {
                const data = await fetch(url).then(r => r.json());
                allTransportData = data;

                // Update summary cards
                const summary = data.summary || {total_cost: 0, domestic: {count: 0, total: 0}, foreign: {count: 0, total: 0}};
                document.getElementById('transportTotal').textContent = fmt(summary.total_cost);
                document.getElementById('transportDomestic').textContent = fmt(summary.domestic.total);
                document.getElementById('transportForeign').textContent = fmt(summary.foreign.total);
                document.getElementById('transportCountTotal').textContent = data.count || 0;

                // Year comparison chart
                if (transportYearChartInstance) transportYearChartInstance.destroy();
                if (data.by_year && data.by_year.length > 0) {
                    transportYearChartInstance = new Chart(document.getElementById('transportYearChart'), {
                        type: 'bar',
                        data: {
                            labels: data.by_year.map(y => y.year),
                            datasets: [{
                                label: 'Koltseg',
                                data: data.by_year.map(y => y.total_cost),
                                backgroundColor: ['rgba(255,107,107,0.8)', 'rgba(255,159,64,0.8)'],
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => fmt(ctx.raw) + ' RON' } } },
                            scales: { y: { ticks: { callback: v => fmt(v) } } }
                        }
                    });
                }

                // Domestic vs Foreign pie chart
                if (transportTypeChartInstance) transportTypeChartInstance.destroy();
                transportTypeChartInstance = new Chart(document.getElementById('transportTypeChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Belfold', 'Kulfold'],
                        datasets: [{
                            data: [summary.domestic.total, summary.foreign.total],
                            backgroundColor: ['rgba(0,255,136,0.8)', 'rgba(153,102,255,0.8)'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { color: '#fff' } },
                            tooltip: { callbacks: { label: ctx => fmt(ctx.raw) + ' RON (' + (ctx.raw / summary.total_cost * 100).toFixed(1) + '%)' } }
                        }
                    }
                });

                // Monthly chart
                if (transportChartInstance) transportChartInstance.destroy();
                if (data.monthly_totals && data.monthly_totals.length > 0) {
                    const labels = data.monthly_totals.map(t => monthNames[t.month - 1] + "'" + String(t.year).slice(2));
                    transportChartInstance = new Chart(document.getElementById('transportChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{ label: 'Cost Transport', data: data.monthly_totals.map(t => t.total_cost), borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.2)', fill: true, tension: 0.3 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => fmt(ctx.raw) + ' RON' } } },
                            scales: { y: { ticks: { callback: v => fmt(v) } } }
                        }
                    });
                }

                // Destination bars
                const maxDest = data.by_destination?.[0]?.total_cost || 1;
                document.getElementById('transportDestBars').innerHTML = (data.by_destination || []).slice(0, 10).map(d => {
                    const pct = (d.total_cost / maxDest * 100).toFixed(0);
                    const color = d.is_foreign ? '#9966ff' : '#00ff88';
                    const badge = d.is_foreign ? '<span class="badge purple" style="margin-left:5px;">Kulfold</span>' : '<span class="badge green" style="margin-left:5px;">Belfold</span>';
                    return `<div class="category-bar">
                        <span class="name">${d.destinatie}${badge}</span>
                        <div class="bar-bg"><div class="bar" style="width:${pct}%;background:${color};">${fmt(d.total_cost)}</div></div>
                        <span class="kg">${d.count} db</span>
                    </div>`;
                }).join('') || '<p style="color:#888;">Nincs adat</p>';

                // Filter and render table
                filterTransportTable();
            } catch (e) { console.error('Error loading transport:', e); }
        }

        function filterTransportTable() {
            if (!allTransportData) return;

            const transportType = document.getElementById('transportType').value;
            const dest = document.getElementById('transportDest').value.toLowerCase();
            const firma = document.getElementById('transportFirma').value.toLowerCase();

            let filtered = allTransportData.transporturi || [];
            if (transportType === 'domestic') filtered = filtered.filter(t => !t.is_foreign);
            if (transportType === 'foreign') filtered = filtered.filter(t => t.is_foreign);
            if (dest) filtered = filtered.filter(t => (t.destinatie || '').toLowerCase().includes(dest));
            if (firma) filtered = filtered.filter(t => (t.firma_name || '').toLowerCase().includes(firma));

            document.getElementById('transportCount').textContent = filtered.length;

            let totalCost = 0;
            const tbody = document.getElementById('transportTable');
            tbody.innerHTML = filtered.map(t => {
                totalCost += t.total || 0;
                const typeBadge = t.is_foreign
                    ? '<span class="badge purple">Kulfold</span>'
                    : '<span class="badge green">Belfold</span>';
                return `<tr>
                    <td>${t.year}</td><td>${monthNames[t.month - 1]}</td>
                    <td>${t.destinatie || '-'}</td><td>${typeBadge}</td>
                    <td>${t.firma_name || '-'}</td>
                    <td class="text-right"><strong>${fmt(t.total)}</strong></td>
                    <td>${t.transportator || '-'}</td>
                </tr>`;
            }).join('');

            document.getElementById('transportTotals').innerHTML = `
                <div class="total-item"><span class="total-label">Szallitasok</span><span class="total-value">${filtered.length}</span></div>
                <div class="total-item"><span class="total-label">Osszes Koltseg</span><span class="total-value">${fmt(totalCost)} RON</span></div>
            `;
        }

        function resetTransportFilters() {
            document.getElementById('transportYear').value = '';
            document.getElementById('transportType').value = '';
            document.getElementById('transportDest').value = '';
            document.getElementById('transportFirma').value = '';
            loadTransportData();
        }

        let seasonalChartInstance = null;

        async function loadStatsData() {
            try {
                const [top, deseuri, monthly, yearly] = await Promise.all([
                    fetch('/api/firme?type=top&limit=10').then(r => r.json()),
                    fetch('/api/firme?type=deseuri').then(r => r.json()),
                    fetch('/api/firme?type=monthly').then(r => r.json()),
                    fetch('/api/firme?type=yearly').then(r => r.json())
                ]);

                // Calculate key metrics
                const totalVanzari = monthly.months?.reduce((s, m) => s + m.nr_vanzari, 0) || 0;
                const totalValoare = monthly.months?.reduce((s, m) => s + m.total_valoare, 0) || 0;
                const totalProfit = monthly.months?.reduce((s, m) => s + m.total_profit, 0) || 0;
                const avgSale = totalVanzari > 0 ? totalValoare / totalVanzari : 0;
                const avgProfit = totalVanzari > 0 ? totalProfit / totalVanzari : 0;
                const avgMargin = totalValoare > 0 ? (totalProfit / totalValoare * 100) : 0;

                // YoY growth calculation
                let growth = 0;
                if (yearly.years && yearly.years.length >= 2) {
                    const y1 = yearly.years.find(y => y.year === 2023);
                    const y2 = yearly.years.find(y => y.year === 2024);
                    if (y1 && y2) growth = ((y2.total_valoare - y1.total_valoare) / y1.total_valoare * 100);
                }

                // Top 5 companies share
                const topShare = top.top_by_value ? (top.top_by_value.slice(0, 5).reduce((s, f) => s + f.total_valoare, 0) / totalValoare * 100) : 0;

                // Active firms (last 6 months)
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                const activeFirms = allFirmeList.filter(f => f.last_sale && new Date(f.last_sale) >= sixMonthsAgo).length;

                // Update stat cards
                document.getElementById('statAvgSale').textContent = fmt(avgSale);
                document.getElementById('statAvgProfit').textContent = fmt(avgProfit);
                document.getElementById('statAvgMargin').textContent = avgMargin.toFixed(1);
                document.getElementById('statGrowth').textContent = (growth >= 0 ? '+' : '') + growth.toFixed(1);
                document.getElementById('statTopShare').textContent = topShare.toFixed(1);
                document.getElementById('statActiveFirms').textContent = activeFirms;

                // Top profit table
                if (top.top_by_profit) {
                    document.getElementById('topProfitTable').innerHTML = top.top_by_profit.map((f, i) => {
                        const margin = f.total_valoare > 0 ? (f.total_profit / f.total_valoare * 100).toFixed(1) : 0;
                        return `<tr class="clickable" onclick="showFirmaProfile(${f.id})"><td>${i+1}</td><td>${f.name}</td><td class="text-right profit-positive">${fmt(f.total_profit)}</td><td class="text-right">${margin}%</td></tr>`;
                    }).join('');
                }

                // Top kg table
                if (top.top_by_kg) {
                    document.getElementById('topKgTable').innerHTML = top.top_by_kg.map((f, i) =>
                        `<tr class="clickable" onclick="showFirmaProfile(${f.id})"><td>${i+1}</td><td>${f.name}</td><td class="text-right">${fmt(f.total_kg)}</td><td class="text-right">${f.nr_vanzari}</td></tr>`
                    ).join('');
                }

                // Best month info
                if (monthly.months && monthly.months.length > 0) {
                    const best = monthly.months.reduce((a, b) => (a.total_valoare || 0) > (b.total_valoare || 0) ? a : b);
                    const worst = monthly.months.filter(m => m.total_valoare > 0).reduce((a, b) => (a.total_valoare || Infinity) < (b.total_valoare || Infinity) ? a : b, monthly.months[0]);
                    document.getElementById('bestMonthInfo').innerHTML = `
                        <div class="insight-box" style="margin-bottom:10px;"><strong>Legjobb:</strong> ${best.month_name} ${best.year}<br>
                        ${fmt(best.total_valoare)} RON (${fmt(best.total_profit)} profit)</div>
                        <div class="insight-box warning"><strong>Leggyengebb:</strong> ${worst.month_name} ${worst.year}<br>
                        ${fmt(worst.total_valoare)} RON</div>
                    `;
                }

                // Margin chart by waste type
                if (marginChartInstance) marginChartInstance.destroy();
                if (deseuri.deseuri && deseuri.deseuri.length > 0) {
                    const marje = deseuri.deseuri.filter(d => d.total_valoare > 0).map(d => ({
                        tip: d.tip_deseu,
                        margin: (d.total_profit / d.total_valoare * 100)
                    })).sort((a, b) => b.margin - a.margin).slice(0, 8);

                    marginChartInstance = new Chart(document.getElementById('marginChart'), {
                        type: 'bar',
                        data: {
                            labels: marje.map(m => m.tip),
                            datasets: [{ label: 'Marja %', data: marje.map(m => m.margin), backgroundColor: 'rgba(0,217,255,0.7)', borderRadius: 6 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            indexAxis: 'y',
                            plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.raw.toFixed(1) + '%' } } }
                        }
                    });
                }

                // Profit trend chart
                if (profitTrendInstance) profitTrendInstance.destroy();
                if (monthly.months && monthly.months.length > 0) {
                    const labels = monthly.months.map(m => monthNames[m.month - 1] + "'" + String(m.year).slice(2));
                    profitTrendInstance = new Chart(document.getElementById('profitTrendChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Profit', data: monthly.months.map(m => m.total_profit), borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', fill: true, tension: 0.3, yAxisID: 'y' },
                                { label: 'Marja %', data: monthly.months.map(m => m.profit_margin), borderColor: '#9966ff', borderDash: [5, 5], tension: 0.3, yAxisID: 'y1' }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: '#fff' } } },
                            scales: {
                                y: { type: 'linear', position: 'left', ticks: { callback: v => fmt(v) } },
                                y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: v => v + '%' } }
                            }
                        }
                    });
                }

                // Year comparison info
                if (yearly.years && yearly.years.length >= 2) {
                    let compHtml = '<table style="width:100%;font-size:0.9em;"><tr><th>Ev</th><th class="text-right">Rulaj</th><th class="text-right">Profit</th><th class="text-right">Valt.</th></tr>';
                    for (let i = 0; i < yearly.years.length; i++) {
                        const y = yearly.years[i];
                        let change = '';
                        if (i > 0) {
                            const prev = yearly.years[i-1];
                            const pct = ((y.total_valoare - prev.total_valoare) / prev.total_valoare * 100).toFixed(1);
                            change = pct >= 0 ? `<span style="color:#00ff88;">+${pct}%</span>` : `<span style="color:#ff6b6b;">${pct}%</span>`;
                        }
                        compHtml += `<tr><td>${y.year}</td><td class="text-right">${fmt(y.total_valoare)}</td><td class="text-right">${fmt(y.total_profit)}</td><td class="text-right">${change}</td></tr>`;
                    }
                    compHtml += '</table>';
                    document.getElementById('yearCompareInfo').innerHTML = compHtml;
                }

                // Seasonal chart (avg by month across years)
                if (seasonalChartInstance) seasonalChartInstance.destroy();
                if (monthly.months && monthly.months.length > 0) {
                    const byMonth = {};
                    monthly.months.forEach(m => {
                        if (!byMonth[m.month]) byMonth[m.month] = [];
                        byMonth[m.month].push(m.total_valoare);
                    });
                    const avgByMonth = Object.keys(byMonth).sort((a,b) => a - b).map(m => {
                        const vals = byMonth[m];
                        return vals.reduce((s, v) => s + v, 0) / vals.length;
                    });

                    seasonalChartInstance = new Chart(document.getElementById('seasonalChart'), {
                        type: 'bar',
                        data: {
                            labels: monthNames,
                            datasets: [{ label: 'Atlag', data: avgByMonth, backgroundColor: 'rgba(255,159,64,0.7)', borderRadius: 4 }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => fmt(ctx.raw) + ' RON' } } },
                            scales: { y: { ticks: { callback: v => fmt(v) } } }
                        }
                    });
                }

                // Inactive firms (last 6 months)
                const inactive = allFirmeList.filter(f => {
                    if (!f.last_sale) return false;
                    return new Date(f.last_sale) < sixMonthsAgo;
                }).sort((a, b) => new Date(a.last_sale) - new Date(b.last_sale));

                document.getElementById('inactiveTable').innerHTML = inactive.slice(0, 15).map(f => {
                    const days = Math.floor((new Date() - new Date(f.last_sale)) / (1000*60*60*24));
                    return `<tr class="clickable" onclick="showFirmaProfile(${f.id})">
                        <td>${f.name}</td><td>${f.last_sale}</td>
                        <td class="text-right">${fmt(f.total_valoare)}</td>
                        <td class="text-right" style="color:#ff6b6b;">${days} nap</td>
                    </tr>`;
                }).join('') || '<tr><td colspan="4" style="color:#888;">Nincs inaktiv ceg</td></tr>';

                // New firms (first sale in last 12 months)
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                const newFirms = allFirmeList.filter(f => {
                    if (!f.first_sale) return false;
                    return new Date(f.first_sale) >= oneYearAgo;
                }).sort((a, b) => new Date(b.first_sale) - new Date(a.first_sale));

                document.getElementById('newFirmsTable').innerHTML = newFirms.slice(0, 15).map(f => {
                    return `<tr class="clickable" onclick="showFirmaProfile(${f.id})">
                        <td>${f.name}</td><td>${f.first_sale}</td>
                        <td class="text-right">${fmt(f.total_valoare)}</td>
                        <td class="text-right">${f.nr_vanzari}</td>
                    </tr>`;
                }).join('') || '<tr><td colspan="4" style="color:#888;">Nincs uj ceg</td></tr>';

            } catch (e) { console.error('Error loading stats:', e); }
        }

        async function showFirmaProfile(firmaId) {
            document.getElementById('firmaModal').classList.add('active');
            document.getElementById('modalContent').innerHTML = '<div class="loading">Se incarca...</div>';

            try {
                const data = await fetch(`/api/firme?type=firma&id=${firmaId}`).then(r => r.json());
                const f = data.firma;

                document.getElementById('modalFirmaName').textContent = f.name;

                let html = `
                    <div class="big-stats" style="margin-bottom:20px;">
                        <div class="stat-card orange"><h4>Total Valoare</h4><div class="value orange">${fmt(f.total_valoare)}</div><div class="sub">RON</div></div>
                        <div class="stat-card green"><h4>Total Profit</h4><div class="value green">${fmt(f.total_profit)}</div><div class="sub">RON</div></div>
                        <div class="stat-card purple"><h4>Marja</h4><div class="value purple">${fmtDec(f.profit_margin)}</div><div class="sub">%</div></div>
                        <div class="stat-card cyan"><h4>Vanzari</h4><div class="value cyan">${f.nr_vanzari}</div></div>
                        <div class="stat-card yellow"><h4>Total kg</h4><div class="value yellow">${fmt(f.total_kg)}</div></div>
                    </div>
                    <p style="color:#888;margin-bottom:15px;">Prima vanzare: ${f.first_sale || '-'} | Ultima vanzare: ${f.last_sale || '-'}</p>
                `;

                if (data.monthly && data.monthly.length > 0) {
                    html += `<h4 style="color:#ff9f40;margin-bottom:10px;">Evolutie Lunara</h4>
                        <div class="scroll-table" style="max-height:200px;margin-bottom:20px;">
                            <table><thead><tr><th>An</th><th>Luna</th><th class="text-right">Vanzari</th><th class="text-right">kg</th><th class="text-right">Valoare</th><th class="text-right">Profit</th></tr></thead>
                            <tbody>${data.monthly.map(m => `<tr><td>${m.year}</td><td>${monthNames[m.month - 1]}</td><td class="text-right">${m.nr_vanzari}</td><td class="text-right">${fmt(m.kg)}</td><td class="text-right">${fmt(m.valoare)}</td><td class="text-right profit-positive">${fmt(m.profit)}</td></tr>`).join('')}</tbody>
                            </table>
                        </div>`;
                }

                if (data.recent_vanzari && data.recent_vanzari.length > 0) {
                    html += `<h4 style="color:#ff9f40;margin-bottom:10px;">Ultimele Vanzari</h4>
                        <div class="scroll-table" style="max-height:250px;">
                            <table><thead><tr><th>Data</th><th>Aviz</th><th>Tip Deseu</th><th class="text-right">Livrat</th><th class="text-right">Receptat</th><th class="text-right">Valoare</th><th class="text-right">Adaos</th></tr></thead>
                            <tbody>${data.recent_vanzari.map(v => `<tr><td>${v.data}</td><td>${v.numar_aviz || '-'}</td><td>${v.tip_deseu || '-'}</td><td class="text-right">${fmt(v.cantitate_livrata)} kg</td><td class="text-right">${fmt(v.cantitate_receptionata)} kg</td><td class="text-right">${fmt(v.valoare_ron)}</td><td class="text-right profit-positive">${fmt(v.adaos_final)}</td></tr>`).join('')}</tbody>
                            </table>
                        </div>`;
                }

                document.getElementById('modalContent').innerHTML = html;
            } catch (e) {
                document.getElementById('modalContent').innerHTML = '<p style="color:#ff6b6b;">Eroare la incarcarea datelor!</p>';
            }
        }

        function closeModal() {
            document.getElementById('firmaModal').classList.remove('active');
        }

        document.getElementById('firmaModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
