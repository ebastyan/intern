<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAJU Executive Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #0a0a12 0%, #141428 50%, #1a1a35 100%); min-height: 100vh; color: #fff; }
        .login-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #0a0a12 0%, #141428 50%, #1a1a35 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-screen.hidden { display: none; }
        .login-box { background: rgba(255,255,255,0.04); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .login-box h1 { font-size: 2em; background: linear-gradient(45deg, #00d9ff, #00ff88); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .login-box p { color: #666; margin-bottom: 30px; }
        .login-box input { width: 100%; padding: 14px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; font-size: 1em; text-align: center; margin-bottom: 15px; }
        .login-box input:focus { outline: none; border-color: #00d9ff; }
        .login-box button { width: 100%; padding: 14px; background: linear-gradient(135deg, #00d9ff, #00ff88); border: none; border-radius: 10px; color: #000; font-weight: 700; font-size: 1em; cursor: pointer; }
        .login-box .error { color: #ff6b6b; margin-top: 10px; display: none; }
        .top-nav { background: rgba(0,0,0,0.3); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .logo { font-size: 1.4em; font-weight: 700; background: linear-gradient(45deg, #00d9ff, #00ff88); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-tabs { display: flex; gap: 5px; flex-wrap: wrap; }
        .nav-tab { padding: 8px 16px; background: transparent; border: none; border-radius: 6px; color: #666; font-size: 0.85em; cursor: pointer; transition: all 0.2s; }
        .nav-tab.active { background: rgba(0,217,255,0.15); color: #00d9ff; }
        .nav-tab:hover:not(.active) { color: #fff; background: rgba(255,255,255,0.05); }
        .last-update { font-size: 0.75em; color: #666; }
        .main-content { padding: 20px; display: none; }
        .main-content.visible { display: block; }
        .section { display: none; }
        .section.active { display: block; }
        .big-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        @media (min-width: 768px) { .big-stats { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1200px) { .big-stats { grid-template-columns: repeat(6, 1fr); } }
        .stat-card { background: rgba(255,255,255,0.04); border-radius: 12px; padding: 16px; text-align: center; position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.cyan::before { background: linear-gradient(90deg, #00d9ff, #00b4d8); }
        .stat-card.green::before { background: linear-gradient(90deg, #00ff88, #00cc6a); }
        .stat-card.purple::before { background: linear-gradient(90deg, #9966ff, #7c3aed); }
        .stat-card.orange::before { background: linear-gradient(90deg, #ff9f40, #f59e0b); }
        .stat-card.red::before { background: linear-gradient(90deg, #ff6b6b, #ef4444); }
        .stat-card.yellow::before { background: linear-gradient(90deg, #feca57, #eab308); }
        .stat-card h4 { font-size: 0.7em; color: #888; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 1.6em; font-weight: 700; }
        .stat-card .value.cyan { color: #00d9ff; }
        .stat-card .value.green { color: #00ff88; }
        .stat-card .value.purple { color: #9966ff; }
        .stat-card .value.orange { color: #ff9f40; }
        .stat-card .value.red { color: #ff6b6b; }
        .stat-card .value.yellow { color: #feca57; }
        .stat-card .sub { font-size: 0.75em; color: #666; margin-top: 4px; }
        .grid { display: grid; gap: 15px; margin-bottom: 15px; }
        .grid-2 { grid-template-columns: 1fr; }
        .grid-3 { grid-template-columns: 1fr; }
        @media (min-width: 900px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 1100px) { .grid-3 { grid-template-columns: 1fr 1fr 1fr; } }
        .card { background: rgba(255,255,255,0.04); border-radius: 14px; padding: 18px; }
        .card h2 { font-size: 0.9em; color: #00d9ff; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; gap: 8px; }
        .card h2 .icon { font-size: 1.1em; }
        .chart-container { position: relative; height: 280px; }
        .chart-container.tall { height: 350px; }
        .chart-container.short { height: 200px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { color: #00d9ff; font-weight: 600; font-size: 0.75em; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,0.02); }
        .text-right { text-align: right; }
        .scroll-table { max-height: 320px; overflow-y: auto; }
        .scroll-table::-webkit-scrollbar { width: 5px; }
        .scroll-table::-webkit-scrollbar-thumb { background: rgba(0,217,255,0.3); border-radius: 3px; }
        .alert-card { border-radius: 10px; padding: 14px; margin-bottom: 10px; display: flex; align-items: flex-start; gap: 12px; }
        .alert-card.success { background: rgba(0,255,136,0.08); border-left: 3px solid #00ff88; }
        .alert-card.warning { background: rgba(254,202,87,0.08); border-left: 3px solid #feca57; }
        .alert-card.danger { background: rgba(255,107,107,0.08); border-left: 3px solid #ff6b6b; }
        .alert-card.info { background: rgba(0,217,255,0.08); border-left: 3px solid #00d9ff; }
        .alert-card .icon { font-size: 1.3em; }
        .alert-card .content { flex: 1; }
        .alert-card .title { font-weight: 600; margin-bottom: 4px; }
        .alert-card .desc { font-size: 0.85em; color: #888; line-height: 1.4; }
        .category-bar { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.8em; }
        .category-bar .name { width: 100px; color: #ccc; }
        .category-bar .bar-bg { flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden; margin: 0 10px; }
        .category-bar .bar { height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 0.85em; font-weight: 600; }
        .category-bar .kg { width: 100px; text-align: right; color: #888; }
        .search-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px 16px; display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .search-box input, .search-box select { flex: 1; min-width: 120px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 8px 12px; color: #fff; font-size: 0.9em; }
        .search-box input::placeholder { color: #666; }
        .search-box button { background: linear-gradient(135deg, #00d9ff, #00ff88); border: none; border-radius: 6px; padding: 8px 20px; color: #000; font-weight: 600; cursor: pointer; }
        .search-box button.secondary { background: rgba(255,255,255,0.1); color: #fff; }
        .filter-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .filter-row label { color: #888; font-size: 0.8em; }
        .filter-row input, .filter-row select { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 6px 10px; color: #fff; font-size: 0.85em; }
        .filter-row input[type="number"] { width: 80px; }
        .filter-row input[type="date"] { width: 140px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a2e; border-radius: 16px; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 24px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .modal-header h3 { font-size: 1.3em; color: #00d9ff; }
        .modal-close { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2em; }
        .year-selector { display: flex; gap: 5px; margin-left: auto; }
        .year-btn { padding: 4px 12px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: #888; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .year-btn.active { background: #00d9ff; color: #000; border-color: #00d9ff; }
        .insight-box { background: linear-gradient(135deg, rgba(0,255,136,0.08), rgba(0,217,255,0.05)); border-left: 3px solid #00ff88; border-radius: 0 10px 10px 0; padding: 14px; margin-bottom: 10px; font-size: 0.85em; }
        .insight-box.warning { border-color: #feca57; background: linear-gradient(135deg, rgba(254,202,87,0.08), rgba(255,159,64,0.05)); }
        .insight-box.danger { border-color: #ff6b6b; background: linear-gradient(135deg, rgba(255,107,107,0.08), rgba(255,99,132,0.05)); }
        .insight-box strong { color: #00d9ff; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; }
        .badge.green { background: rgba(0,255,136,0.2); color: #00ff88; }
        .badge.red { background: rgba(255,107,107,0.2); color: #ff6b6b; }
        .badge.yellow { background: rgba(254,202,87,0.2); color: #feca57; }
        .badge.cyan { background: rgba(0,217,255,0.2); color: #00d9ff; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #00d9ff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .footer { text-align: center; padding: 30px 20px; color: #444; font-size: 0.8em; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 30px; }
        .footer a { color: #00d9ff; text-decoration: none; }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .tab-btn { padding: 6px 14px; background: transparent; border: none; color: #666; cursor: pointer; border-radius: 4px; font-size: 0.85em; }
        .tab-btn.active { background: rgba(0,217,255,0.15); color: #00d9ff; }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>PAJU Dashboard</h1>
            <p>Introdu parola pentru acces</p>
            <input type="password" id="passwordInput" placeholder="Parola..." onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Conectare</button>
            <div class="error" id="loginError">Parola gresita!</div>
        </div>
    </div>

    <nav class="top-nav">
        <div class="logo">PAJU Dashboard</div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('overview')">Sumar</button>
            <button class="nav-tab" onclick="showSection('compare')">2024 vs 2025</button>
            <button class="nav-tab" onclick="showSection('partners')">Parteneri</button>
            <button class="nav-tab" onclick="showSection('waste')">Deseuri</button>
            <button class="nav-tab" onclick="showSection('geo')">Regiuni</button>
            <button class="nav-tab" onclick="showSection('predictions')">Predictii</button>
            <button class="nav-tab" onclick="showSection('stats')">Statisztika</button>
        </div>
        <div class="last-update">Actualizat: <span id="lastUpdate">...</span></div>
    </nav>

    <div class="main-content" id="mainContent">
        <!-- OVERVIEW -->
        <div id="section-overview" class="section active">
            <div class="big-stats" id="bigStats">
                <div class="stat-card cyan"><h4>Rulaj Total</h4><div class="value cyan" id="totalValue">...</div><div class="sub">RON</div></div>
                <div class="stat-card green"><h4>Tranzactii</h4><div class="value green" id="totalTrans">...</div></div>
                <div class="stat-card purple"><h4>Parteneri Activi</h4><div class="value purple" id="totalPartners">...</div></div>
                <div class="stat-card orange"><h4>Medie/Zi</h4><div class="value orange" id="avgDay">...</div><div class="sub">RON</div></div>
                <div class="stat-card yellow"><h4>Zile Lucratoare</h4><div class="value yellow" id="workDays">...</div></div>
                <div class="stat-card red"><h4>Ultimele 30 Zile</h4><div class="value red" id="last30">...</div><div class="sub">RON</div></div>
            </div>
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üìä</span> Comparatie Anuala</h2><div class="chart-container"><canvas id="yearCompareChart"></canvas></div></div>
                <div class="card"><h2><span class="icon">üìà</span> Tendinte Lunare</h2><div class="chart-container"><canvas id="monthlyTrendChart"></canvas></div></div>
            </div>
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üèÜ</span> Top 10 Parteneri</h2><div class="scroll-table"><table><thead><tr><th>#</th><th>Nume</th><th>Oras</th><th class="text-right">Valoare</th><th class="text-right">Vizite</th><th class="text-right">Ultima Vizita</th></tr></thead><tbody id="topPartnersTable"></tbody></table></div></div>
                <div class="card"><h2><span class="icon">üì¶</span> Categorii Deseuri</h2><div id="categoryBars"></div></div>
            </div>
        </div>

        <!-- COMPARE 2024 vs 2025 -->
        <div id="section-compare" class="section">
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üìä</span> 2024 vs 2025 - Rulaj Lunar</h2><div class="chart-container tall"><canvas id="compareValueChart"></canvas></div></div>
                <div class="card"><h2><span class="icon">üë•</span> 2024 vs 2025 - Parteneri Unici/Luna</h2><div class="chart-container tall"><canvas id="comparePartnersChart"></canvas></div></div>
            </div>
            <div class="card">
                <h2><span class="icon">üìã</span> Comparatie Lunara Detaliata</h2>
                <div class="scroll-table"><table><thead><tr><th>Luna</th><th class="text-right">2024 Rulaj</th><th class="text-right">2025 Rulaj</th><th class="text-right">Dif. Rulaj</th><th class="text-right">2024 Parteneri</th><th class="text-right">2025 Parteneri</th><th class="text-right">Dif. Parteneri</th></tr></thead><tbody id="monthCompareBody"></tbody></table></div>
            </div>
            <div class="grid grid-3">
                <div class="card"><h2><span class="icon">üí°</span> Concluzii</h2><div id="compareInsights"></div></div>
                <div class="card">
                    <h2><span class="icon">üìä</span> Tipare Saptamanale <div class="year-selector"><button class="year-btn active" onclick="loadWeekday(2024)">2024</button><button class="year-btn" onclick="loadWeekday(2025)">2025</button><button class="year-btn" onclick="loadWeekday(null)">Total</button></div></h2>
                    <div class="chart-container"><canvas id="weekdayChart"></canvas></div>
                </div>
                <div class="card"><h2><span class="icon">ü•ß</span> Compozitie Materiale (Total)</h2><div class="chart-container"><canvas id="materialPieChart"></canvas></div></div>
            </div>
        </div>

        <!-- PARTNERS -->
        <div id="section-partners" class="section">
            <div class="search-box">
                <input type="text" id="partnerSearch" placeholder="Cauta dupa nume sau CNP...">
                <button onclick="searchPartners()">Cauta</button>
            </div>

            <div class="card" style="margin-bottom:15px;">
                <h2><span class="icon">üîç</span> Filtru Avansat</h2>
                <div class="filter-row">
                    <label>De la:</label><input type="date" id="filterDateFrom" value="2024-01-01">
                    <label>Pana la:</label><input type="date" id="filterDateTo" value="2025-12-31">
                    <label>Min vizite:</label><input type="number" id="filterMinVisits" value="1" min="1">
                    <label>Max vizite:</label><input type="number" id="filterMaxVisits" value="9999" min="1">
                    <label>Categorie:</label>
                    <select id="filterCategory"><option value="">Toate</option><option value="Cupru">Cupru</option><option value="Alama">Alama</option><option value="Aluminiu">Aluminiu</option><option value="Fier">Fier</option><option value="Inox">Inox</option><option value="DEEE">DEEE</option><option value="Acumulatori">Acumulatori</option></select>
                    <label>Min kg:</label><input type="number" id="filterMinKg" value="0" min="0">
                    <button onclick="applyAdvancedFilter()">Filtreaza</button>
                </div>
            </div>

            <div id="searchResults" style="display:none;" class="card">
                <h2><span class="icon">üîç</span> Rezultate (<span id="resultCount">0</span>)</h2>
                <div class="scroll-table"><table><thead><tr><th>Nume</th><th>Oras</th><th>Judet</th><th class="text-right">Valoare</th><th class="text-right">Vizite</th><th></th></tr></thead><tbody id="searchResultsBody"></tbody></table></div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="showPartnerTab('vip')">VIP (Top 20)</button>
                <button class="tab-btn" onclick="showPartnerTab('onetime')">O Singura Data</button>
                <button class="tab-btn" onclick="showPartnerTab('regulars')">Regulati</button>
                <button class="tab-btn" onclick="showPartnerTab('inactive')">Inactivi (60+ zile)</button>
                <button class="tab-btn" onclick="showPartnerTab('family')">Familii/Adresa</button>
                <button class="tab-btn" onclick="showPartnerTab('big')">Mari Furnizori</button>
            </div>

            <div id="partnerTab-vip" class="partner-tab">
                <div class="grid grid-2">
                    <div class="card"><h2><span class="icon">‚≠ê</span> Top 20 dupa Valoare</h2><div class="scroll-table"><table><thead><tr><th>Nume</th><th class="text-right">Valoare</th><th class="text-right">Vizite</th><th></th></tr></thead><tbody id="vipTable"></tbody></table></div></div>
                    <div class="card"><h2><span class="icon">üìä</span> Statistica VIP</h2><div id="vipStats"></div></div>
                </div>
            </div>

            <div id="partnerTab-onetime" class="partner-tab" style="display:none;">
                <div class="card" style="margin-bottom:15px;">
                    <h2><span class="icon">üîç</span> Filtru Vizitatori dupa Numar de Vizite</h2>
                    <div class="filter-row">
                        <label>De la:</label><input type="date" id="onetimeDateFrom" value="2024-01-01">
                        <label>Pana la:</label><input type="date" id="onetimeDateTo" value="2025-12-31">
                        <label>Numar vizite:</label>
                        <input type="number" id="onetimeVisitCount" value="1" min="1" max="500" style="width:70px;">
                        <span style="color:#888;font-size:0.85em;">(1-4: exact, 5+: max)</span>
                        <button onclick="loadOnetimeVisitors()">Cauta</button>
                    </div>
                </div>
                <div class="grid grid-2">
                    <div class="card">
                        <h2><span class="icon">üë§</span> Vizitatori (<span id="onetimeCount">0</span>)</h2>
                        <div class="scroll-table"><table><thead><tr><th>Nume</th><th>Oras</th><th class="text-right">Vizite</th><th class="text-right">Valoare</th><th></th></tr></thead><tbody id="onetimeTable"></tbody></table></div>
                    </div>
                    <div class="card">
                        <h2><span class="icon">üìä</span> Statistica</h2>
                        <div id="onetimeStats"></div>
                    </div>
                </div>
            </div>

            <div id="partnerTab-regulars" class="partner-tab" style="display:none;">
                <div class="grid grid-3">
                    <div class="card"><h2><span class="icon">üìÖ</span> Vizitatori Saptamanali</h2><p style="color:#888;font-size:0.8em;margin-bottom:10px;"><strong>Definitie:</strong> Parteneri care au venit in MIN 4 saptamani diferite in 2024 SI in 2025. (ex: cineva care a venit sapt 1 ian, sapt 3 ian, sapt 2 feb, sapt 1 mar in 2024 SI la fel in 2025)</p><div class="scroll-table"><table><thead><tr><th>Nume</th><th class="text-right">Vizite</th><th class="text-right">Valoare</th></tr></thead><tbody id="weeklyRegulars"></tbody></table></div></div>
                    <div class="card"><h2><span class="icon">üìÜ</span> Vizitatori Lunari</h2><p style="color:#888;font-size:0.8em;margin-bottom:10px;"><strong>Definitie:</strong> Parteneri care au venit in MIN 6 luni diferite in 2024 SI MIN 4 luni in 2025. (ex: ian, mar, apr, mai, iun, iul 2024 SI ian, feb, mar, apr 2025)</p><div class="scroll-table"><table><thead><tr><th>Nume</th><th class="text-right">Vizite</th><th class="text-right">Valoare</th></tr></thead><tbody id="monthlyRegulars"></tbody></table></div></div>
                    <div class="card"><h2><span class="icon">üîÑ</span> Vizitatori Anuali</h2><p style="color:#888;font-size:0.8em;margin-bottom:10px;"><strong>Definitie:</strong> Parteneri care au fost activi in AMBII ani (2024 SI 2025), cu cel putin 1 tranzactie in fiecare an. Ordonati dupa valoare.</p><div class="scroll-table"><table><thead><tr><th>Nume</th><th class="text-right">Vizite</th><th class="text-right">Valoare</th></tr></thead><tbody id="yearlyRegulars"></tbody></table></div></div>
                </div>
            </div>

            <div id="partnerTab-inactive" class="partner-tab" style="display:none;">
                <div class="card"><h2><span class="icon">üò¥</span> Parteneri Inactivi (60+ zile)</h2><div class="scroll-table"><table><thead><tr><th>Nume</th><th>Oras</th><th>Ultima Vizita</th><th class="text-right">Zile</th><th class="text-right">Valoare</th><th></th></tr></thead><tbody id="inactiveTable"></tbody></table></div></div>
            </div>

            <div id="partnerTab-family" class="partner-tab" style="display:none;">
                <div class="filter-row" style="margin-bottom:15px;">
                    <label>Kereses:</label>
                    <input type="text" id="familySearch" placeholder="Utca, varos, nev..." style="width:200px;">
                    <label>Anyag:</label>
                    <select id="familyCategory">
                        <option value="">Osszes</option>
                        <option value="Cupru">Cupru</option>
                        <option value="Alama">Alama</option>
                        <option value="Aluminiu">Aluminiu</option>
                        <option value="Fier">Fier</option>
                        <option value="Inox">Inox</option>
                        <option value="DEEE">DEEE</option>
                        <option value="Acumulatori">Acumulatori</option>
                    </select>
                    <button onclick="loadFamilyData()">Keress</button>
                </div>
                <div class="grid grid-2">
                    <div class="card"><h2><span class="icon">üè†</span> Aceeasi Adresa (Oras + Strada)</h2><p style="color:#888;font-size:0.8em;margin-bottom:10px;">Posibili duplicati sau familie la aceeasi adresa</p><div class="scroll-table"><table><thead><tr><th>Adresa</th><th>Parteneri</th><th class="text-right">Valoare Comb.</th></tr></thead><tbody id="sameAddressTable"></tbody></table></div></div>
                    <div class="card"><h2><span class="icon">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Acelasi Nume Familie + Oras</h2><p style="color:#888;font-size:0.8em;margin-bottom:10px;"><span class="badge cyan">EVIDENTIATI</span> = aceeasi strada</p><div class="scroll-table"><table><thead><tr><th>Familie</th><th>Oras</th><th>Parteneri</th><th class="text-right">Valoare</th></tr></thead><tbody id="sameFamilyTable"></tbody></table></div></div>
                </div>
            </div>

            <div id="partnerTab-big" class="partner-tab" style="display:none;">
                <div class="filter-row">
                    <label>Categorie:</label>
                    <select id="bigCategory"><option value="Cupru">Cupru</option><option value="Alama">Alama</option><option value="Aluminiu">Aluminiu</option><option value="Fier">Fier</option><option value="Inox">Inox</option><option value="DEEE">DEEE</option><option value="Acumulatori">Acumulatori</option></select>
                    <label>Judet:</label>
                    <select id="bigCounty"><option value="">Toate</option></select>
                    <label>Oras:</label>
                    <input type="text" id="bigCity" placeholder="Oras..." style="width:120px;">
                    <label>Min kg:</label><input type="number" id="bigMinKg" value="100" min="1" style="width:80px;">
                    <label>Min vizite:</label><input type="number" id="bigMinVisits" value="2" min="1" style="width:60px;">
                    <label>An:</label>
                    <select id="bigYear"><option value="">Toti anii</option><option value="2024">2024</option><option value="2025">2025</option></select>
                    <button onclick="loadBigSuppliers()">Cauta</button>
                </div>
                <div class="card"><h2><span class="icon">üíé</span> Mari Furnizori</h2><div class="scroll-table"><table><thead><tr><th>Nume</th><th>Oras</th><th>Judet</th><th class="text-right">Total kg</th><th class="text-right">Vizite</th><th class="text-right">Pret Mediu</th><th class="text-right">Valoare</th></tr></thead><tbody id="bigSuppliersTable"></tbody></table></div></div>
            </div>
        </div>

        <!-- WASTE -->
        <div id="section-waste" class="section">
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üì¶</span> Sumar Categorii (Total)</h2><div id="wasteCategoryBars"></div></div>
                <div class="card"><h2><span class="icon">ü•ß</span> Distributie (kg)</h2><div class="chart-container"><canvas id="wastePieChart"></canvas></div></div>
            </div>
            <div class="card"><h2><span class="icon">üìà</span> Tendinte Categorii (Date Reale Lunare)</h2><div class="chart-container tall"><canvas id="wasteTrendChart"></canvas></div></div>
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üèÜ</span> Cel Mai Bun Neferos pe Luna (kg)</h2><div class="scroll-table"><table><thead><tr><th>Luna</th><th>Al</th><th>Cu</th><th>Alama</th><th>Inox</th><th class="text-right">Castigator</th></tr></thead><tbody id="bestNonFerrousTable"></tbody></table></div></div>
                <div class="card"><h2><span class="icon">üí∞</span> Statistici Preturi (RON/kg)</h2><div class="scroll-table"><table><thead><tr><th>Tip Deseu</th><th class="text-right">Min</th><th class="text-right">Max</th><th class="text-right">Medie</th></tr></thead><tbody id="priceStatsTable"></tbody></table></div></div>
            </div>
        </div>

        <!-- GEO -->
        <div id="section-geo" class="section">
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üó∫Ô∏è</span> Distributie pe Judete</h2><div id="countyBars"></div></div>
                <div class="card"><h2><span class="icon">üìä</span> Statistica Judete</h2><div class="chart-container"><canvas id="countyChart"></canvas></div></div>
            </div>
            <div class="card"><h2><span class="icon">üèôÔ∏è</span> Top Orase</h2><div class="scroll-table"><table><thead><tr><th>Oras</th><th>Judet</th><th class="text-right">Parteneri</th><th class="text-right">Tranzactii</th><th class="text-right">Valoare</th></tr></thead><tbody id="cityTable"></tbody></table></div></div>
            <div class="card"><h2><span class="icon">üë•</span> Analiza pe Grupe de Varsta</h2><div class="chart-container"><canvas id="ageChart"></canvas></div></div>
        </div>

        <!-- PREDICTIONS -->
        <div id="section-predictions" class="section">
            <div class="card"><h2><span class="icon">üîÆ</span> Grafic Predictie</h2><div class="chart-container tall"><canvas id="predictionChart"></canvas></div></div>
            <div class="card">
                <h2><span class="icon">üìä</span> Metodologie Predictie</h2>
                <div class="alert-card info">
                    <div class="icon">üìê</div>
                    <div class="content">
                        <div class="title">Cum calculam predictiile?</div>
                        <div class="desc" id="predictionMethodology"></div>
                    </div>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="card"><h2><span class="icon">üìä</span> Estimare Decembrie 2025</h2><div class="big-stats" style="margin:0;"><div class="stat-card yellow"><h4>Rulaj Estimat</h4><div class="value yellow" id="predDec">...</div></div><div class="stat-card cyan"><h4>Tranzactii Est.</h4><div class="value cyan" id="predTrans">...</div></div></div><div id="decAlert" style="margin-top:15px;"></div></div>
                <div class="card"><h2><span class="icon">üìà</span> Perspectiva Q1 2026</h2><div class="big-stats" style="margin:0;"><div class="stat-card green"><h4>Estimare Ianuarie</h4><div class="value green" id="predJan">...</div></div><div class="stat-card purple"><h4>Total Q1 Est.</h4><div class="value purple" id="predQ1">...</div></div></div><div id="janAlert" style="margin-top:15px;"></div></div>
            </div>
            <div class="card"><h2><span class="icon">üö®</span> Alerte si Recomandari</h2><div id="alertsContainer"></div></div>
        </div>

        <!-- STATISTICI -->
        <div id="section-stats" class="section">
            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üèÜ</span> TOP per Categorie - Greutate (kg)</h2>
                    <p style="color:#888;font-size:0.8em;margin-bottom:10px;">Partenerul cu cele mai multe kg livrate per categorie</p>
                    <div class="scroll-table"><table><thead><tr><th>Categorie</th><th>Partener</th><th class="text-right">Total kg</th></tr></thead><tbody id="topWeightTable"></tbody></table></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üí∞</span> TOP per Categorie - Valoare (RON)</h2>
                    <p style="color:#888;font-size:0.8em;margin-bottom:10px;">Cea mai mare valoare per categorie</p>
                    <div class="scroll-table"><table><thead><tr><th>Categorie</th><th>Partener</th><th class="text-right">Total RON</th></tr></thead><tbody id="topValueTable"></tbody></table></div>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üìâ</span> Cei Mai Mici Fideli per Categorie</h2>
                    <p style="color:#888;font-size:0.8em;margin-bottom:10px;">Min 3 vizite, dar cea mai mica suma totala</p>
                    <div class="scroll-table"><table><thead><tr><th>Categorie</th><th>Partener</th><th class="text-right">Vizite</th><th class="text-right">Total RON</th></tr></thead><tbody id="bottomValueTable"></tbody></table></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üéØ</span> Parteneri Consistenti</h2>
                    <p style="color:#888;font-size:0.8em;margin-bottom:10px;">Aduc mereu aprox. aceeasi cantitate (deviatie standard mica)</p>
                    <div class="scroll-table"><table><thead><tr><th>Partener</th><th class="text-right">Vizite</th><th class="text-right">Media kg</th><th class="text-right">Dev.Std</th></tr></thead><tbody id="consistentTable"></tbody></table></div>
                </div>
            </div>
            <div class="grid grid-3">
                <div class="card">
                    <h2><span class="icon">üìÖ</span> Cea Mai Buna Perioada</h2>
                    <div id="bestPeriod" style="font-size:1.1em;"></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üòÑ</span> Nume Amuzante</h2>
                    <div id="funnyNames"></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üó∫Ô∏è</span> Localitati Ciudate</h2>
                    <div id="unusualCities"></div>
                </div>
            </div>
            <div class="card">
                <h2><span class="icon">üéÑ</span> Analiza Sarbatori</h2>
                <p style="color:#888;font-size:0.8em;margin-bottom:10px;">Paste Ortodox, Craciun, Mos Nicolae - comparatie inainte/dupa sarbatoare</p>
                <div class="scroll-table"><table><thead><tr><th>Sarbatoare</th><th>Perioada</th><th class="text-right">Tranzactii</th><th class="text-right">Valoare RON</th><th class="text-right">vs Inainte</th><th>Top Categorii</th></tr></thead><tbody id="holidaysTable"></tbody></table></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="partnerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalPartnerName">Profil Partener</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"><div class="loading">Se incarca...</div></div>
        </div>
    </div>

    <footer class="footer">Powered by <strong>zYztem & Claude</strong> | <a href="https://github.com/ebastyan/intern" target="_blank">GitHub</a></footer>

    <script>
        function checkPassword() {
            if (document.getElementById('passwordInput').value === 'war') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('visible');
                loadAllData();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        let monthlyData = null, wasteData = null, weekdayChart = null;
        const monthNames = ['Ian', 'Feb', 'Mar', 'Apr', 'Mai', 'Iun', 'Iul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthNamesFull = ['Ianuarie', 'Februarie', 'Martie', 'Aprilie', 'Mai', 'Iunie', 'Iulie', 'August', 'Septembrie', 'Octombrie', 'Noiembrie', 'Decembrie'];
        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

        function fmt(n) { return n.toLocaleString('ro-RO', {maximumFractionDigits: 0}); }
        function fmtDec(n) { return n.toLocaleString('ro-RO', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');
            event.target.classList.add('active');
        }

        function showPartnerTab(tab) {
            document.querySelectorAll('.partner-tab').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tabs .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('partnerTab-' + tab).style.display = 'block';
            event.target.classList.add('active');
        }

        async function loadAllData() {
            try {
                const [overview, waste, county, yearly, data, topPartners, wasteTypes] = await Promise.all([
                    fetch('/api/analytics?type=overview').then(r => r.json()),
                    fetch('/api/waste?type=categories').then(r => r.json()),
                    fetch('/api/analytics?type=county').then(r => r.json()),
                    fetch('/api/analytics?type=yearly').then(r => r.json()),
                    fetch('/api/data').then(r => r.json()),
                    fetch('/api/partners?top=20').then(r => r.json()),
                    fetch('/api/waste?type=types').then(r => r.json())
                ]);

                monthlyData = data;
                wasteData = waste;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ro-RO');

                initOverview(overview, data, topPartners);
                initCompare(data, yearly);
                initWaste(waste, wasteTypes);
                initGeo(county);
                initPredictions(data, yearly);
                initPartners(topPartners);
                initStats();
            } catch (e) {
                console.error('Error:', e);
                document.getElementById('totalValue').textContent = 'Eroare!';
            }
        }

        function initOverview(overview, monthly, topPartners) {
            document.getElementById('totalValue').textContent = fmt(overview.overview.total_value);
            document.getElementById('totalTrans').textContent = fmt(overview.overview.total_transactions);
            document.getElementById('totalPartners').textContent = fmt(overview.overview.unique_partners);
            document.getElementById('avgDay').textContent = fmt(overview.overview.avg_per_day);
            document.getElementById('workDays').textContent = overview.overview.working_days;
            document.getElementById('last30').textContent = fmt(overview.last_30_days.value);

            if (monthly && monthly.years) {
                const years = Object.keys(monthly.years).sort();
                const yearRawData = years.map(y => ({ year: y, rulaj: monthly.years[y].summary.total_value, tranz: monthly.years[y].summary.transactions, zile: monthly.years[y].summary.working_days }));
                new Chart(document.getElementById('yearCompareChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Rulaj', 'Tranzactii', 'Zile Lucr.'],
                        datasets: years.map((y, i) => ({
                            label: y,
                            data: [monthly.years[y].summary.total_value/1e6, monthly.years[y].summary.transactions/1000, monthly.years[y].summary.working_days],
                            backgroundColor: i===0 ? 'rgba(0,217,255,0.7)' : 'rgba(0,255,136,0.7)',
                            borderRadius: 6,
                            rawValues: [monthly.years[y].summary.total_value, monthly.years[y].summary.transactions, monthly.years[y].summary.working_days]
                        }))
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#fff' } },
                            tooltip: {
                                callbacks: {
                                    label: ctx => {
                                        const raw = ctx.dataset.rawValues[ctx.dataIndex];
                                        const label = ctx.dataset.label;
                                        if (ctx.dataIndex === 0) return label + ': ' + fmt(raw) + ' RON';
                                        if (ctx.dataIndex === 1) return label + ': ' + fmt(raw) + ' tranzactii';
                                        return label + ': ' + raw + ' zile';
                                    }
                                }
                            }
                        }
                    }
                });

                const allMonths = [];
                years.forEach(y => Object.keys(monthly.years[y].months).sort().forEach(m => allMonths.push({ label: monthNames[parseInt(m)-1] + "'" + y.slice(2), value: monthly.years[y].months[m].summary.total_value })));
                new Chart(document.getElementById('monthlyTrendChart'), {
                    type: 'line',
                    data: { labels: allMonths.map(m => m.label), datasets: [{ label: 'Rulaj Lunar (RON)', data: allMonths.map(m => m.value), borderColor: '#00d9ff', backgroundColor: 'rgba(0,217,255,0.1)', fill: true, tension: 0.3 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: ctx => 'Rulaj: ' + fmt(ctx.raw) + ' RON'
                                }
                            }
                        },
                        scales: { y: { ticks: { callback: v => fmt(v) } } }
                    }
                });
            }

            if (overview.by_category) {
                const container = document.getElementById('categoryBars');
                const max = overview.by_category[0]?.total_kg || 1;
                const colors = ['#ff6384', '#00d9ff', '#00ff88', '#9966ff', '#ffce56', '#ff9f40', '#4bc0c0', '#e7e9ed'];
                container.innerHTML = overview.by_category.slice(0, 8).map((c, i) => `<div class="category-bar"><span class="name">${c.category}</span><div class="bar-bg"><div class="bar" style="width:${(c.total_kg/max*100).toFixed(0)}%;background:${colors[i]};"></div></div><span class="kg">${fmt(c.total_kg)} kg</span></div>`).join('');
            }

            if (topPartners?.partners) {
                document.getElementById('topPartnersTable').innerHTML = topPartners.partners.slice(0,10).map((p,i) => {
                    let daysSince = '-';
                    if (p.last_visit) {
                        const lastDate = new Date(p.last_visit);
                        const today = new Date();
                        const diffDays = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
                        daysSince = diffDays + ' zile';
                    }
                    return `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${i+1}</td><td>${p.name}</td><td>${p.city||'-'}</td><td class="text-right">${fmt(p.total_value)}</td><td class="text-right">${p.visit_count}</td><td class="text-right">${daysSince}</td></tr>`;
                }).join('');
            }
        }

        function initCompare(monthly, yearly) {
            if (!monthly?.years) return;
            const years = Object.keys(monthly.years).sort();
            if (years.length < 2) return;

            const datasets = years.map((y, i) => ({
                label: y, data: monthNames.map((_, mi) => { const k = String(mi+1).padStart(2,'0'); return monthly.years[y].months[k]?.summary.total_value || null; }),
                borderColor: i===0 ? '#00d9ff' : '#00ff88', backgroundColor: i===0 ? 'rgba(0,217,255,0.1)' : 'rgba(0,255,136,0.1)', fill: true, tension: 0.3
            }));
            new Chart(document.getElementById('compareValueChart'), {
                type: 'line', data: { labels: monthNames, datasets },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#fff' } }, tooltip: { callbacks: {
                        label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw) + ' RON',
                        afterBody: items => { if (items.length >= 2 && items[0].raw && items[1].raw) { const d = items[1].raw - items[0].raw; return ['', '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'Diferenta: ' + (d>=0?'+':'') + fmt(d) + ' RON', 'Procent: ' + (d>=0?'+':'') + ((d/items[0].raw)*100).toFixed(1) + '%']; } return []; }
                    }}}
                }
            });

            const pDatasets = years.map((y, i) => ({
                label: y, data: monthNames.map((_, mi) => { const k = String(mi+1).padStart(2,'0'); return monthly.years[y].months[k]?.summary.unique_partners || null; }),
                borderColor: i===0 ? '#9966ff' : '#feca57', backgroundColor: i===0 ? 'rgba(153,102,255,0.1)' : 'rgba(254,202,87,0.1)', fill: true, tension: 0.3
            }));
            new Chart(document.getElementById('comparePartnersChart'), {
                type: 'line', data: { labels: monthNames, datasets: pDatasets },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#fff' } }, tooltip: { callbacks: {
                        label: ctx => ctx.dataset.label + ': ' + ctx.raw + ' parteneri',
                        afterBody: items => { if (items.length >= 2 && items[0].raw && items[1].raw) { const d = items[1].raw - items[0].raw; return ['', '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', 'Diferenta: ' + (d>=0?'+':'') + d + ' parteneri', 'Procent: ' + (d>=0?'+':'') + ((d/items[0].raw)*100).toFixed(1) + '%']; } return []; }
                    }}}
                }
            });

            const tbody = document.getElementById('monthCompareBody');
            tbody.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const k = String(i+1).padStart(2,'0');
                const m24 = monthly.years['2024']?.months[k], m25 = monthly.years['2025']?.months[k];
                const v24 = m24?.summary.total_value || 0, v25 = m25?.summary.total_value || 0;
                const p24 = m24?.summary.unique_partners || 0, p25 = m25?.summary.unique_partners || 0;
                // Rulaj difference %
                const ch = v24 && v25 ? ((v25-v24)/v24*100).toFixed(1) : '-';
                const chClass = ch !== '-' ? (parseFloat(ch) >= 0 ? 'color:#00ff88' : 'color:#ff6b6b') : '';
                // Partner difference % - separate column
                const pDiffPct = p24 && p25 ? ((p25-p24)/p24*100).toFixed(1) : '-';
                const pDiffClass = pDiffPct !== '-' ? (parseFloat(pDiffPct) >= 0 ? 'color:#00ff88' : 'color:#ff6b6b') : '';
                tbody.innerHTML += `<tr><td>${monthNamesFull[i]}</td><td class="text-right">${v24 ? fmt(v24) : '-'}</td><td class="text-right">${v25 ? fmt(v25) : '-'}</td><td class="text-right" style="${chClass}">${ch !== '-' ? (parseFloat(ch) >= 0 ? '+' : '') + ch + '%' : '-'}</td><td class="text-right">${p24 || '-'}</td><td class="text-right">${p25 || '-'}</td><td class="text-right" style="${pDiffClass}">${pDiffPct !== '-' ? (parseFloat(pDiffPct) >= 0 ? '+' : '') + pDiffPct + '%' : '-'}</td></tr>`;
            }

            const y24 = monthly.years['2024']?.summary, y25 = monthly.years['2025']?.summary;
            if (y24 && y25) {
                const yoy = ((y25.total_value - y24.total_value) / y24.total_value * 100).toFixed(1);
                document.getElementById('compareInsights').innerHTML = `<div class="insight-box ${parseFloat(yoy) < 0 ? 'danger' : ''}"><strong>YoY:</strong> ${yoy}%</div><div class="insight-box"><strong>2024 Best:</strong> Aprilie - 7.64M</div><div class="insight-box warning"><strong>August:</strong> Cea mai slaba luna (concedii)</div>`;
            }

            loadWeekday(null);

            if (wasteData?.categories) {
                new Chart(document.getElementById('materialPieChart'), {
                    type: 'doughnut',
                    data: { labels: wasteData.categories.slice(0,6).map(c => c.name), datasets: [{ data: wasteData.categories.slice(0,6).map(c => c.total_kg), backgroundColor: ['#ff6384', '#00d9ff', '#00ff88', '#9966ff', '#ffce56', '#ff9f40'], borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 10 } } } } }
                });
            }
        }

        let weekdayData2024 = null, weekdayData2025 = null;

        async function loadWeekday(year) {
            document.querySelectorAll('.year-selector .year-btn').forEach(b => b.classList.remove('active'));
            event?.target?.classList.add('active');

            // For TOTAL view, fetch both years for comparison
            if (!year) {
                const [d24, d25, dTotal] = await Promise.all([
                    fetch('/api/analytics?type=weekday&year=2024').then(r => r.json()),
                    fetch('/api/analytics?type=weekday&year=2025').then(r => r.json()),
                    fetch('/api/analytics?type=weekday').then(r => r.json())
                ]);
                weekdayData2024 = d24.weekday_patterns;
                weekdayData2025 = d25.weekday_patterns;

                const days = ['Luni', 'Marti', 'Miercuri', 'Joi', 'Vineri', 'Sambata'];
                if (weekdayChart) weekdayChart.destroy();
                weekdayChart = new Chart(document.getElementById('weekdayChart'), {
                    type: 'bar',
                    data: { labels: days.slice(0, dTotal.weekday_patterns.length), datasets: [{ label: 'Medie/Zi (RON)', data: dTotal.weekday_patterns.map(w => w.avg_per_day), backgroundColor: ['#00d9ff99', '#00ff8899', '#ffce5699', '#ff638499', '#9966ff99', '#ff9f4099'], borderRadius: 6 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Total 2024+2025', color: '#888' },
                            tooltip: {
                                callbacks: {
                                    label: ctx => 'Total: ' + fmt(ctx.raw) + ' RON/zi',
                                    afterLabel: ctx => {
                                        const idx = ctx.dataIndex;
                                        const v24 = weekdayData2024?.[idx]?.avg_per_day || 0;
                                        const v25 = weekdayData2025?.[idx]?.avg_per_day || 0;
                                        const diff = v25 - v24;
                                        const diffPct = v24 ? ((diff / v24) * 100).toFixed(1) : 0;
                                        const diffColor = diff >= 0 ? 'üü¢' : 'üî¥';
                                        return [
                                            '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                                            '2024: ' + fmt(v24) + ' RON/zi',
                                            '2025: ' + fmt(v25) + ' RON/zi',
                                            '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
                                            diffColor + ' Diferenta: ' + (diff >= 0 ? '+' : '') + fmt(diff) + ' RON',
                                            diffColor + ' Procent: ' + (diff >= 0 ? '+' : '') + diffPct + '%'
                                        ];
                                    }
                                }
                            }
                        },
                        scales: { y: { ticks: { callback: v => fmt(v) } } }
                    }
                });
            } else {
                const url = `/api/analytics?type=weekday&year=${year}`;
                const data = await fetch(url).then(r => r.json());
                if (data.weekday_patterns) {
                    const days = ['Luni', 'Marti', 'Miercuri', 'Joi', 'Vineri', 'Sambata'];
                    if (weekdayChart) weekdayChart.destroy();
                    weekdayChart = new Chart(document.getElementById('weekdayChart'), {
                        type: 'bar',
                        data: { labels: days.slice(0, data.weekday_patterns.length), datasets: [{ label: 'Medie/Zi (RON)', data: data.weekday_patterns.map(w => w.avg_per_day), backgroundColor: ['#00d9ff99', '#00ff8899', '#ffce5699', '#ff638499', '#9966ff99', '#ff9f4099'], borderRadius: 6 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: `Anul ${year}`, color: '#888' } }, scales: { y: { ticks: { callback: v => fmt(v) } } } }
                    });
                }
            }
        }

        async function initWaste(waste, wasteTypes) {
            if (!waste?.categories) return;
            const colors = ['#ff6384', '#00d9ff', '#00ff88', '#9966ff', '#ffce56', '#ff9f40', '#4bc0c0', '#e7e9ed', '#36a2eb', '#c9cbcf'];
            const max = waste.categories[0]?.total_kg || 1;
            document.getElementById('wasteCategoryBars').innerHTML = waste.categories.map((c, i) => `<div class="category-bar"><span class="name">${c.name}</span><div class="bar-bg"><div class="bar" style="width:${(c.total_kg/max*100).toFixed(0)}%;background:${colors[i%colors.length]};"></div></div><span class="kg">${fmt(c.total_kg)} kg</span></div>`).join('');

            new Chart(document.getElementById('wastePieChart'), {
                type: 'doughnut',
                data: { labels: waste.categories.slice(0,8).map(c => c.name), datasets: [{ data: waste.categories.slice(0,8).map(c => c.total_kg), backgroundColor: colors, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff' } } } }
            });

            const cats = ['Fier', 'Aluminiu', 'Cupru', 'DEEE'];
            const monthlyResults = await Promise.all(cats.map(c => fetch(`/api/waste?type=monthly&category=${c}`).then(r => r.json())));
            const allLabels = [];
            monthlyResults.forEach(r => r.monthly?.forEach(m => { const l = monthNames[m.month-1] + "'" + String(m.year).slice(2); if (!allLabels.includes(l)) allLabels.push(l); }));
            allLabels.sort((a,b) => { const [mA,yA] = [monthNames.indexOf(a.slice(0,3)), parseInt(a.slice(4))]; const [mB,yB] = [monthNames.indexOf(b.slice(0,3)), parseInt(b.slice(4))]; return yA !== yB ? yA - yB : mA - mB; });

            const datasets = monthlyResults.map((r, i) => {
                const data = new Array(allLabels.length).fill(null);
                r.monthly?.forEach(m => { const l = monthNames[m.month-1] + "'" + String(m.year).slice(2); const idx = allLabels.indexOf(l); if (idx >= 0) data[idx] = m.total_kg / 1000; });
                return { label: cats[i], data, borderColor: colors[i], backgroundColor: 'transparent', tension: 0.3 };
            });
            new Chart(document.getElementById('wasteTrendChart'), { type: 'line', data: { labels: allLabels, datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#fff' } } }, scales: { y: { ticks: { callback: v => v.toFixed(0) + ' t' } } } } });

            const nfCats = ['Aluminiu', 'Cupru', 'Alama', 'Inox'];
            const nfResults = await Promise.all(nfCats.map(c => fetch(`/api/waste?type=monthly&category=${c}`).then(r => r.json())));
            const monthlyBest = {};
            nfResults.forEach((r, i) => r.monthly?.forEach(m => { const k = `${m.year}-${String(m.month).padStart(2,'0')}`; if (!monthlyBest[k]) monthlyBest[k] = {}; monthlyBest[k][nfCats[i]] = m.total_kg; }));

            const bestTable = document.getElementById('bestNonFerrousTable');
            bestTable.innerHTML = '';
            Object.keys(monthlyBest).sort().reverse().slice(0, 12).forEach(k => {
                const [y, m] = k.split('-');
                const d = monthlyBest[k];
                const best = Object.entries(d).sort((a,b) => b[1] - a[1])[0];
                bestTable.innerHTML += `<tr><td>${monthNamesFull[parseInt(m)-1]} ${y}</td><td>${d.Aluminiu ? fmt(d.Aluminiu) : '-'}</td><td>${d.Cupru ? fmt(d.Cupru) : '-'}</td><td>${d.Alama ? fmt(d.Alama) : '-'}</td><td>${d.Inox ? fmt(d.Inox) : '-'}</td><td class="text-right"><span class="badge green">${best[0]}</span></td></tr>`;
            });

            if (wasteTypes?.types) {
                document.getElementById('priceStatsTable').innerHTML = wasteTypes.types.filter(t => t.price_range.min !== null).slice(0, 20).map(t => `<tr><td>${t.name}</td><td class="text-right">${t.price_range.min?.toFixed(2) || '-'}</td><td class="text-right">${t.price_range.max?.toFixed(2) || '-'}</td><td class="text-right">${t.price_range.avg?.toFixed(2) || '-'}</td></tr>`).join('');
            }
        }

        function initGeo(county) {
            if (!county?.by_county) return;
            const colors = ['#ff6384', '#00d9ff', '#00ff88', '#9966ff', '#ffce56', '#ff9f40'];
            const max = county.by_county[0]?.total_value || 1;
            document.getElementById('countyBars').innerHTML = county.by_county.slice(0, 10).map((c, i) => `<div class="category-bar"><span class="name">${c.county}</span><div class="bar-bg"><div class="bar" style="width:${(c.total_value/max*100).toFixed(0)}%;background:${colors[i%colors.length]};">${c.partner_count} part.</div></div><span class="kg">${fmt(c.total_value)}</span></div>`).join('');

            new Chart(document.getElementById('countyChart'), { type: 'pie', data: { labels: county.by_county.slice(0,6).map(c => c.county), datasets: [{ data: county.by_county.slice(0,6).map(c => c.total_value), backgroundColor: colors, borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff' } } } } });

            fetch('/api/analytics?type=city').then(r => r.json()).then(d => { if (d.by_city) document.getElementById('cityTable').innerHTML = d.by_city.slice(0, 20).map(c => `<tr><td>${c.city}</td><td>${c.county}</td><td class="text-right">${c.partner_count}</td><td class="text-right">${c.transaction_count}</td><td class="text-right">${fmt(c.total_value)}</td></tr>`).join(''); });

            fetch('/api/analytics?type=age').then(r => r.json()).then(d => { if (d.by_age_group) new Chart(document.getElementById('ageChart'), { type: 'bar', data: { labels: d.by_age_group.map(a => a.age_group), datasets: [{ label: 'Valoare (M RON)', data: d.by_age_group.map(a => a.total_value/1e6), backgroundColor: ['#ff6b6b', '#feca57', '#1dd1a1', '#48dbfb', '#a55eea', '#778ca3'], borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); });
        }

        function initPredictions(monthly, yearly) {
            if (!monthly?.years) return;
            const years = Object.keys(monthly.years).sort();
            const allData = [];
            years.forEach(y => Object.entries(monthly.years[y].months).sort((a,b) => a[0].localeCompare(b[0])).forEach(([m, d]) => allData.push({ label: monthNames[parseInt(m)-1] + "'" + y.slice(2), year: parseInt(y), month: parseInt(m), value: d.summary.total_value, trans: d.summary.transactions, partners: d.summary.unique_partners })));

            // Get data for both years for comparison
            const data2024 = allData.filter(d => d.year === 2024);
            const data2025 = allData.filter(d => d.year === 2025);

            // 2024 specific months
            const jan24 = data2024.find(d => d.month === 1);
            const feb24 = data2024.find(d => d.month === 2);
            const mar24 = data2024.find(d => d.month === 3);
            const apr24 = data2024.find(d => d.month === 4);
            const dec24 = data2024.find(d => d.month === 12);
            const nov24 = data2024.find(d => d.month === 11);

            // 2025 specific months
            const jan25 = data2025.find(d => d.month === 1);
            const feb25 = data2025.find(d => d.month === 2);
            const mar25 = data2025.find(d => d.month === 3);
            const apr25 = data2025.find(d => d.month === 4);

            const jan24Val = jan24?.value || 0;
            const feb24Val = feb24?.value || 0;
            const mar24Val = mar24?.value || 0;
            const apr24Val = apr24?.value || 0;
            const dec24Val = dec24?.value || 0;
            const nov24Val = nov24?.value || 0;
            const jan25Val = jan25?.value || 0;
            const feb25Val = feb25?.value || 0;
            const mar25Val = mar25?.value || 0;
            const apr25Val = apr25?.value || 0;

            // YoY trend analysis - compare same months between years
            // Get 2025 months from Aug onwards (most recent complete months)
            const aug25 = data2025.find(d => d.month === 8);
            const sep25 = data2025.find(d => d.month === 9);
            const oct25 = data2025.find(d => d.month === 10);
            const nov25 = data2025.find(d => d.month === 11);

            // Compare YoY for same months to get trend %
            const aug24 = data2024.find(d => d.month === 8);
            const sep24 = data2024.find(d => d.month === 9);
            const oct24 = data2024.find(d => d.month === 10);

            // Calculate YoY change % for recent months
            const yoyChanges = [];
            if (aug24?.value && aug25?.value) yoyChanges.push((aug25.value - aug24.value) / aug24.value * 100);
            if (sep24?.value && sep25?.value) yoyChanges.push((sep25.value - sep24.value) / sep24.value * 100);
            if (oct24?.value && oct25?.value) yoyChanges.push((oct25.value - oct24.value) / oct24.value * 100);
            const avgYoY = yoyChanges.length > 0 ? yoyChanges.reduce((a,b) => a+b, 0) / yoyChanges.length : -10;

            // Last 3 months trend within 2025
            const last3 = allData.slice(-3);
            const avgLast3 = last3.reduce((a,b) => a + b.value, 0) / 3;

            // Prediction Dec 2025: based on Dec 2024 + YoY trend
            const predDec = dec24Val * (1 + avgYoY / 100);

            // Jan 2026: based on Jan 2025 + YoY trend (Jan is WEAK!)
            const predJan = jan25Val * (1 + avgYoY / 100);

            // Feb 2026: based on Feb 2025 + YoY trend
            const predFeb = feb25Val * (1 + avgYoY / 100);

            // Mar 2026: based on Mar 2025 + YoY trend
            const predMar = mar25Val * (1 + avgYoY / 100);

            // Q1 estimate
            const predQ1 = predJan + predFeb + predMar;

            document.getElementById('predDec').textContent = fmt(Math.round(predDec));
            document.getElementById('predTrans').textContent = fmt(Math.round(predDec / 2400));
            document.getElementById('predJan').textContent = fmt(Math.round(predJan));
            document.getElementById('predQ1').textContent = fmt(Math.round(predQ1));

            // Calculate % change from Dec to Jan (historical pattern)
            const decToJanDrop24 = dec24Val > 0 ? ((jan25Val - dec24Val) / dec24Val * 100).toFixed(1) : 0;

            document.getElementById('predictionMethodology').innerHTML = `
                <p><strong style="color:#00d9ff;">Metodologie: Trend YoY (Aug-Oct 2025 vs 2024)</strong></p>
                <p style="margin:8px 0;color:#888;">Media schimbare YoY: <strong style="color:${avgYoY >= 0 ? '#00ff88' : '#ff6b6b'};">${avgYoY >= 0 ? '+' : ''}${avgYoY.toFixed(1)}%</strong></p>
                <table style="width:100%;margin:10px 0;font-size:0.85em;color:#aaa;border-collapse:collapse;">
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.1);"><th style="text-align:left;color:#00d9ff;padding:5px;">Luna</th><th style="text-align:right;padding:5px;">2024</th><th style="text-align:right;padding:5px;">2025</th><th style="text-align:right;padding:5px;">Predictie 2026</th></tr>
                    <tr><td style="padding:5px;">Decembrie</td><td style="text-align:right;padding:5px;">${fmt(dec24Val)}</td><td style="text-align:right;padding:5px;">-</td><td style="text-align:right;padding:5px;color:#feca57;">${fmt(Math.round(predDec))}</td></tr>
                    <tr style="background:rgba(255,107,107,0.1);"><td style="padding:5px;color:#ff6b6b;">Ianuarie ‚¨áÔ∏è</td><td style="text-align:right;padding:5px;">${fmt(jan24Val)}</td><td style="text-align:right;padding:5px;">${fmt(jan25Val)}</td><td style="text-align:right;padding:5px;color:#ff6b6b;">${fmt(Math.round(predJan))}</td></tr>
                    <tr style="background:rgba(255,107,107,0.1);"><td style="padding:5px;color:#ff6b6b;">Februarie</td><td style="text-align:right;padding:5px;">${fmt(feb24Val)}</td><td style="text-align:right;padding:5px;">${fmt(feb25Val)}</td><td style="text-align:right;padding:5px;color:#ff6b6b;">${fmt(Math.round(predFeb))}</td></tr>
                    <tr style="background:rgba(0,255,136,0.1);"><td style="padding:5px;color:#00ff88;">Martie ‚¨ÜÔ∏è</td><td style="text-align:right;padding:5px;">${fmt(mar24Val)}</td><td style="text-align:right;padding:5px;">${fmt(mar25Val)}</td><td style="text-align:right;padding:5px;color:#00ff88;">${fmt(Math.round(predMar))}</td></tr>
                </table>
                <p style="margin-top:10px;"><strong>Formula:</strong> Valoare luna 2025 √ó (1 + ${avgYoY.toFixed(1)}%)</p>
                <p style="color:#ff6b6b;margin-top:8px;"><strong>‚ö†Ô∏è Atentie:</strong> Dec‚ÜíIan scade cu ~${Math.abs(decToJanDrop24)}% (istoric)</p>
                <p style="color:#feca57;margin-top:10px;"><strong>Q1 2026 Total:</strong> ${fmt(Math.round(predQ1))} RON</p>`;

            document.getElementById('decAlert').innerHTML = `<div class="alert-card info"><div class="icon">üìä</div><div class="content"><div class="title">Trend YoY: ${avgYoY >= 0 ? '+' : ''}${avgYoY.toFixed(1)}%</div><div class="desc">Bazat pe Aug-Oct 2025 vs 2024</div></div></div>`;
            document.getElementById('janAlert').innerHTML = `<div class="alert-card danger"><div class="icon">‚ö†Ô∏è</div><div class="content"><div class="title">Ianuarie = Luna SLABA!</div><div class="desc">2024: ${fmt(jan24Val)} | 2025: ${fmt(jan25Val)} ‚Üí 2026: ~${fmt(Math.round(predJan))} RON</div></div></div>`;

            const labels = [...allData.map(d => d.label), "Dec'25", "Ian'26", "Feb'26", "Mar'26"];
            const actualData = [...allData.map(d => d.value), null, null, null, null];
            const predData = new Array(allData.length - 1).fill(null);
            predData.push(allData[allData.length-1].value, predDec, predJan, predFeb, predMar);

            new Chart(document.getElementById('predictionChart'), {
                type: 'line', data: { labels, datasets: [
                    { label: 'Rulaj Real (RON)', data: actualData, borderColor: '#00d9ff', backgroundColor: 'rgba(0,217,255,0.1)', fill: true, tension: 0.3 },
                    { label: 'Predictie (RON)', data: predData, borderColor: '#ff6b6b', borderDash: [5,5], backgroundColor: 'transparent', tension: 0.3, pointStyle: 'triangle', pointRadius: 6 }
                ]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': ' + fmt(Math.round(ctx.raw)) + ' RON'
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: { display: true, text: 'Rulaj Lunar (RON)', color: '#888' },
                            ticks: { callback: v => fmt(v) }
                        }
                    }
                }
            });

            const y24 = monthly.years['2024']?.summary, y25 = monthly.years['2025']?.summary;
            let alerts = '';
            if (y24 && y25) {
                const yoy = ((y25.total_value - y24.total_value) / y24.total_value * 100).toFixed(1);
                if (parseFloat(yoy) < 0) alerts += `<div class="alert-card danger"><div class="icon">üìâ</div><div class="content"><div class="title">Rulaj 2025 mai mic cu ${Math.abs(yoy)}%</div><div class="desc">Comparativ cu 2024</div></div></div>`;
            }
            alerts += `<div class="alert-card warning"><div class="icon">üò¥</div><div class="content"><div class="title">Parteneri inactivi</div><div class="desc">Multi parteneri nu au mai vizitat de 60+ zile</div></div></div>`;
            alerts += `<div class="alert-card success"><div class="icon">‚≠ê</div><div class="content"><div class="title">VIP-urile sunt stabile</div><div class="desc">Top 100 continua sa fie activi</div></div></div>`;
            document.getElementById('alertsContainer').innerHTML = alerts;
        }

        async function initStats() {
            try {
                const [tops, holidays] = await Promise.all([
                    fetch('/api/analytics?type=tops').then(r => r.json()),
                    fetch('/api/analytics?type=holidays').then(r => r.json())
                ]);

                // Top by weight
                if (tops.top_by_weight) {
                    document.getElementById('topWeightTable').innerHTML = Object.entries(tops.top_by_weight)
                        .map(([cat, p]) => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${cat}</td><td style="color:#00d9ff;">${p.name}</td><td class="text-right">${fmt(p.total_kg)}</td></tr>`).join('');
                }

                // Top by value
                if (tops.top_by_value) {
                    document.getElementById('topValueTable').innerHTML = Object.entries(tops.top_by_value)
                        .map(([cat, p]) => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${cat}</td><td style="color:#00d9ff;">${p.name}</td><td class="text-right">${fmt(p.total_value)}</td></tr>`).join('');
                }

                // Bottom by value
                if (tops.bottom_by_value) {
                    document.getElementById('bottomValueTable').innerHTML = Object.entries(tops.bottom_by_value)
                        .map(([cat, p]) => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${cat}</td><td style="color:#ff6b6b;">${p.name}</td><td class="text-right">${p.visits}</td><td class="text-right">${fmt(p.total_value)}</td></tr>`).join('');
                }

                // Consistent partners
                if (tops.consistent_partners) {
                    document.getElementById('consistentTable').innerHTML = tops.consistent_partners
                        .map(p => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td style="color:#00d9ff;">${p.name}</td><td class="text-right">${p.visits}</td><td class="text-right">${p.avg_weight.toFixed(1)}</td><td class="text-right">${p.std_weight.toFixed(2)}</td></tr>`).join('');
                }

                // Best period - show AVERAGE per day, not total!
                let periodHtml = '';
                if (tops.best_month) periodHtml += `<p><strong>Cea mai buna luna:</strong> ${tops.best_month.month} (media: ${fmt(tops.best_month.avg_per_day)} RON/zi)</p>`;
                if (tops.best_weekday) periodHtml += `<p><strong>Cea mai buna zi:</strong> ${tops.best_weekday.day} (media: ${fmt(tops.best_weekday.avg_per_day)} RON/zi)</p>`;
                document.getElementById('bestPeriod').innerHTML = periodHtml || 'Nu sunt date';

                // Funny names
                document.getElementById('funnyNames').innerHTML = tops.funny_names?.length
                    ? tops.funny_names.map(n => `<div style="padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.1);cursor:pointer;" onclick="showPartnerProfile('${n.cnp}')">${n.name} <span style="color:#888;font-size:0.85em;">(${n.city || '?'})</span></div>`).join('')
                    : '<p style="color:#888;">Nu am gasit nume amuzante</p>';

                // Unusual cities
                document.getElementById('unusualCities').innerHTML = tops.unusual_cities?.length
                    ? tops.unusual_cities.map(c => `<div style="padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.1);">${c}</div>`).join('')
                    : '<p style="color:#888;">Nu am gasit localitati ciudate</p>';

                // Holidays with before/after comparison
                if (holidays.holidays) {
                    document.getElementById('holidaysTable').innerHTML = Object.values(holidays.holidays)
                        .map(h => {
                            const topCats = h.top_categories?.map(c => `${c.name}: ${fmt(c.kg)} kg`).join(', ') || '-';
                            const vsBeforeHtml = h.vs_before ?
                                `<span style="color:${h.vs_before.diff_pct >= 0 ? '#00ff88' : '#ff6b6b'}">${h.vs_before.diff_pct >= 0 ? '+' : ''}${h.vs_before.diff_pct.toFixed(1)}%</span>` : '-';
                            return `<tr><td>${h.name}</td><td>${h.period}</td><td class="text-right">${h.transactions}</td><td class="text-right">${fmt(h.total_value)}</td><td class="text-right">${vsBeforeHtml}</td><td style="font-size:0.85em;">${topCats}</td></tr>`;
                        }).join('');
                }
            } catch (e) {
                console.error('Stats error:', e);
            }
        }

        async function initPartners(topPartners) {
            if (topPartners?.partners) {
                document.getElementById('vipTable').innerHTML = topPartners.partners.map(p => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${p.name}</td><td class="text-right">${fmt(p.total_value)}</td><td class="text-right">${p.visit_count}</td><td><button onclick="event.stopPropagation();showPartnerProfile('${p.cnp}')" style="background:#00d9ff;border:none;color:#000;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:0.75em;">Profil</button></td></tr>`).join('');
                const totalVip = topPartners.partners.reduce((a,p) => a + p.total_value, 0);
                document.getElementById('vipStats').innerHTML = `<div class="insight-box"><strong>Top 20 = ${fmt(totalVip)} RON</strong> (${(totalVip/118700000*100).toFixed(1)}% din total)</div>`;
            }

            Promise.all([fetch('/api/partners?regulars=weekly').then(r=>r.json()), fetch('/api/partners?regulars=monthly').then(r=>r.json()), fetch('/api/partners?regulars=yearly').then(r=>r.json())]).then(([w,m,y]) => {
                if (w.partners) document.getElementById('weeklyRegulars').innerHTML = w.partners.slice(0,30).map(p => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${p.name}</td><td class="text-right">${p.total_visits}</td><td class="text-right">${fmt(p.total_value)}</td></tr>`).join('');
                if (m.partners) document.getElementById('monthlyRegulars').innerHTML = m.partners.slice(0,30).map(p => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${p.name}</td><td class="text-right">${p.total_visits}</td><td class="text-right">${fmt(p.total_value)}</td></tr>`).join('');
                if (y.partners) document.getElementById('yearlyRegulars').innerHTML = y.partners.slice(0,30).map(p => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${p.name}</td><td class="text-right">${p.total_visits}</td><td class="text-right">${fmt(p.total_value)}</td></tr>`).join('');
            });

            fetch('/api/partners?inactive=60&limit=50').then(r => r.json()).then(d => {
                if (d.partners) document.getElementById('inactiveTable').innerHTML = d.partners.map(p => {
                    const days = p.days_inactive;
                    let daysText = days + ' zile';
                    if (days >= 365) {
                        const years = Math.floor(days / 365);
                        const months = Math.floor((days % 365) / 30);
                        daysText = years + ' an' + (years > 1 ? 'i' : '') + (months > 0 ? ' ' + months + ' luni' : '');
                    } else if (days >= 30) {
                        const months = Math.floor(days / 30);
                        const remainDays = days % 30;
                        daysText = months + ' lun' + (months > 1 ? 'i' : 'a') + (remainDays > 0 ? ' ' + remainDays + ' zile' : '');
                    }
                    return `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${p.name}</td><td>${p.city||'-'}</td><td>${p.last_visit}</td><td class="text-right">${daysText}</td><td class="text-right">${fmt(p.total_value)}</td><td><button onclick="event.stopPropagation();showPartnerProfile('${p.cnp}')" style="background:#00d9ff;border:none;color:#000;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:0.75em;">Profil</button></td></tr>`;
                }).join('');
            });
            // Load counties for big suppliers filter
            fetch('/api/analytics?type=county').then(r => r.json()).then(d => {
                if (d.by_county) {
                    const sel = document.getElementById('bigCounty');
                    d.by_county.forEach(c => { if (c.county) sel.innerHTML += `<option value="${c.county}">${c.county}</option>`; });
                }
            });

            loadFamilyData();

            // Load initial one-time visitors (exact 1 visit)
            loadOnetimeVisitors();
            // Load initial big suppliers
            loadBigSuppliers();
        }

        async function loadBigSuppliers() {
            const cat = document.getElementById('bigCategory').value;
            const county = document.getElementById('bigCounty').value;
            const city = document.getElementById('bigCity').value;
            const minKg = document.getElementById('bigMinKg').value;
            const minVis = document.getElementById('bigMinVisits').value;
            const year = document.getElementById('bigYear').value;
            let url = `/api/partners?big_suppliers=${cat}&min_kg=${minKg}&min_visits=${minVis}`;
            if (year) url += '&year=' + year;
            if (county) url += '&county=' + encodeURIComponent(county);
            if (city) url += '&city=' + encodeURIComponent(city);
            const d = await fetch(url).then(r => r.json());
            if (d.partners) document.getElementById('bigSuppliersTable').innerHTML = d.partners.map(p => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${p.name}</td><td>${p.city||'-'}</td><td>${p.county||'-'}</td><td class="text-right">${fmt(p.total_kg)}</td><td class="text-right">${p.visit_count}</td><td class="text-right">${fmtDec(p.avg_price)}</td><td class="text-right">${fmt(p.total_value)}</td></tr>`).join('');
        }

        async function loadFamilyData() {
            const search = document.getElementById('familySearch').value;
            const category = document.getElementById('familyCategory').value;
            let urlAddr = '/api/partners?same_address';
            let urlFam = '/api/partners?same_family';
            if (search) { urlAddr += '&search=' + encodeURIComponent(search); urlFam += '&search=' + encodeURIComponent(search); }
            if (category) { urlAddr += '&category=' + encodeURIComponent(category); urlFam += '&category=' + encodeURIComponent(category); }

            // Helper: format name with sex/age as clickable
            function formatPartner(name, cnp, sex, age) {
                const sexColor = sex === 'M' ? '#54a0ff' : '#ff6b9d';
                const sexLabel = sex === 'M' ? 'B' : (sex === 'F' ? 'F' : '?');
                const ageStr = age ? age : '?';
                return `<span onclick="showPartnerProfile('${cnp}')" style="cursor:pointer;color:#00d9ff;">${name} <span style="color:${sexColor};font-size:0.85em;">(${sexLabel}/${ageStr})</span></span>`;
            }

            // Load same address
            fetch(urlAddr).then(r => r.json()).then(d => {
                if (d.groups) {
                    document.getElementById('sameAddressTable').innerHTML = d.groups.map(g => {
                        const partners = g.names.map((name, i) => formatPartner(name, g.cnps[i], g.sexes?.[i], g.ages?.[i])).join(', ');
                        return `<tr><td>${g.city}, ${g.street}</td><td>${partners}</td><td class="text-right">${fmt(g.combined_value)}</td></tr>`;
                    }).join('');
                }
            });

            // Load same family
            fetch(urlFam).then(r => r.json()).then(d => {
                if (d.groups) {
                    document.getElementById('sameFamilyTable').innerHTML = d.groups.map(g => {
                        const partners = g.names.map((name, i) => formatPartner(name, g.cnps[i], g.sexes?.[i], g.ages?.[i])).join(', ');
                        const famLabel = g.same_street ? `<span class="badge cyan">${g.family_name}</span>` : g.family_name;
                        return `<tr><td>${famLabel}</td><td>${g.city}</td><td>${partners}</td><td class="text-right">${fmt(g.combined_value)}</td></tr>`;
                    }).join('');
                }
            });
        }

        async function searchPartners() {
            const q = document.getElementById('partnerSearch').value;
            if (!q || q.length < 2) return;
            const d = await fetch(`/api/partners?q=${encodeURIComponent(q)}&limit=50`).then(r => r.json());
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('resultCount').textContent = d.count || 0;
            document.getElementById('searchResultsBody').innerHTML = d.partners?.length ? d.partners.map(p => `<tr><td>${p.name}</td><td>${p.city||'-'}</td><td>${p.county||'-'}</td><td class="text-right">${fmt(p.total_value)}</td><td class="text-right">${p.visit_count}</td><td><button onclick="showPartnerProfile('${p.cnp}')" style="background:#00d9ff;border:none;color:#000;padding:4px 10px;border-radius:4px;cursor:pointer;">Profil</button></td></tr>`).join('') : '<tr><td colspan="6" style="text-align:center;color:#666;">Niciun rezultat</td></tr>';
        }

        async function applyAdvancedFilter() {
            const df = document.getElementById('filterDateFrom').value;
            const dt = document.getElementById('filterDateTo').value;
            const minV = document.getElementById('filterMinVisits').value;
            const maxV = document.getElementById('filterMaxVisits').value;
            const cat = document.getElementById('filterCategory').value;
            const minKg = document.getElementById('filterMinKg').value;
            const url = `/api/partners?filter=1&date_from=${df}&date_to=${dt}&min_visits=${minV}&max_visits=${maxV}${cat ? '&category='+cat : ''}&min_kg=${minKg}&limit=100`;
            const d = await fetch(url).then(r => r.json());
            document.getElementById('searchResults').style.display = 'block';
            document.getElementById('resultCount').textContent = d.count || 0;
            document.getElementById('searchResultsBody').innerHTML = d.partners?.length ? d.partners.map(p => `<tr><td>${p.name}</td><td>${p.city||'-'}</td><td>${p.county||'-'}</td><td class="text-right">${fmt(p.total_value)}${p.total_kg ? '<br><small style="color:#888;">'+fmt(p.total_kg)+' kg</small>' : ''}</td><td class="text-right">${p.visit_count}</td><td><button onclick="showPartnerProfile('${p.cnp}')" style="background:#00d9ff;border:none;color:#000;padding:4px 10px;border-radius:4px;cursor:pointer;">Profil</button></td></tr>`).join('') : '<tr><td colspan="6" style="text-align:center;color:#666;">Niciun rezultat</td></tr>';
        }

        async function loadOnetimeVisitors() {
            const df = document.getElementById('onetimeDateFrom').value;
            const dt = document.getElementById('onetimeDateTo').value;
            const visitCount = document.getElementById('onetimeVisitCount').value;
            const isExact = parseInt(visitCount) <= 4;

            const url = `/api/partners?filter=1&date_from=${df}&date_to=${dt}&min_visits=${isExact ? visitCount : 1}&max_visits=${visitCount}&limit=200`;
            const d = await fetch(url).then(r => r.json());

            document.getElementById('onetimeCount').textContent = d.count || 0;
            document.getElementById('onetimeTable').innerHTML = d.partners?.length
                ? d.partners.map(p => `<tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;"><td>${p.name}</td><td>${p.city||'-'}</td><td class="text-right">${p.visit_count}</td><td class="text-right">${fmt(p.total_value)}</td><td><button onclick="event.stopPropagation();showPartnerProfile('${p.cnp}')" style="background:#00d9ff;border:none;color:#000;padding:3px 8px;border-radius:4px;cursor:pointer;font-size:0.75em;">Profil</button></td></tr>`).join('')
                : '<tr><td colspan="5" style="text-align:center;color:#666;">Niciun rezultat</td></tr>';

            if (d.partners?.length) {
                const totalVal = d.partners.reduce((a,p) => a + p.total_value, 0);
                const avgVal = totalVal / d.partners.length;
                document.getElementById('onetimeStats').innerHTML = `
                    <div class="insight-box"><strong>Total parteneri:</strong> ${d.count}</div>
                    <div class="insight-box"><strong>Valoare totala:</strong> ${fmt(totalVal)} RON</div>
                    <div class="insight-box"><strong>Media/partener:</strong> ${fmt(avgVal)} RON</div>
                    <div class="insight-box warning"><strong>Potential pierdut:</strong> Daca revin 1x/luna = ${fmt(totalVal * 12)} RON/an</div>`;
            }
        }

        let currentPartnerCnp = null;
        let currentPartnerData = null;

        async function showPartnerProfile(cnp, wasteFilter = null) {
            currentPartnerCnp = cnp;
            const modal = document.getElementById('partnerModal');
            const content = document.getElementById('modalContent');
            modal.classList.add('active');
            content.innerHTML = '<div class="loading">Se incarca...</div>';

            const data = await fetch(`/api/partners?cnp=${cnp}`).then(r => r.json());
            if (data.error) { content.innerHTML = '<p style="color:#ff6b6b;">Partenerul nu a fost gasit</p>'; return; }
            currentPartnerData = data;

            document.getElementById('modalPartnerName').textContent = data.partner.name;
            const age = data.partner.birth_year ? (new Date().getFullYear() - data.partner.birth_year) : null;
            const gender = data.partner.sex === 'M' ? 'Barbat' : (data.partner.sex === 'F' ? 'Femeie' : '-');
            const lastVisit = data.summary.last_visit;
            const daysSince = lastVisit ? Math.floor((new Date() - new Date(lastVisit)) / 864e5) : '-';

            // Build waste filter options
            const wasteCategories = data.waste_breakdown.map(w => w.category);
            const wasteFilterHtml = `<select id="modalWasteFilter" onchange="filterPartnerTransactions()" style="background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);border-radius:4px;padding:4px 8px;color:#fff;font-size:0.85em;margin-left:10px;">
                <option value="">Toate categoriile</option>
                ${wasteCategories.map(c => `<option value="${c}" ${wasteFilter === c ? 'selected' : ''}>${c}</option>`).join('')}
            </select>`;

            let transHtml = '';
            let filteredTransactions = data.recent_transactions;

            for (const t of filteredTransactions.slice(0, 15)) {
                try {
                    const items = await fetch(`/api/transactions?document_id=${t.document_id}`).then(r => r.json());

                    // Apply waste filter if set
                    let filteredItems = items.items || [];
                    if (wasteFilter) {
                        filteredItems = filteredItems.filter(i => i.category === wasteFilter || i.waste_type?.includes(wasteFilter));
                    }

                    // Skip transaction if no matching items after filter
                    if (wasteFilter && filteredItems.length === 0) continue;

                    const itemsStr = filteredItems.map(i => `<span style="display:inline-block;background:rgba(0,217,255,0.1);padding:2px 6px;border-radius:4px;margin:2px;font-size:0.8em;">${i.waste_type}: ${fmt(i.weight_kg)}kg @ ${fmtDec(i.price_per_kg)} = ${fmt(i.value)} RON</span>`).join('') || '';
                    const tax = items.transaction ? (items.transaction.env_tax||0) + (items.transaction.income_tax||0) : 0;
                    transHtml += `<div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;margin-bottom:10px;"><div style="display:flex;justify-content:space-between;"><div><strong style="color:#00d9ff;">${t.date}</strong> <span style="color:#666;font-size:0.8em;">${t.document_id}</span></div><div style="text-align:right;"><div style="color:#00ff88;font-weight:600;">${fmt(t.gross_value)} RON brut</div>${tax > 0 ? `<div style="font-size:0.75em;color:#ff6b6b;">Taxe: ${fmt(tax)} RON</div>` : ''}<div style="font-size:0.8em;color:#feca57;">Net: ${fmt(t.net_paid)} RON (${t.payment_type})</div></div></div><div style="margin-top:6px;">${itemsStr || '<span style="color:#666;font-size:0.8em;">Fara detalii</span>'}</div></div>`;
                } catch(e) { transHtml += `<div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;margin-bottom:10px;"><strong>${t.date}</strong> - ${fmt(t.gross_value)} RON</div>`; }
            }

            content.innerHTML = `
                <div class="big-stats" style="margin-bottom:20px;">
                    <div class="stat-card cyan"><h4>Valoare Totala</h4><div class="value cyan">${fmt(data.summary.total_value)}</div><div class="sub">RON</div></div>
                    <div class="stat-card green"><h4>Vizite</h4><div class="value green">${data.summary.visit_count}</div></div>
                    <div class="stat-card purple"><h4>Net Platit</h4><div class="value purple">${fmt(data.summary.total_paid)}</div><div class="sub">RON</div></div>
                    <div class="stat-card orange"><h4>Zile de la Ultima</h4><div class="value orange">${daysSince}</div></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
                    <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:15px;">
                        <h4 style="color:#00d9ff;margin-bottom:12px;">Date Personale</h4>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Gen: <strong style="color:#fff;">${gender}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Varsta: <strong style="color:#fff;">${age ? age + ' ani' : '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Oras: <strong style="color:#fff;">${data.partner.city || '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Judet: <strong style="color:#fff;">${data.partner.county || '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Strada: <strong style="color:#fff;">${data.partner.street || '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Telefon: <strong style="color:#fff;">${data.partner.phone || '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;">CNP: <strong style="color:#fff;font-size:0.85em;">${data.partner.cnp}</strong></p>
                    </div>
                    <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:15px;">
                        <h4 style="color:#00d9ff;margin-bottom:12px;">Distributie Deseuri (Total)</h4>
                        ${data.waste_breakdown.slice(0, 6).map(w => `<div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="color:#888;">${w.category}:</span><span style="color:#fff;font-weight:600;">${fmt(w.total_kg)} kg = ${fmt(w.total_value)} RON</span></div>`).join('')}
                        <div style="border-top:1px solid rgba(255,255,255,0.1);margin-top:10px;padding-top:10px;">
                            <div style="display:flex;justify-content:space-between;"><span style="color:#888;">Prima vizita:</span><span style="color:#00d9ff;">${data.summary.first_visit || '-'}</span></div>
                            <div style="display:flex;justify-content:space-between;margin-top:4px;"><span style="color:#888;">Ultima vizita:</span><span style="color:#00ff88;">${data.summary.last_visit || '-'}</span></div>
                        </div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;margin-bottom:15px;">
                    <h4 style="color:#00d9ff;">Tranzactii Detaliate</h4>
                    ${wasteFilterHtml}
                    <span style="color:#666;font-size:0.8em;margin-left:auto;">${wasteFilter ? 'Filtrat: ' + wasteFilter : 'Ultimele 15'}</span>
                </div>
                <div id="modalTransactions" style="max-height:400px;overflow-y:auto;">${transHtml || '<p style="color:#666;">Nu exista tranzactii</p>'}</div>`;
        }

        function filterPartnerTransactions() {
            const filter = document.getElementById('modalWasteFilter').value;
            if (currentPartnerCnp) {
                showPartnerProfile(currentPartnerCnp, filter || null);
            }
        }

        function closeModal() { document.getElementById('partnerModal').classList.remove('active'); currentPartnerCnp = null; currentPartnerData = null; }
        document.getElementById('partnerSearch').addEventListener('keypress', e => { if (e.key === 'Enter') searchPartners(); });
        document.getElementById('partnerModal').addEventListener('click', e => { if (e.target.id === 'partnerModal') closeModal(); });
    </script>
</body>
</html>
