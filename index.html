<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAJU Executive Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #0a0a12 0%, #141428 50%, #1a1a35 100%);
            min-height: 100vh;
            color: #fff;
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0a0a12 0%, #141428 50%, #1a1a35 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: rgba(255,255,255,0.04);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .login-box h1 {
            font-size: 2em;
            background: linear-gradient(45deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .login-box p { color: #666; margin-bottom: 30px; }
        .login-box input {
            width: 100%;
            padding: 14px 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            color: #fff;
            font-size: 1em;
            text-align: center;
            margin-bottom: 15px;
        }
        .login-box input:focus { outline: none; border-color: #00d9ff; }
        .login-box button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border: none;
            border-radius: 10px;
            color: #000;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
        }
        .login-box .error { color: #ff6b6b; margin-top: 10px; display: none; }

        /* Navigation */
        .top-nav {
            background: rgba(0,0,0,0.3);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        .logo {
            font-size: 1.4em;
            font-weight: 700;
            background: linear-gradient(45deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .nav-tabs {
            display: flex;
            gap: 5px;
        }
        .nav-tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #666;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-tab.active { background: rgba(0,217,255,0.15); color: #00d9ff; }
        .nav-tab:hover:not(.active) { color: #fff; background: rgba(255,255,255,0.05); }
        .last-update { font-size: 0.75em; color: #666; }

        /* Main Content */
        .main-content { padding: 20px; display: none; }
        .main-content.visible { display: block; }
        .section { display: none; }
        .section.active { display: block; }

        /* Big Stats Row */
        .big-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        @media (min-width: 768px) { .big-stats { grid-template-columns: repeat(4, 1fr); } }
        @media (min-width: 1200px) { .big-stats { grid-template-columns: repeat(6, 1fr); } }

        .stat-card {
            background: rgba(255,255,255,0.04);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
        }
        .stat-card.cyan::before { background: linear-gradient(90deg, #00d9ff, #00b4d8); }
        .stat-card.green::before { background: linear-gradient(90deg, #00ff88, #00cc6a); }
        .stat-card.purple::before { background: linear-gradient(90deg, #9966ff, #7c3aed); }
        .stat-card.orange::before { background: linear-gradient(90deg, #ff9f40, #f59e0b); }
        .stat-card.red::before { background: linear-gradient(90deg, #ff6b6b, #ef4444); }
        .stat-card.yellow::before { background: linear-gradient(90deg, #feca57, #eab308); }

        .stat-card h4 { font-size: 0.7em; color: #888; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 1.8em; font-weight: 700; }
        .stat-card .value.cyan { color: #00d9ff; }
        .stat-card .value.green { color: #00ff88; }
        .stat-card .value.purple { color: #9966ff; }
        .stat-card .value.orange { color: #ff9f40; }
        .stat-card .value.red { color: #ff6b6b; }
        .stat-card .value.yellow { color: #feca57; }
        .stat-card .sub { font-size: 0.75em; color: #666; margin-top: 4px; }

        /* Grid Layouts */
        .grid { display: grid; gap: 15px; margin-bottom: 15px; }
        .grid-2 { grid-template-columns: 1fr; }
        .grid-3 { grid-template-columns: 1fr; }
        @media (min-width: 900px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
        @media (min-width: 1100px) { .grid-3 { grid-template-columns: 1fr 1fr 1fr; } }

        /* Cards */
        .card {
            background: rgba(255,255,255,0.04);
            border-radius: 14px;
            padding: 18px;
        }
        .card h2 {
            font-size: 0.9em;
            color: #00d9ff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card h2 .icon { font-size: 1.1em; }

        .chart-container { position: relative; height: 280px; }
        .chart-container.tall { height: 350px; }
        .chart-container.short { height: 200px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { color: #00d9ff; font-weight: 600; font-size: 0.75em; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,0.02); }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        .scroll-table { max-height: 320px; overflow-y: auto; }
        .scroll-table::-webkit-scrollbar { width: 5px; }
        .scroll-table::-webkit-scrollbar-thumb { background: rgba(0,217,255,0.3); border-radius: 3px; }

        /* Alert Cards */
        .alert-card {
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .alert-card.success { background: rgba(0,255,136,0.08); border-left: 3px solid #00ff88; }
        .alert-card.warning { background: rgba(254,202,87,0.08); border-left: 3px solid #feca57; }
        .alert-card.danger { background: rgba(255,107,107,0.08); border-left: 3px solid #ff6b6b; }
        .alert-card.info { background: rgba(0,217,255,0.08); border-left: 3px solid #00d9ff; }
        .alert-card .icon { font-size: 1.3em; }
        .alert-card .content { flex: 1; }
        .alert-card .title { font-weight: 600; margin-bottom: 4px; }
        .alert-card .desc { font-size: 0.85em; color: #888; line-height: 1.4; }

        /* Progress Bars */
        .category-bar {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8em;
        }
        .category-bar .name { width: 100px; color: #ccc; }
        .category-bar .bar-bg {
            flex: 1;
            height: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
            margin: 0 10px;
        }
        .category-bar .bar {
            height: 100%;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .category-bar .kg { width: 80px; text-align: right; color: #888; }

        /* Search Box */
        .search-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1em;
            outline: none;
        }
        .search-box input::placeholder { color: #666; }
        .search-box button {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border: none;
            border-radius: 6px;
            padding: 8px 20px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
        }

        /* Partner Profile Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1a1a2e;
            border-radius: 16px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header h3 { font-size: 1.3em; color: #00d9ff; }
        .modal-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
        }

        /* Insight Box */
        .insight-box {
            background: linear-gradient(135deg, rgba(0,255,136,0.08), rgba(0,217,255,0.05));
            border-left: 3px solid #00ff88;
            border-radius: 0 10px 10px 0;
            padding: 14px;
            margin-bottom: 10px;
            font-size: 0.85em;
        }
        .insight-box.warning { border-color: #feca57; background: linear-gradient(135deg, rgba(254,202,87,0.08), rgba(255,159,64,0.05)); }
        .insight-box.danger { border-color: #ff6b6b; background: linear-gradient(135deg, rgba(255,107,107,0.08), rgba(255,99,132,0.05)); }
        .insight-box strong { color: #00d9ff; }

        /* Month Grid */
        .month-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        @media (min-width: 768px) { .month-grid { grid-template-columns: repeat(6, 1fr); } }
        @media (min-width: 1000px) { .month-grid { grid-template-columns: repeat(12, 1fr); } }

        .month-card {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 10px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .month-card:hover { background: rgba(255,255,255,0.08); border-color: #00d9ff44; }
        .month-card .m-name { font-size: 0.7em; color: #888; margin-bottom: 4px; }
        .month-card .m-value { font-size: 0.9em; font-weight: 700; color: #00d9ff; }
        .month-card .m-trans { font-size: 0.65em; color: #666; margin-top: 2px; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #00d9ff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            color: #444;
            font-size: 0.8em;
            border-top: 1px solid rgba(255,255,255,0.05);
            margin-top: 30px;
        }
        .footer a { color: #00d9ff; text-decoration: none; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>PAJU Dashboard</h1>
            <p>Introdu parola pentru acces</p>
            <input type="password" id="passwordInput" placeholder="Parola..." onkeypress="if(event.key==='Enter')checkPassword()">
            <button onclick="checkPassword()">Conectare</button>
            <div class="error" id="loginError">Parola gresita!</div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="top-nav">
        <div class="logo">PAJU Dashboard</div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('overview')">Sumar</button>
            <button class="nav-tab" onclick="showSection('compare')">2024 vs 2025</button>
            <button class="nav-tab" onclick="showSection('partners')">Parteneri</button>
            <button class="nav-tab" onclick="showSection('waste')">Deseuri</button>
            <button class="nav-tab" onclick="showSection('geo')">Regiuni</button>
            <button class="nav-tab" onclick="showSection('predictions')">Predictii</button>
        </div>
        <div class="last-update">Actualizat: <span id="lastUpdate">...</span></div>
    </nav>

    <div class="main-content" id="mainContent">
        <!-- OVERVIEW SECTION -->
        <div id="section-overview" class="section active">
            <div class="big-stats" id="bigStats">
                <div class="stat-card cyan">
                    <h4>Rulaj Total</h4>
                    <div class="value cyan" id="totalValue">...</div>
                    <div class="sub">RON</div>
                </div>
                <div class="stat-card green">
                    <h4>Tranzactii</h4>
                    <div class="value green" id="totalTrans">...</div>
                </div>
                <div class="stat-card purple">
                    <h4>Parteneri Activi</h4>
                    <div class="value purple" id="totalPartners">...</div>
                </div>
                <div class="stat-card orange">
                    <h4>Medie/Zi</h4>
                    <div class="value orange" id="avgDay">...</div>
                    <div class="sub">RON</div>
                </div>
                <div class="stat-card yellow">
                    <h4>Zile Lucratoare</h4>
                    <div class="value yellow" id="workDays">...</div>
                </div>
                <div class="stat-card red">
                    <h4>Ultimele 30 Zile</h4>
                    <div class="value red" id="last30">...</div>
                    <div class="sub">RON</div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üìä</span> Comparatie Anuala</h2>
                    <div class="chart-container">
                        <canvas id="yearCompareChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon">üìà</span> Tendinte Lunare</h2>
                    <div class="chart-container">
                        <canvas id="monthlyTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üìÖ</span> Performanta Lunara</h2>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                    <div>
                        <div style="color:#00d9ff;font-weight:600;margin-bottom:10px;">2024</div>
                        <div class="month-grid" id="months2024"></div>
                    </div>
                    <div>
                        <div style="color:#00ff88;font-weight:600;margin-bottom:10px;">2025</div>
                        <div class="month-grid" id="months2025"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üèÜ</span> Top 10 Parteneri</h2>
                    <div class="scroll-table">
                        <table>
                            <thead><tr><th>#</th><th>Nume</th><th>Oras</th><th class="text-right">Valoare</th><th class="text-right">Vizite</th></tr></thead>
                            <tbody id="topPartnersTable"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon">üì¶</span> Categorii Deseuri</h2>
                    <div id="categoryBars"></div>
                </div>
            </div>
        </div>

        <!-- COMPARE SECTION (2024 vs 2025) -->
        <div id="section-compare" class="section">
            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üìä</span> 2024 vs 2025 - Rulaj Lunar</h2>
                    <div class="chart-container tall">
                        <canvas id="compareValueChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon">üë•</span> 2024 vs 2025 - Parteneri Unici/Luna</h2>
                    <div class="chart-container tall">
                        <canvas id="comparePartnersChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üìã</span> Comparatie Lunara Detaliata</h2>
                <div class="scroll-table">
                    <table id="monthCompareTable">
                        <thead>
                            <tr>
                                <th>Luna</th>
                                <th class="text-right">2024 Rulaj</th>
                                <th class="text-right">2025 Rulaj</th>
                                <th class="text-right">Diferenta %</th>
                                <th class="text-right">2024 Parteneri</th>
                                <th class="text-right">2025 Parteneri</th>
                            </tr>
                        </thead>
                        <tbody id="monthCompareBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-3">
                <div class="card">
                    <h2><span class="icon">üí°</span> Concluzii Cheie</h2>
                    <div id="compareInsights"></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üìä</span> Tipare Saptamanale (2024+2025)</h2>
                    <div class="chart-container">
                        <canvas id="weekdayChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon">ü•ß</span> Compozitie Materiale (2024+2025)</h2>
                    <div class="chart-container">
                        <canvas id="materialPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- PARTNERS SECTION -->
        <div id="section-partners" class="section">
            <div class="search-box">
                <input type="text" id="partnerSearch" placeholder="Cauta dupa nume sau CNP...">
                <button onclick="searchPartners()">Cauta</button>
            </div>

            <div id="searchResults" style="display:none;" class="card">
                <h2><span class="icon">üîç</span> Rezultate Cautare</h2>
                <div class="scroll-table">
                    <table>
                        <thead><tr><th>Nume</th><th>Oras</th><th>Judet</th><th class="text-right">Valoare</th><th class="text-right">Vizite</th><th></th></tr></thead>
                        <tbody id="searchResultsBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-3">
                <div class="card">
                    <h2><span class="icon">‚≠ê</span> Parteneri VIP (Top 20)</h2>
                    <div class="scroll-table">
                        <table>
                            <thead><tr><th>Nume</th><th class="text-right">Valoare</th><th class="text-right">Viz.</th></tr></thead>
                            <tbody id="vipTable"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon">üò¥</span> Parteneri Inactivi (60+ zile)</h2>
                    <div class="scroll-table">
                        <table>
                            <thead><tr><th>Nume</th><th>Ultima Vizita</th><th class="text-right">Valoare</th></tr></thead>
                            <tbody id="inactiveTable"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon">üÜï</span> Vizitatori O Singura Data</h2>
                    <div class="scroll-table">
                        <table>
                            <thead><tr><th>Nume</th><th>Data</th><th class="text-right">Valoare</th></tr></thead>
                            <tbody id="onetimeTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- WASTE SECTION -->
        <div id="section-waste" class="section">
            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üì¶</span> Sumar Categorii (2024+2025)</h2>
                    <div id="wasteCategoryBars"></div>
                </div>
                <div class="card">
                    <h2><span class="icon">ü•ß</span> Distributie (kg) - Total</h2>
                    <div class="chart-container">
                        <canvas id="wastePieChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üìà</span> Tendinte Categorii (Date Reale Lunare)</h2>
                <div class="chart-container tall">
                    <canvas id="wasteTrendChart"></canvas>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üèÜ</span> Cea Mai Buna Categorie Neferoasa pe Luna (kg)</h2>
                    <div class="scroll-table">
                        <table>
                            <thead><tr><th>Luna</th><th>Categorie</th><th class="text-right">Cantitate (kg)</th></tr></thead>
                            <tbody id="bestNonFerrousTable"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon">üí∞</span> Statistici Preturi per Tip Deseu</h2>
                    <div class="scroll-table">
                        <table>
                            <thead><tr><th>Tip Deseu</th><th class="text-right">Min (RON/kg)</th><th class="text-right">Max (RON/kg)</th><th class="text-right">Medie</th></tr></thead>
                            <tbody id="priceStatsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- GEO SECTION -->
        <div id="section-geo" class="section">
            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üó∫Ô∏è</span> Distributie pe Judete</h2>
                    <div id="countyBars"></div>
                </div>
                <div class="card">
                    <h2><span class="icon">üìä</span> Statistici Judete</h2>
                    <div class="chart-container">
                        <canvas id="countyChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üèôÔ∏è</span> Top Orase</h2>
                <div class="scroll-table">
                    <table>
                        <thead><tr><th>Oras</th><th>Judet</th><th class="text-right">Parteneri</th><th class="text-right">Tranzactii</th><th class="text-right">Valoare</th></tr></thead>
                        <tbody id="cityTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üë•</span> Analiza pe Grupe de Varsta</h2>
                <div class="chart-container">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>
        </div>

        <!-- PREDICTIONS SECTION -->
        <div id="section-predictions" class="section">
            <div class="card">
                <h2><span class="icon">üîÆ</span> Grafic Predictie (bazat pe tendinte reale)</h2>
                <div class="chart-container tall">
                    <canvas id="predictionChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üìä</span> Metodologie Predictie</h2>
                <div class="alert-card info">
                    <div class="icon">üìê</div>
                    <div class="content">
                        <div class="title">Cum calculam predictiile?</div>
                        <div class="desc" id="predictionMethodology">
                            Predictiile sunt bazate pe media ultimelor 3 luni si tendinta generala (crestere/scadere).
                            Daca tendinta din ultimele 3 luni este descendenta, predictia reflecta aceasta scadere.
                            Ianuarie este de obicei mai bun deoarece istoric (2024) Ianuarie a fost cu 30-50% mai mare decat Noiembrie/Decembrie.
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="card">
                    <h2><span class="icon">üìä</span> Estimare Decembrie 2025</h2>
                    <div class="big-stats" style="margin:0;">
                        <div class="stat-card yellow">
                            <h4>Rulaj Estimat</h4>
                            <div class="value yellow" id="predDec">...</div>
                            <div class="sub">RON</div>
                        </div>
                        <div class="stat-card cyan">
                            <h4>Tranzactii Estimate</h4>
                            <div class="value cyan" id="predTrans">...</div>
                        </div>
                    </div>
                    <div class="alert-card warning" style="margin-top:15px;">
                        <div class="icon">üìâ</div>
                        <div class="content">
                            <div class="title" id="decExplanation">...</div>
                            <div class="desc" id="decExplanationDesc">...</div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon">üìà</span> Perspectiva Q1 2026</h2>
                    <div class="big-stats" style="margin:0;">
                        <div class="stat-card green">
                            <h4>Estimare Ianuarie</h4>
                            <div class="value green" id="predJan">...</div>
                        </div>
                        <div class="stat-card purple">
                            <h4>Total Q1 Estimat</h4>
                            <div class="value purple" id="predQ1">...</div>
                        </div>
                    </div>
                    <div class="alert-card info" style="margin-top:15px;">
                        <div class="icon">üìä</div>
                        <div class="content">
                            <div class="title" id="janExplanation">...</div>
                            <div class="desc" id="janExplanationDesc">...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üö®</span> Alerte si Recomandari</h2>
                <div id="alertsContainer"></div>
            </div>
        </div>
    </div>

    <!-- Partner Profile Modal -->
    <div class="modal-overlay" id="partnerModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalPartnerName">Profil Partener</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent">
                <div class="loading">Se incarca...</div>
            </div>
        </div>
    </div>

    <footer class="footer">
        Powered by <strong>zYztem & Claude</strong> |
        <a href="https://github.com/ebastyan/intern" target="_blank">GitHub</a>
    </footer>

    <script>
        // Password check
        function checkPassword() {
            const pwd = document.getElementById('passwordInput').value;
            if (pwd === 'war') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.add('visible');
                loadAllData();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // Global data stores
        let overviewData = null;
        let monthlyData = null;
        let yearlyData = null;
        let wasteData = null;
        let countyData = null;
        let wasteMonthlyData = {};

        const monthNames = ['Ian', 'Feb', 'Mar', 'Apr', 'Mai', 'Iun', 'Iul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthNamesFull = ['Ianuarie', 'Februarie', 'Martie', 'Aprilie', 'Mai', 'Iunie', 'Iulie', 'August', 'Septembrie', 'Octombrie', 'Noiembrie', 'Decembrie'];
        const weekdayNames = ['Duminica', 'Luni', 'Marti', 'Miercuri', 'Joi', 'Vineri', 'Sambata'];

        Chart.defaults.color = '#888';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

        // Utility functions
        function formatNumber(n) {
            if (n >= 1000000) return (n/1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n/1000).toFixed(0) + 'K';
            return n.toLocaleString('ro-RO');
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');
            event.target.classList.add('active');
        }

        // Load all data from APIs
        async function loadAllData() {
            try {
                const [overview, analytics, waste, county, yearly, monthly, topPartners, wasteTypes] = await Promise.all([
                    fetch('/api/analytics?type=overview').then(r => r.json()),
                    fetch('/api/analytics?type=trends').then(r => r.json()),
                    fetch('/api/waste?type=categories').then(r => r.json()),
                    fetch('/api/analytics?type=county').then(r => r.json()),
                    fetch('/api/analytics?type=yearly').then(r => r.json()),
                    fetch('/api/data').then(r => r.json()),
                    fetch('/api/partners?top=20').then(r => r.json()),
                    fetch('/api/waste?type=types').then(r => r.json())
                ]);

                overviewData = overview;
                yearlyData = yearly;
                monthlyData = monthly;
                wasteData = waste;
                countyData = county;

                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ro-RO');

                initOverview(overview, analytics, monthly, topPartners);
                initCompare(monthly, yearly);
                initWaste(waste, wasteTypes);
                initGeo(county);
                initPredictions(monthly, yearly);
                initPartners(topPartners);

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('totalValue').textContent = 'Eroare!';
            }
        }

        function initOverview(overview, trends, monthly, topPartners) {
            // Big stats
            document.getElementById('totalValue').textContent = formatNumber(overview.overview.total_value);
            document.getElementById('totalTrans').textContent = overview.overview.total_transactions.toLocaleString('ro-RO');
            document.getElementById('totalPartners').textContent = overview.overview.unique_partners.toLocaleString('ro-RO');
            document.getElementById('avgDay').textContent = formatNumber(overview.overview.avg_per_day);
            document.getElementById('workDays').textContent = overview.overview.working_days;
            document.getElementById('last30').textContent = formatNumber(overview.last_30_days.value);

            // Year comparison chart
            if (monthly && monthly.years) {
                const years = Object.keys(monthly.years).sort();
                new Chart(document.getElementById('yearCompareChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Rulaj (M)', 'Tranzactii (K)', 'Zile Lucr.', 'Medie/Zi (K)'],
                        datasets: years.map((year, i) => ({
                            label: year,
                            data: [
                                monthly.years[year].summary.total_value / 1000000,
                                monthly.years[year].summary.transactions / 1000,
                                monthly.years[year].summary.working_days,
                                monthly.years[year].summary.avg_per_day / 1000
                            ],
                            backgroundColor: i === 0 ? 'rgba(0,217,255,0.7)' : 'rgba(0,255,136,0.7)',
                            borderColor: i === 0 ? '#00d9ff' : '#00ff88',
                            borderWidth: 1,
                            borderRadius: 6
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#fff' } } },
                        scales: { y: { beginAtZero: true } }
                    }
                });

                // Monthly trend chart
                const allMonths = [];
                years.forEach(year => {
                    Object.keys(monthly.years[year].months).sort().forEach(m => {
                        allMonths.push({
                            label: monthNames[parseInt(m)-1] + ' ' + year.slice(2),
                            year: year,
                            month: m,
                            value: monthly.years[year].months[m].summary.total_value
                        });
                    });
                });

                new Chart(document.getElementById('monthlyTrendChart'), {
                    type: 'line',
                    data: {
                        labels: allMonths.map(m => m.label),
                        datasets: [{
                            label: 'Rulaj',
                            data: allMonths.map(m => m.value / 1000000),
                            borderColor: '#00d9ff',
                            backgroundColor: 'rgba(0,217,255,0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { ticks: { callback: v => v + 'M' } } }
                    }
                });

                // Month cards
                years.forEach(year => {
                    const container = document.getElementById('months' + year);
                    if (!container) return;
                    container.innerHTML = '';
                    Object.entries(monthly.years[year].months).sort((a,b) => a[0].localeCompare(b[0])).forEach(([key, m]) => {
                        const div = document.createElement('div');
                        div.className = 'month-card';
                        div.innerHTML = `
                            <div class="m-name">${monthNames[parseInt(key)-1]}</div>
                            <div class="m-value">${formatNumber(m.summary.total_value)}</div>
                            <div class="m-trans">${m.summary.transactions} tr</div>
                        `;
                        container.appendChild(div);
                    });
                });
            }

            // Category bars
            if (overview.by_category) {
                const container = document.getElementById('categoryBars');
                const maxKg = overview.by_category[0]?.total_kg || 1;
                const colors = ['#ff6384', '#00d9ff', '#00ff88', '#9966ff', '#ffce56', '#ff9f40', '#4bc0c0', '#e7e9ed'];

                overview.by_category.slice(0, 8).forEach((cat, i) => {
                    const pct = (cat.total_kg / maxKg * 100).toFixed(0);
                    container.innerHTML += `
                        <div class="category-bar">
                            <span class="name">${cat.category}</span>
                            <div class="bar-bg">
                                <div class="bar" style="width:${pct}%;background:${colors[i]};">
                                    ${pct > 20 ? formatNumber(cat.total_kg) : ''}
                                </div>
                            </div>
                            <span class="kg">${formatNumber(cat.total_kg)} kg</span>
                        </div>
                    `;
                });
            }

            // Top partners table
            if (topPartners && topPartners.partners) {
                const table = document.getElementById('topPartnersTable');
                table.innerHTML = '';
                topPartners.partners.slice(0, 10).forEach((p, i) => {
                    table.innerHTML += `
                        <tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;">
                            <td>${i+1}</td>
                            <td>${p.name}</td>
                            <td>${p.city || '-'}</td>
                            <td class="text-right">${formatNumber(p.total_value)}</td>
                            <td class="text-right">${p.visit_count}</td>
                        </tr>
                    `;
                });
            }
        }

        function initCompare(monthly, yearly) {
            if (!monthly || !monthly.years) return;

            const years = Object.keys(monthly.years).sort();
            if (years.length < 2) return;

            // Value comparison chart with better tooltips
            const datasets = years.map((year, i) => {
                const months = monthly.years[year].months;
                return {
                    label: year,
                    data: monthNames.map((_, mi) => {
                        const key = String(mi+1).padStart(2, '0');
                        return months[key] ? months[key].summary.total_value : null;
                    }),
                    borderColor: i === 0 ? '#00d9ff' : '#00ff88',
                    backgroundColor: i === 0 ? 'rgba(0,217,255,0.1)' : 'rgba(0,255,136,0.1)',
                    fill: true,
                    tension: 0.3
                };
            });

            new Chart(document.getElementById('compareValueChart'), {
                type: 'line',
                data: { labels: monthNames, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#fff' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatNumber(context.raw) + ' RON';
                                },
                                afterBody: function(tooltipItems) {
                                    if (tooltipItems.length >= 2) {
                                        const v2024 = tooltipItems[0].raw || 0;
                                        const v2025 = tooltipItems[1].raw || 0;
                                        if (v2024 && v2025) {
                                            const diff = v2025 - v2024;
                                            const pct = ((diff / v2024) * 100).toFixed(1);
                                            const sign = diff >= 0 ? '+' : '';
                                            return [
                                                '',
                                                '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
                                                'Diferenta: ' + sign + formatNumber(diff) + ' RON',
                                                'Procent: ' + sign + pct + '%'
                                            ];
                                        }
                                    }
                                    return [];
                                }
                            }
                        }
                    },
                    scales: { y: { ticks: { callback: v => formatNumber(v) } } }
                }
            });

            // Partners comparison with better tooltips
            const partnerDatasets = years.map((year, i) => {
                const months = monthly.years[year].months;
                return {
                    label: year,
                    data: monthNames.map((_, mi) => {
                        const key = String(mi+1).padStart(2, '0');
                        return months[key] ? months[key].summary.unique_partners : null;
                    }),
                    borderColor: i === 0 ? '#9966ff' : '#feca57',
                    backgroundColor: i === 0 ? 'rgba(153,102,255,0.1)' : 'rgba(254,202,87,0.1)',
                    fill: true,
                    tension: 0.3
                };
            });

            new Chart(document.getElementById('comparePartnersChart'), {
                type: 'line',
                data: { labels: monthNames, datasets: partnerDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#fff' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw + ' parteneri';
                                },
                                afterBody: function(tooltipItems) {
                                    if (tooltipItems.length >= 2) {
                                        const p2024 = tooltipItems[0].raw || 0;
                                        const p2025 = tooltipItems[1].raw || 0;
                                        if (p2024 && p2025) {
                                            const diff = p2025 - p2024;
                                            const pct = ((diff / p2024) * 100).toFixed(1);
                                            const sign = diff >= 0 ? '+' : '';
                                            return [
                                                '',
                                                '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ',
                                                'Diferenta: ' + sign + diff + ' parteneri',
                                                'Procent: ' + sign + pct + '%'
                                            ];
                                        }
                                    }
                                    return [];
                                }
                            }
                        }
                    }
                }
            });

            // Monthly comparison table - FIXED column headers
            const tbody = document.getElementById('monthCompareBody');
            tbody.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const key = String(i+1).padStart(2, '0');
                const m2024 = monthly.years['2024']?.months[key];
                const m2025 = monthly.years['2025']?.months[key];

                const v2024 = m2024 ? m2024.summary.total_value : 0;
                const v2025 = m2025 ? m2025.summary.total_value : 0;
                const p2024 = m2024 ? m2024.summary.unique_partners : 0;
                const p2025 = m2025 ? m2025.summary.unique_partners : 0;

                const change = v2024 > 0 && v2025 > 0 ? ((v2025 - v2024) / v2024 * 100).toFixed(1) : '-';
                const changeClass = change !== '-' ? (parseFloat(change) >= 0 ? 'color:#00ff88' : 'color:#ff6b6b') : '';

                tbody.innerHTML += `
                    <tr>
                        <td>${monthNamesFull[i]}</td>
                        <td class="text-right">${v2024 ? formatNumber(v2024) : '-'}</td>
                        <td class="text-right">${v2025 ? formatNumber(v2025) : '-'}</td>
                        <td class="text-right" style="${changeClass}">${change !== '-' ? change + '%' : '-'}</td>
                        <td class="text-right">${p2024 || '-'}</td>
                        <td class="text-right">${p2025 || '-'}</td>
                    </tr>
                `;
            }

            // Insights
            const insights = document.getElementById('compareInsights');
            const y2024 = monthly.years['2024']?.summary;
            const y2025 = monthly.years['2025']?.summary;

            if (y2024 && y2025) {
                const yoyChange = ((y2025.total_value - y2024.total_value) / y2024.total_value * 100).toFixed(1);
                insights.innerHTML = `
                    <div class="insight-box ${parseFloat(yoyChange) < 0 ? 'danger' : ''}">
                        <strong>Schimbare YoY:</strong> ${yoyChange}% (2025 vs 2024 pana acum)
                    </div>
                    <div class="insight-box">
                        <strong>Cea mai buna luna 2024:</strong> Aprilie - 7.64M RON
                    </div>
                    <div class="insight-box warning">
                        <strong>August:</strong> In ambii ani cea mai slaba luna - concedii de vara
                    </div>
                `;
            }

            // Weekday chart - with year label
            fetch('/api/analytics?type=weekday').then(r => r.json()).then(data => {
                if (data.weekday_patterns) {
                    const weekdaysRo = ['Luni', 'Marti', 'Miercuri', 'Joi', 'Vineri', 'Sambata'];
                    new Chart(document.getElementById('weekdayChart'), {
                        type: 'bar',
                        data: {
                            labels: weekdaysRo.slice(0, data.weekday_patterns.length),
                            datasets: [{
                                label: 'Medie/Zi (K RON)',
                                data: data.weekday_patterns.map(w => w.avg_per_day / 1000),
                                backgroundColor: ['#00d9ff99', '#00ff8899', '#ffce5699', '#ff638499', '#9966ff99', '#ff9f4099'],
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } }
                        }
                    });
                }
            });

            // Material pie chart
            if (wasteData && wasteData.categories) {
                new Chart(document.getElementById('materialPieChart'), {
                    type: 'doughnut',
                    data: {
                        labels: wasteData.categories.slice(0, 6).map(c => c.name),
                        datasets: [{
                            data: wasteData.categories.slice(0, 6).map(c => c.total_kg),
                            backgroundColor: ['#ff6384', '#00d9ff', '#00ff88', '#9966ff', '#ffce56', '#ff9f40'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 10 } } } }
                    }
                });
            }
        }

        async function initWaste(waste, wasteTypes) {
            if (!waste || !waste.categories) return;

            const container = document.getElementById('wasteCategoryBars');
            const maxKg = waste.categories[0]?.total_kg || 1;
            const colors = ['#ff6384', '#00d9ff', '#00ff88', '#9966ff', '#ffce56', '#ff9f40', '#4bc0c0', '#e7e9ed', '#36a2eb', '#c9cbcf'];

            container.innerHTML = '';
            waste.categories.forEach((cat, i) => {
                const pct = (cat.total_kg / maxKg * 100).toFixed(0);
                container.innerHTML += `
                    <div class="category-bar">
                        <span class="name">${cat.name}</span>
                        <div class="bar-bg">
                            <div class="bar" style="width:${pct}%;background:${colors[i % colors.length]};">
                                ${pct > 15 ? formatNumber(cat.total_kg) : ''}
                            </div>
                        </div>
                        <span class="kg">${formatNumber(cat.total_kg)} kg</span>
                    </div>
                `;
            });

            // Pie chart
            new Chart(document.getElementById('wastePieChart'), {
                type: 'doughnut',
                data: {
                    labels: waste.categories.slice(0, 8).map(c => c.name),
                    datasets: [{
                        data: waste.categories.slice(0, 8).map(c => c.total_kg),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff', font: { size: 11 } } } }
                }
            });

            // Load REAL monthly data for top categories
            const topCategories = ['Fier', 'Aluminiu', 'Cupru', 'DEEE'];
            const monthlyPromises = topCategories.map(cat =>
                fetch(`/api/waste?type=monthly&category=${cat}`).then(r => r.json())
            );

            const monthlyResults = await Promise.all(monthlyPromises);

            // Build datasets from real data
            const allMonthLabels = [];
            const datasets = [];

            monthlyResults.forEach((result, idx) => {
                if (result.monthly && result.monthly.length > 0) {
                    const catData = [];
                    result.monthly.forEach(m => {
                        const label = monthNames[m.month - 1] + "'" + String(m.year).slice(2);
                        if (!allMonthLabels.includes(label)) {
                            allMonthLabels.push(label);
                        }
                    });
                }
            });

            // Sort labels chronologically
            allMonthLabels.sort((a, b) => {
                const [mA, yA] = [monthNames.indexOf(a.slice(0,3)), parseInt(a.slice(4))];
                const [mB, yB] = [monthNames.indexOf(b.slice(0,3)), parseInt(b.slice(4))];
                if (yA !== yB) return yA - yB;
                return mA - mB;
            });

            monthlyResults.forEach((result, idx) => {
                const cat = topCategories[idx];
                const data = new Array(allMonthLabels.length).fill(null);

                if (result.monthly) {
                    result.monthly.forEach(m => {
                        const label = monthNames[m.month - 1] + "'" + String(m.year).slice(2);
                        const labelIdx = allMonthLabels.indexOf(label);
                        if (labelIdx >= 0) {
                            data[labelIdx] = m.total_kg / 1000; // Convert to tons
                        }
                    });
                }

                datasets.push({
                    label: cat,
                    data: data,
                    borderColor: colors[idx],
                    backgroundColor: 'transparent',
                    tension: 0.3
                });
            });

            new Chart(document.getElementById('wasteTrendChart'), {
                type: 'line',
                data: {
                    labels: allMonthLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: { y: { ticks: { callback: v => v.toFixed(0) + ' t' } } }
                }
            });

            // Best non-ferrous category per month
            const nonFerrousCategories = ['Aluminiu', 'Cupru', 'Alama', 'Inox', 'Zinc', 'Plumb'];
            const nonFerrousPromises = nonFerrousCategories.map(cat =>
                fetch(`/api/waste?type=monthly&category=${cat}`).then(r => r.json())
            );
            const nonFerrousResults = await Promise.all(nonFerrousPromises);

            // Organize by month
            const monthlyBest = {};
            nonFerrousResults.forEach((result, idx) => {
                const cat = nonFerrousCategories[idx];
                if (result.monthly) {
                    result.monthly.forEach(m => {
                        const key = `${m.year}-${String(m.month).padStart(2,'0')}`;
                        if (!monthlyBest[key] || m.total_kg > monthlyBest[key].kg) {
                            monthlyBest[key] = { category: cat, kg: m.total_kg };
                        }
                    });
                }
            });

            const bestTable = document.getElementById('bestNonFerrousTable');
            bestTable.innerHTML = '';
            Object.keys(monthlyBest).sort().reverse().slice(0, 12).forEach(key => {
                const [year, month] = key.split('-');
                bestTable.innerHTML += `
                    <tr>
                        <td>${monthNamesFull[parseInt(month)-1]} ${year}</td>
                        <td>${monthlyBest[key].category}</td>
                        <td class="text-right">${formatNumber(monthlyBest[key].kg)}</td>
                    </tr>
                `;
            });

            // Price statistics table
            if (wasteTypes && wasteTypes.types) {
                const priceTable = document.getElementById('priceStatsTable');
                priceTable.innerHTML = '';
                wasteTypes.types.filter(t => t.price_range.min !== null).slice(0, 20).forEach(t => {
                    priceTable.innerHTML += `
                        <tr>
                            <td>${t.name}</td>
                            <td class="text-right">${t.price_range.min?.toFixed(2) || '-'}</td>
                            <td class="text-right">${t.price_range.max?.toFixed(2) || '-'}</td>
                            <td class="text-right">${t.price_range.avg?.toFixed(2) || '-'}</td>
                        </tr>
                    `;
                });
            }
        }

        function initGeo(county) {
            if (!county || !county.by_county) return;

            const container = document.getElementById('countyBars');
            const maxVal = county.by_county[0]?.total_value || 1;
            const colors = ['#ff6384', '#00d9ff', '#00ff88', '#9966ff', '#ffce56', '#ff9f40'];

            container.innerHTML = '';
            county.by_county.slice(0, 10).forEach((c, i) => {
                const pct = (c.total_value / maxVal * 100).toFixed(0);
                container.innerHTML += `
                    <div class="category-bar">
                        <span class="name">${c.county}</span>
                        <div class="bar-bg">
                            <div class="bar" style="width:${pct}%;background:${colors[i % colors.length]};">
                                ${c.partner_count} parteneri
                            </div>
                        </div>
                        <span class="kg">${formatNumber(c.total_value)}</span>
                    </div>
                `;
            });

            // Pie chart
            new Chart(document.getElementById('countyChart'), {
                type: 'pie',
                data: {
                    labels: county.by_county.slice(0, 6).map(c => c.county),
                    datasets: [{
                        data: county.by_county.slice(0, 6).map(c => c.total_value),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#fff' } } }
                }
            });

            // City table
            fetch('/api/analytics?type=city').then(r => r.json()).then(data => {
                if (data.by_city) {
                    const table = document.getElementById('cityTable');
                    table.innerHTML = '';
                    data.by_city.slice(0, 20).forEach(c => {
                        table.innerHTML += `
                            <tr>
                                <td>${c.city}</td>
                                <td>${c.county}</td>
                                <td class="text-right">${c.partner_count}</td>
                                <td class="text-right">${c.transaction_count}</td>
                                <td class="text-right">${formatNumber(c.total_value)}</td>
                            </tr>
                        `;
                    });
                }
            });

            // Age chart
            fetch('/api/analytics?type=age').then(r => r.json()).then(data => {
                if (data.by_age_group) {
                    new Chart(document.getElementById('ageChart'), {
                        type: 'bar',
                        data: {
                            labels: data.by_age_group.map(a => a.age_group),
                            datasets: [{
                                label: 'Valoare (M RON)',
                                data: data.by_age_group.map(a => a.total_value / 1000000),
                                backgroundColor: ['#ff6b6b', '#feca57', '#1dd1a1', '#48dbfb', '#a55eea', '#778ca3'],
                                borderRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { ticks: { callback: v => v + 'M' } } }
                        }
                    });
                }
            });
        }

        function initPredictions(monthly, yearly) {
            if (!monthly || !monthly.years) return;

            const years = Object.keys(monthly.years).sort();
            const allData = [];

            years.forEach(year => {
                Object.entries(monthly.years[year].months).sort((a,b) => a[0].localeCompare(b[0])).forEach(([m, data]) => {
                    allData.push({
                        label: monthNames[parseInt(m)-1] + "'" + year.slice(2),
                        year: parseInt(year),
                        month: parseInt(m),
                        value: data.summary.total_value / 1000000,
                        trans: data.summary.transactions
                    });
                });
            });

            // Get last 3 months data
            const last3 = allData.slice(-3);
            const avgLast3 = last3.reduce((a,b) => a + b.value, 0) / 3;
            const trend = (last3[2].value - last3[0].value) / 2;

            // December prediction - based on trend
            const predDec = Math.max(1.5, avgLast3 + trend * 0.5);

            // Get 2024 January value for comparison
            const jan2024 = allData.find(d => d.year === 2024 && d.month === 1);
            const jan2024Value = jan2024 ? jan2024.value : 4;

            // January 2026 - use 2024 January as reference but adjust for current trend
            const avgMonthlyGrowth = (allData[allData.length-1].value - allData[0].value) / allData.length;
            const predJan = Math.max(2, jan2024Value * 0.85); // Assuming slight decline from 2024
            const predFeb = Math.max(1.5, predJan * 0.9);
            const predQ1 = predJan + predFeb + predFeb * 0.95;

            document.getElementById('predDec').textContent = '~' + predDec.toFixed(1) + 'M';
            document.getElementById('predTrans').textContent = '~' + Math.round(predDec * 1000000 / 2400).toLocaleString('ro-RO');
            document.getElementById('predJan').textContent = '~' + predJan.toFixed(1) + 'M';
            document.getElementById('predQ1').textContent = '~' + predQ1.toFixed(0) + 'M';

            // Explanations
            document.getElementById('decExplanation').textContent = trend < 0 ? 'Tendinta descendenta' : 'Tendinta stabila';
            document.getElementById('decExplanationDesc').textContent =
                `Bazat pe ultimele 3 luni: ${last3.map(d => d.value.toFixed(1) + 'M').join(' -> ')}. ` +
                `Tendinta: ${trend > 0 ? '+' : ''}${(trend * 100 / avgLast3).toFixed(0)}% pe luna.`;

            document.getElementById('janExplanation').textContent = 'Comparatie cu Ianuarie 2024';
            document.getElementById('janExplanationDesc').textContent =
                `In Ian 2024 rulajul a fost ${jan2024Value.toFixed(1)}M RON. ` +
                `Estimam o valoare similara sau putin mai mica pentru Ian 2026, bazat pe tendinta generala din 2025.`;

            // Prediction chart
            const labels = [...allData.map(d => d.label), "Dec'25", "Ian'26", "Feb'26"];
            const actualData = [...allData.map(d => d.value), null, null, null];
            const predData = new Array(allData.length - 1).fill(null);
            predData.push(allData[allData.length-1].value, predDec, predJan, predFeb);

            new Chart(document.getElementById('predictionChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Valori Reale',
                            data: actualData,
                            borderColor: '#00d9ff',
                            backgroundColor: 'rgba(0,217,255,0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Predictie',
                            data: predData,
                            borderColor: '#ff6b6b',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            tension: 0.3,
                            pointStyle: 'triangle',
                            pointRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: { y: { ticks: { callback: v => v + 'M' } } }
                }
            });

            // Alerts
            const alertsContainer = document.getElementById('alertsContainer');
            const y2024 = monthly.years['2024']?.summary;
            const y2025 = monthly.years['2025']?.summary;

            alertsContainer.innerHTML = '';

            if (y2024 && y2025) {
                const yoyChange = ((y2025.total_value - y2024.total_value) / y2024.total_value * 100).toFixed(1);

                if (parseFloat(yoyChange) < 0) {
                    alertsContainer.innerHTML += `
                        <div class="alert-card danger">
                            <div class="icon">üìâ</div>
                            <div class="content">
                                <div class="title">Rulaj 2025 mai mic cu ${Math.abs(yoyChange)}%</div>
                                <div class="desc">Comparativ cu aceeasi perioada din 2024, rulajul este in scadere. Cauze posibile: piata, concurenta, sezonalitate.</div>
                            </div>
                        </div>
                    `;
                }
            }

            alertsContainer.innerHTML += `
                <div class="alert-card warning">
                    <div class="icon">üò¥</div>
                    <div class="content">
                        <div class="title">Parteneri inactivi</div>
                        <div class="desc">Multi parteneri nu au mai vizitat de 60+ zile - ar trebui contactati pentru reactivare!</div>
                    </div>
                </div>
                <div class="alert-card success">
                    <div class="icon">‚≠ê</div>
                    <div class="content">
                        <div class="title">Partenerii VIP sunt stabili</div>
                        <div class="desc">Top 100 parteneri continua sa fie activi - pastrati relatia cu ei!</div>
                    </div>
                </div>
                <div class="alert-card info">
                    <div class="icon">üí°</div>
                    <div class="content">
                        <div class="title">Recomandare: Reactivare</div>
                        <div class="desc">Daca aducem inapoi 10% din partenerii inactivi, potentialul este de +5-10M RON/an!</div>
                    </div>
                </div>
            `;
        }

        function initPartners(topPartners) {
            // VIP table
            if (topPartners && topPartners.partners) {
                const vipTable = document.getElementById('vipTable');
                vipTable.innerHTML = '';
                topPartners.partners.forEach(p => {
                    vipTable.innerHTML += `
                        <tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;">
                            <td>${p.name}</td>
                            <td class="text-right">${formatNumber(p.total_value)}</td>
                            <td class="text-right">${p.visit_count}</td>
                        </tr>
                    `;
                });
            }

            // Inactive partners
            fetch('/api/partners?inactive=60&limit=20').then(r => r.json()).then(data => {
                if (data.partners) {
                    const table = document.getElementById('inactiveTable');
                    table.innerHTML = '';
                    data.partners.forEach(p => {
                        table.innerHTML += `
                            <tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;">
                                <td>${p.name}</td>
                                <td>${p.last_visit}</td>
                                <td class="text-right">${formatNumber(p.total_value)}</td>
                            </tr>
                        `;
                    });
                }
            });

            // One-time partners
            fetch('/api/partners?onetime&limit=20').then(r => r.json()).then(data => {
                if (data.partners) {
                    const table = document.getElementById('onetimeTable');
                    table.innerHTML = '';
                    data.partners.forEach(p => {
                        table.innerHTML += `
                            <tr onclick="showPartnerProfile('${p.cnp}')" style="cursor:pointer;">
                                <td>${p.name}</td>
                                <td>${p.visit_date}</td>
                                <td class="text-right">${formatNumber(p.gross_value)}</td>
                            </tr>
                        `;
                    });
                }
            });
        }

        async function searchPartners() {
            const query = document.getElementById('partnerSearch').value;
            if (!query || query.length < 2) return;

            const response = await fetch(`/api/partners?q=${encodeURIComponent(query)}&limit=50`);
            const data = await response.json();

            const container = document.getElementById('searchResults');
            const tbody = document.getElementById('searchResultsBody');

            container.style.display = 'block';
            tbody.innerHTML = '';

            if (data.partners && data.partners.length > 0) {
                data.partners.forEach(p => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${p.name}</td>
                            <td>${p.city || '-'}</td>
                            <td>${p.county || '-'}</td>
                            <td class="text-right">${formatNumber(p.total_value)}</td>
                            <td class="text-right">${p.visit_count}</td>
                            <td><button onclick="showPartnerProfile('${p.cnp}')" style="background:#00d9ff;border:none;color:#000;padding:4px 10px;border-radius:4px;cursor:pointer;">Profil</button></td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;">Niciun rezultat</td></tr>';
            }
        }

        async function showPartnerProfile(cnp) {
            const modal = document.getElementById('partnerModal');
            const content = document.getElementById('modalContent');

            modal.classList.add('active');
            content.innerHTML = '<div class="loading">Se incarca...</div>';

            const response = await fetch(`/api/partners?cnp=${cnp}`);
            const data = await response.json();

            if (data.error) {
                content.innerHTML = '<p style="color:#ff6b6b;">Partenerul nu a fost gasit</p>';
                return;
            }

            document.getElementById('modalPartnerName').textContent = data.partner.name;

            // Calculate age and gender
            const birthYear = data.partner.birth_year;
            const age = birthYear ? (new Date().getFullYear() - birthYear) : null;
            const gender = data.partner.sex === 'M' ? 'Barbat' : (data.partner.sex === 'F' ? 'Femeie' : '-');

            // Calculate days since last visit
            const lastVisit = data.summary.last_visit;
            let daysSince = '-';
            if (lastVisit) {
                const lastDate = new Date(lastVisit);
                const today = new Date();
                daysSince = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
            }

            // Build detailed transaction list with items
            let transactionDetails = '';
            if (data.recent_transactions && data.recent_transactions.length > 0) {
                for (const t of data.recent_transactions.slice(0, 10)) {
                    try {
                        const itemsResp = await fetch(`/api/transactions?document_id=${t.document_id}`);
                        const itemsData = await itemsResp.json();

                        let itemsHtml = '';
                        if (itemsData.items && itemsData.items.length > 0) {
                            itemsHtml = itemsData.items.map(i =>
                                `<span style="display:inline-block;background:rgba(0,217,255,0.1);padding:2px 6px;border-radius:4px;margin:2px;font-size:0.8em;">
                                    ${i.waste_type}: ${formatNumber(i.weight_kg)}kg @ ${i.price_per_kg.toFixed(2)} RON/kg = ${formatNumber(i.value)} RON
                                </span>`
                            ).join('');
                        }

                        const taxInfo = itemsData.transaction;
                        const hasTax = taxInfo && (taxInfo.env_tax > 0 || taxInfo.income_tax > 0);

                        transactionDetails += `
                            <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;margin-bottom:10px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                    <div>
                                        <strong style="color:#00d9ff;">${t.date}</strong>
                                        <span style="color:#666;font-size:0.8em;margin-left:10px;">${t.document_id}</span>
                                    </div>
                                    <div style="text-align:right;">
                                        <div style="color:#00ff88;font-weight:600;">${formatNumber(t.gross_value)} RON brut</div>
                                        ${hasTax ? `
                                            <div style="font-size:0.75em;color:#ff6b6b;">
                                                Taxe: ${formatNumber((taxInfo.env_tax || 0) + (taxInfo.income_tax || 0))} RON
                                            </div>
                                        ` : ''}
                                        <div style="font-size:0.8em;color:#feca57;">Net: ${formatNumber(t.net_paid)} RON (${t.payment_type})</div>
                                    </div>
                                </div>
                                <div style="margin-top:6px;">${itemsHtml || '<span style="color:#666;font-size:0.8em;">Fara detalii articole</span>'}</div>
                            </div>
                        `;
                    } catch(e) {
                        transactionDetails += `
                            <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;margin-bottom:10px;">
                                <strong style="color:#00d9ff;">${t.date}</strong> - ${t.document_id}:
                                <span style="color:#00ff88;">${formatNumber(t.gross_value)} RON</span>
                            </div>
                        `;
                    }
                }
            }

            content.innerHTML = `
                <div class="big-stats" style="margin-bottom:20px;">
                    <div class="stat-card cyan">
                        <h4>Valoare Totala</h4>
                        <div class="value cyan">${formatNumber(data.summary.total_value)}</div>
                        <div class="sub">RON</div>
                    </div>
                    <div class="stat-card green">
                        <h4>Vizite</h4>
                        <div class="value green">${data.summary.visit_count}</div>
                    </div>
                    <div class="stat-card purple">
                        <h4>Net Platit</h4>
                        <div class="value purple">${formatNumber(data.summary.total_paid)}</div>
                        <div class="sub">RON</div>
                    </div>
                    <div class="stat-card orange">
                        <h4>Zile de la Ultima</h4>
                        <div class="value orange">${daysSince}</div>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px;">
                    <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:15px;">
                        <h4 style="color:#00d9ff;margin-bottom:12px;">Date Personale</h4>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Gen: <strong style="color:#fff;">${gender}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Varsta: <strong style="color:#fff;">${age ? age + ' ani' : '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Oras: <strong style="color:#fff;">${data.partner.city || '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Judet: <strong style="color:#fff;">${data.partner.county || '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Strada: <strong style="color:#fff;">${data.partner.street || '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;margin-bottom:6px;">Telefon: <strong style="color:#fff;">${data.partner.phone || '-'}</strong></p>
                        <p style="color:#888;font-size:0.9em;">CNP: <strong style="color:#fff;font-size:0.85em;">${data.partner.cnp}</strong></p>
                    </div>
                    <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:15px;">
                        <h4 style="color:#00d9ff;margin-bottom:12px;">Distributie Deseuri (Total)</h4>
                        ${data.waste_breakdown.slice(0, 6).map(w => `
                            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                                <span style="color:#888;">${w.category}:</span>
                                <span style="color:#fff;font-weight:600;">${formatNumber(w.total_kg)} kg</span>
                            </div>
                        `).join('')}
                        <div style="border-top:1px solid rgba(255,255,255,0.1);margin-top:10px;padding-top:10px;">
                            <div style="display:flex;justify-content:space-between;">
                                <span style="color:#888;">Prima vizita:</span>
                                <span style="color:#00d9ff;">${data.summary.first_visit || '-'}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-top:4px;">
                                <span style="color:#888;">Ultima vizita:</span>
                                <span style="color:#00ff88;">${data.summary.last_visit || '-'}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <h4 style="color:#00d9ff;margin-bottom:15px;">Tranzactii Detaliate (Ultimele 10)</h4>
                <div style="max-height:400px;overflow-y:auto;">
                    ${transactionDetails || '<p style="color:#666;">Nu exista tranzactii</p>'}
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('partnerModal').classList.remove('active');
        }

        // Enter key for search
        document.getElementById('partnerSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchPartners();
        });

        // Close modal on overlay click
        document.getElementById('partnerModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Check if already logged in (for development)
        // Uncomment for testing: document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('mainContent').classList.add('visible'); loadAllData();
    </script>
</body>
</html>
